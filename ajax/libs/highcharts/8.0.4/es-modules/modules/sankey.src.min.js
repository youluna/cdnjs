"use strict";import H from"../parts/Globals.js";import Color from"../parts/Color.js";import Point from"../parts/Point.js";import U from"../parts/Utilities.js";var defined=U.defined,find=U.find,isObject=U.isObject,merge=U.merge,pick=U.pick,relativeLength=U.relativeLength,seriesType=U.seriesType,stableSort=U.stableSort;import"../parts/Options.js";import"../mixins/nodes.js";import mixinTreeSeries from"../mixins/tree-series.js";var getLevelOptions=mixinTreeSeries.getLevelOptions,getDLOptions=function(t){var o=isObject(t.optionsPoint)?t.optionsPoint.dataLabels:{},e=isObject(t.level)?t.level.dataLabels:{};return merge({style:{}},e,o)};seriesType("sankey","column",{borderWidth:0,colorByPoint:!0,curveFactor:.33,dataLabels:{enabled:!0,backgroundColor:"none",crop:!1,nodeFormat:void 0,nodeFormatter:function(){return this.point.name},format:void 0,formatter:function(){},inside:!0},inactiveOtherPoints:!0,linkOpacity:.5,minLinkWidth:0,nodeWidth:20,nodePadding:10,showInLegend:!1,states:{hover:{linkOpacity:1},inactive:{linkOpacity:.1,opacity:.1,animation:{duration:50}}},tooltip:{followPointer:!0,headerFormat:'<span style="font-size: 10px">{series.name}</span><br/>',pointFormat:"{point.fromNode.name} â†’ {point.toNode.name}: <b>{point.weight}</b><br/>",nodeFormat:"{point.name}: <b>{point.sum}</b><br/>"}},{isCartesian:!1,invertable:!0,forceDL:!0,orderNodes:!0,pointArrayMap:["from","to"],createNode:H.NodesMixin.createNode,searchPoint:H.noop,setData:H.NodesMixin.setData,destroy:H.NodesMixin.destroy,getNodePadding:function(){var t=this.options.nodePadding||0;if(this.nodeColumns){var o=this.nodeColumns.reduce(function(t,o){return Math.max(t,o.length)},0);o*t>this.chart.plotSizeY&&(t=this.chart.plotSizeY/o)}return t},createNodeColumn:function(){var t=this,o=this.chart,e=[];return e.sum=function(){return this.reduce(function(t,o){return t+o.getSum()},0)},e.offset=function(o,i){for(var n,s=0,r=t.nodePadding,a=0;a<e.length;a++){var l=e[a].getSum(),h=Math.max(l*i,t.options.minLinkWidth);if(n=l?h+r:0,e[a]===o)return{relativeTop:s+relativeLength(o.options.offset||0,n)};s+=n}},e.top=function(e){var i=t.nodePadding,n=this.reduce(function(o,n){return o>0&&(o+=i),o+=Math.max(n.getSum()*e,t.options.minLinkWidth)},0);return(o.plotSizeY-n)/2},e},createNodeColumns:function(){var t=[];this.nodes.forEach(function(o){var e,i,n,s=-1;if(!defined(o.options.column))if(0===o.linksTo.length)o.column=0;else{for(i=0;i<o.linksTo.length;i++)(n=o.linksTo[0]).fromNode.column>s&&(s=(e=n.fromNode).column);o.column=s+1,e&&"hanging"===e.options.layout&&(o.hangsFrom=e,i=-1,find(e.linksFrom,function(t,e){var n=t.toNode===o;return n&&(i=e),n}),o.column+=i)}t[o.column]||(t[o.column]=this.createNodeColumn()),t[o.column].push(o)},this);for(var o=0;o<t.length;o++)void 0===t[o]&&(t[o]=this.createNodeColumn());return t},hasData:function(){return!!this.processedXData.length},pointAttribs:function(t,o){var e=this,i=t.isNode?t.level:t.fromNode.level,n=e.mapOptionsToLevel[i||0]||{},s=t.options,r=n.states&&n.states[o]||{},a=["colorByPoint","borderColor","borderWidth","linkOpacity"].reduce(function(t,o){return t[o]=pick(r[o],s[o],n[o],e.options[o]),t},{}),l=pick(r.color,s.color,a.colorByPoint?t.color:n.color);return t.isNode?{fill:l,stroke:a.borderColor,"stroke-width":a.borderWidth}:{fill:Color.parse(l).setOpacity(a.linkOpacity).get()}},generatePoints:function(){H.NodesMixin.generatePoints.apply(this,arguments),this.orderNodes&&(this.nodes.filter(function(t){return 0===t.linksTo.length}).forEach(function(t){!function t(o,e){void 0===o.level&&(o.level=e,o.linksFrom.forEach(function(o){o.toNode&&t(o.toNode,e+1)}))}(t,0)}),stableSort(this.nodes,function(t,o){return t.level-o.level}))},translateNode:function(t,o){var e=this.translationFactor,i=this.chart,n=this.options,s=t.getSum(),r=Math.max(Math.round(s*e),this.options.minLinkWidth),a=Math.round(n.borderWidth)%2/2,l=o.offset(t,e),h=Math.floor(pick(l.absoluteTop,o.top(e)+l.relativeTop))+a,d=Math.floor(this.colDistance*t.column+n.borderWidth/2)+a,p=i.inverted?i.plotSizeX-d:d,c=Math.round(this.nodeWidth);t.sum=s,s?(t.shapeType="rect",t.nodeX=p,t.nodeY=h,i.inverted?t.shapeArgs={x:p-c,y:i.plotSizeY-h-r,width:t.options.height||n.height||c,height:t.options.width||n.width||r}:t.shapeArgs={x:p,y:h,width:t.options.width||n.width||c,height:t.options.height||n.height||r},t.shapeArgs.display=t.hasShape()?"":"none",t.dlOptions=getDLOptions({level:this.mapOptionsToLevel[t.level],optionsPoint:t.options}),t.plotY=1,t.tooltipPos=i.inverted?[i.plotSizeY-t.shapeArgs.y-t.shapeArgs.height/2,i.plotSizeX-t.shapeArgs.x-t.shapeArgs.width/2]:[t.shapeArgs.x+t.shapeArgs.width/2,t.shapeArgs.y+t.shapeArgs.height/2]):t.dlOptions={enabled:!1}},translateLink:function(t){var o=function(o,e){var i,n=o.offset(t,e)*s;return Math.min(o.nodeY+n,o.nodeY+(null===(i=o.shapeArgs)||void 0===i?void 0:i.height)-r)},e=t.fromNode,i=t.toNode,n=this.chart,s=this.translationFactor,r=Math.max(t.weight*s,this.options.minLinkWidth),a=this.options,l=(n.inverted?-this.colDistance:this.colDistance)*a.curveFactor,h=o(e,"linksFrom"),d=o(i,"linksTo"),p=e.nodeX,c=this.nodeWidth,u=i.column*this.colDistance,m=t.outgoing,f=u>p;if(n.inverted&&(h=n.plotSizeY-h,d=n.plotSizeY-d,u=n.plotSizeX-u,c=-c,r=-r,f=p>u),t.shapeType="path",t.linkBase=[h,h+r,d,d+r],f)t.shapeArgs={d:["M",p+c,h,"C",p+c+l,h,u-l,d,u,d,"L",u+(m?c:0),d+r/2,"L",u,d+r,"C",u-l,d+r,p+c+l,h+r,p+c,h+r,"z"]};else{var g=n.plotHeight-h-r,v=u-20-r,y=u-20,b=u,k=p+c,L=k+20,N=L+r,C=h,S=h+r,P=S+20,x=P+g,O=x+20,W=O+r,M=d,T=M+r,w=T+20,z=S-.7*r,A=O+.7*r,F=T-.7*r,D=b-.7*r,Y=k+.7*r;t.shapeArgs={d:["M",k,C,"C",Y,C,N,z,N,P,"L",N,x,"C",N,A,Y,W,k,W,"L",b,W,"C",D,W,v,A,v,x,"L",v,w,"C",v,F,D,M,b,M,"L",b,T,"C",y,T,y,T,y,w,"L",y,x,"C",y,O,y,O,b,O,"L",k,O,"C",L,O,L,O,L,x,"L",L,P,"C",L,S,L,S,k,S,"z"]}}t.dlBox={x:p+(u-p+c)/2,y:h+(d-h)/2,height:r,width:0},t.tooltipPos=n.inverted?[n.plotSizeY-t.dlBox.y-r/2,n.plotSizeX-t.dlBox.x]:[t.dlBox.x,t.dlBox.y+r/2],t.y=t.plotY=1,t.color||(t.color=e.color)},translate:function(){var t=this;this.processedXData||this.processData(),this.generatePoints(),this.nodeColumns=this.createNodeColumns(),this.nodeWidth=relativeLength(this.options.nodeWidth,this.chart.plotSizeX);var o=this,e=this.chart,i=this.options,n=this.nodeWidth,s=this.nodeColumns;this.nodePadding=this.getNodePadding(),this.translationFactor=s.reduce(function(n,s){return Math.min(n,function(n){for(var s,r,a=n.slice(),l=t.options.minLinkWidth||0,h=0,d=e.plotSizeY-i.borderWidth-(n.length-1)*o.nodePadding;n.length;){for(h=d/n.sum(),s=!1,r=n.length;r--;)n[r].getSum()*h<l&&(n.splice(r,1),d-=l+o.nodePadding,s=!0);if(!s)break}return n.length=0,a.forEach(function(t){return n.push(t)}),h}(s))},1/0),this.colDistance=(e.plotSizeX-n-i.borderWidth)/Math.max(1,s.length-1),o.mapOptionsToLevel=getLevelOptions({from:1,levels:i.levels,to:s.length-1,defaults:{borderColor:i.borderColor,borderRadius:i.borderRadius,borderWidth:i.borderWidth,color:o.color,colorByPoint:i.colorByPoint,levelIsConstant:!0,linkColor:i.linkColor,linkLineWidth:i.linkLineWidth,linkOpacity:i.linkOpacity,states:i.states}}),s.forEach(function(t){t.forEach(function(e){o.translateNode(e,t)})},this),this.nodes.forEach(function(t){t.linksFrom.forEach(function(t){(t.weight||t.isNull)&&t.to&&(o.translateLink(t),t.allowShadow=!1)})})},render:function(){var t=this.points;this.points=this.points.concat(this.nodes||[]),H.seriesTypes.column.prototype.render.call(this),this.points=t},animate:H.Series.prototype.animate},{applyOptions:function(t,o){return Point.prototype.applyOptions.call(this,t,o),defined(this.options.level)&&(this.options.column=this.column=this.options.level),this},setState:H.NodesMixin.setNodeState,getClassName:function(){return(this.isNode?"highcharts-node ":"highcharts-link ")+Point.prototype.getClassName.call(this)},isValid:function(){return this.isNode||"number"==typeof this.weight}});