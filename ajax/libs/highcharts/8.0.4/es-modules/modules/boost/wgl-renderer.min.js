"use strict";import H from"../../parts/Globals.js";import GLShader from"./wgl-shader.js";import GLVertexBuffer from"./wgl-vbuffer.js";import Color from"../../parts/Color.js";var color=Color.parse;import U from"../../parts/Utilities.js";var isNumber=U.isNumber,merge=U.merge,objectEach=U.objectEach,win=H.win,doc=win.document,some=H.some,pick=H.pick;function GLRenderer(e){var t=!1,i=!1,n=!1,r=0,s=0,o=!1,a=!1,l={},d=!1,u=[],m={},c={column:!0,columnrange:!0,bar:!0,area:!0,arearange:!0},g={scatter:!0,bubble:!0},h={pointSize:1,lineWidth:1,fillColor:"#AA00AA",useAlpha:!0,usePreallocated:!1,useGPUTranslations:!1,debug:{timeRendering:!1,timeSeriesProcessing:!1,timeSetup:!1,timeBufferCopy:!1,timeKDTree:!1,showSkipSummary:!1}};function f(e){var t,i,n;return e.isSeriesBoosting?(t=!!e.options.stacking,i=e.xData||e.options.xData||e.processedXData,n=(t?e.data:i||e.options.data).length,"treemap"===e.type?n*=12:"heatmap"===e.type?n*=6:c[e.type]&&(n*=2),n):0}function p(e,t){return[2/e,0,0,0,0,-2/t,0,0,0,0,-2,0,-1,1,-1,1]}function x(){n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT)}function b(){u=[],l.data=o=[],a=[],i&&i.destroy()}function A(e){t&&(t.setUniform("xAxisTrans",e.transA),t.setUniform("xAxisMin",e.min),t.setUniform("xAxisMinPad",e.minPixelPadding),t.setUniform("xAxisPointRange",e.pointRange),t.setUniform("xAxisLen",e.len),t.setUniform("xAxisPos",e.pos),t.setUniform("xAxisCVSCoord",!e.horiz),t.setUniform("xAxisIsLog",e.isLog),t.setUniform("xAxisReversed",!!e.reversed))}function T(e){t&&(t.setUniform("yAxisTrans",e.transA),t.setUniform("yAxisMin",e.min),t.setUniform("yAxisMinPad",e.minPixelPadding),t.setUniform("yAxisPointRange",e.pointRange),t.setUniform("yAxisLen",e.len),t.setUniform("yAxisPos",e.pos),t.setUniform("yAxisCVSCoord",!e.horiz),t.setUniform("yAxisIsLog",e.isLog),t.setUniform("yAxisReversed",!!e.reversed))}function E(e,i){t.setUniform("hasThreshold",e),t.setUniform("translatedThreshold",i)}function y(o){return!!o&&(!o.chartHeight||o.chartWidth,r=o.chartWidth||800,s=o.chartHeight||400,!!(n&&r&&s&&t)&&(h.debug.timeRendering&&console.time("gl rendering"),n.canvas.width=r,n.canvas.height=s,t.bind(),n.viewport(0,0,r,s),t.setPMatrix(p(r,s)),h.lineWidth>1&&!H.isMS&&n.lineWidth(h.lineWidth),i.build(l.data,"aVertexPosition",4),i.bind(),t.setInverted(o.inverted),u.forEach(function(e,r){var s,a,l,d=e.series.options,u=d.marker,c=void 0!==d.lineWidth?d.lineWidth:1,f=d.threshold,p=isNumber(f),x=e.series.yAxis.getThreshold(f),b=pick(d.marker?d.marker.enabled:null,!!e.series.xAxis.isRadial||null,e.series.closestPointRangePx>2*((d.marker?d.marker.radius:10)||10)),y=m[u&&u.symbol||e.series.symbol]||m.circle,P=[];if(!(0===e.segments.length||e.segmentslength&&e.segments[0].from===e.segments[0].to)){if(y.isReady&&(n.bindTexture(n.TEXTURE_2D,y.handle),t.setTexture(y.handle)),o.styledMode?l=e.series.markerGroup&&e.series.markerGroup.getStyle("fill"):(l=e.series.pointAttribs&&e.series.pointAttribs().fill||e.series.color,d.colorByPoint&&(l=e.series.chart.options.colors[r])),e.series.fillOpacity&&d.fillOpacity&&(l=new Color(l).setOpacity(pick(d.fillOpacity,1)).get()),P=color(l).rgba,h.useAlpha||(P[3]=1),"lines"===e.drawMode&&h.useAlpha&&P[3]<1&&(P[3]/=10),"add"===d.boostBlending?(n.blendFunc(n.SRC_ALPHA,n.ONE),n.blendEquation(n.FUNC_ADD)):"mult"===d.boostBlending||"multiply"===d.boostBlending?n.blendFunc(n.DST_COLOR,n.ZERO):"darken"===d.boostBlending?(n.blendFunc(n.ONE,n.ONE),n.blendEquation(n.FUNC_MIN)):n.blendFuncSeparate(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA,n.ONE,n.ONE_MINUS_SRC_ALPHA),t.reset(),e.colorData.length>0&&(t.setUniform("hasColor",1),(a=GLVertexBuffer(n,t)).build(e.colorData,"aColor",4),a.bind()),t.setColor(P),A(e.series.xAxis),T(e.series.yAxis),E(p,x),"points"===e.drawMode&&(d.marker&&d.marker.radius?t.setPointSize(2*d.marker.radius):t.setPointSize(1)),t.setSkipTranslation(e.skipTranslation),"bubble"===e.series.type&&t.setBubbleUniforms(e.series,e.zMin,e.zMax),t.setDrawAsCircle(g[e.series.type]||!1),c>0||"line_strip"!==e.drawMode)for(s=0;s<e.segments.length;s++)i.render(e.segments[s].from,e.segments[s].to,e.drawMode);if(e.hasMarkers&&b)for(d.marker&&d.marker.radius?t.setPointSize(2*d.marker.radius):t.setPointSize(10),t.setDrawAsCircle(!0),s=0;s<e.segments.length;s++)i.render(e.segments[s].from,e.segments[s].to,"POINTS")}}),h.debug.timeRendering&&console.timeEnd("gl rendering"),e&&e(),void b()))}return l={allocateBufferForSingleSeries:function(e){var t=0;h.usePreallocated&&(e.isSeriesBoosting&&(t=f(e)),i.allocate(t))},pushSeries:function(e){u.length>0&&u[u.length-1].hasMarkers&&(u[u.length-1].markerTo=a.length),h.debug.timeSeriesProcessing&&console.time("building "+e.type+" series"),u.push({segments:[],markerFrom:a.length,colorData:[],series:e,zMin:Number.MAX_VALUE,zMax:-Number.MAX_VALUE,hasMarkers:!!e.options.marker&&!1!==e.options.marker.enabled,showMarkers:!0,drawMode:{area:"lines",arearange:"lines",areaspline:"line_strip",column:"lines",columnrange:"lines",bar:"lines",line:"line_strip",scatter:"points",heatmap:"triangles",treemap:"triangles",bubble:"points"}[e.type]||"line_strip"}),function(e,t){var n,r,s,a,l,d,u,m=e.pointArrayMap&&"low,high"===e.pointArrayMap.join(","),g=e.chart,f=e.options,p=!!f.stacking,x=f.data,b=e.xAxis.getExtremes(),A=b.min,T=b.max,E=e.yAxis.getExtremes(),y=E.min,P=E.max,U=e.xData||f.xData||e.processedXData,M=e.yData||f.yData||e.processedYData,S=e.zData||f.zData||e.processedZData,R=e.yAxis,_=e.xAxis,v=e.chart.plotWidth,D=!U||0===U.length,k=f.connectNulls,w=e.points||!1,L=!1,N=!1,C=p?e.data:U||x,z={x:Number.MAX_VALUE,y:0},B={x:-Number.MAX_VALUE,y:0},X=0,G=!1,I=-1,O=!1,F=!1,H=void 0===g.index,V=!1,W=!1,j=!1,Y=c[e.type],q=!1,Z=!0,K=!0,J=f.zones||!1,Q=!1,$=f.threshold,ee=!1;if(!(f.boostData&&f.boostData.length>0)){if(f.gapSize&&(ee="value"!==f.gapUnit?f.gapSize*e.closestPointRange:f.gapSize),J&&(some(J,function(e){if(void 0===e.value)return Q=new Color(e.color),!0}),Q||(Q=e.pointAttribs&&e.pointAttribs().fill||e.color,Q=new Color(Q))),g.inverted&&(v=e.chart.plotHeight),e.closestPointRangePx=Number.MAX_VALUE,re(),w&&w.length>0)return t.skipTranslation=!0,t.drawMode="triangles",w[0].node&&w[0].node.levelDynamic&&w.sort(function(e,t){if(e.node){if(e.node.levelDynamic>t.node.levelDynamic)return 1;if(e.node.levelDynamic<t.node.levelDynamic)return-1}return 0}),w.forEach(function(t){var i,n,s,o=t.plotY;void 0===o||isNaN(o)||null===t.y||(i=t.shapeArgs,n=(s=g.styledMode?t.series.colorAttribs(t):s=t.series.pointAttribs(t))["stroke-width"]||0,(j=color(s.fill).rgba)[0]/=255,j[1]/=255,j[2]/=255,"treemap"===e.type&&(n=n||1,(r=color(s.stroke).rgba)[0]/=255,r[1]/=255,r[2]/=255,se(i.x,i.y,i.width,i.height,r),n/=2),"heatmap"===e.type&&g.inverted&&(i.x=_.len-i.x,i.y=R.len-i.y,i.width=-i.width,i.height=-i.height),se(i.x+n,i.y+n,i.width-2*n,i.height-2*n,j))}),void ne();for(;I<C.length-1&&(l=C[++I],!H);)D?(s=l[0],a=l[1],C[I+1]&&(F=C[I+1][0]),C[I-1]&&(O=C[I-1][0]),l.length>=3&&(d=l[2],l[2]>t.zMax&&(t.zMax=l[2]),l[2]<t.zMin&&(t.zMin=l[2]))):(s=l,a=M[I],C[I+1]&&(F=C[I+1]),C[I-1]&&(O=C[I-1]),S&&S.length&&(d=S[I],S[I]>t.zMax&&(t.zMax=S[I]),S[I]<t.zMin&&(t.zMin=S[I]))),k||null!==s&&null!==a?(F&&F>=A&&F<=T&&(V=!0),O&&O>=A&&O<=T&&(W=!0),m?(D&&(a=l.slice(1,3)),u=a[0],a=a[1]):p&&(s=l.x,u=(a=l.stackY)-l.y),null!=y&&null!=P&&(Z=a>=y&&a<=P),s>T&&B.x<T&&(B.x=s,B.y=a),s<A&&z.x>A&&(z.x=s,z.y=a),null===a&&k||(null!==a&&(Z||V||W)?((F>=A||s>=A)&&(O<=T||s<=T)&&(q=!0),(q||V||W)&&(ee&&s-O>ee&&re(),J&&(j=Q.rgba,some(J,function(e,t){var i=J[t-1];if(void 0!==e.value&&a<=e.value)return(!i||a>=i.value)&&(j=color(e.color).rgba),!0}),j[0]/=255,j[1]/=255,j[2]/=255),!h.useGPUTranslations&&(t.skipTranslation=!0,s=_.toPixels(s,!0),a=R.toPixels(a,!0),s>v&&"points"===t.drawMode)||(Y&&(n=u,!1!==u&&void 0!==u||(n=a<0?a:0),m||p||(n=Math.max(null===$?y:$,y)),h.useGPUTranslations||(n=R.toPixels(n,!0)),ie(s,n,0,0,j)),t.hasMarkers&&q&&!1!==L&&(e.closestPointRangePx=Math.min(e.closestPointRangePx,Math.abs(s-L))),!h.useGPUTranslations&&!h.usePreallocated&&L&&Math.abs(s-L)<1&&N&&Math.abs(a-N)<1?h.debug.showSkipSummary&&++X:(f.step&&!K&&ie(s,N,0,2,j),ie(s,a,0,"bubble"===e.type?d||1:2,j),L=s,N=a,G=!0,K=!1)))):re())):re();h.debug.showSkipSummary&&console.log("skipped points:",X),G||!1===k||"line_strip"!==e.drawMode||(z.x<Number.MAX_VALUE&&oe(z,!0),B.x>-Number.MAX_VALUE&&oe(B)),ne()}function te(e){e&&(t.colorData.push(e[0]),t.colorData.push(e[1]),t.colorData.push(e[2]),t.colorData.push(e[3]))}function ie(e,t,n,r,s){te(s),h.usePreallocated?i.push(e,t,n?1:0,r||1):(o.push(e),o.push(t),o.push(n?1:0),o.push(r||1))}function ne(){t.segments.length&&(t.segments[t.segments.length-1].to=o.length)}function re(){t.segments.length&&t.segments[t.segments.length-1].from===o.length||(ne(),t.segments.push({from:o.length}))}function se(e,t,i,n,r){te(r),ie(e+i,t),te(r),ie(e,t),te(r),ie(e,t+n),te(r),ie(e,t+n),te(r),ie(e+i,t+n),te(r),ie(e+i,t)}function oe(e,i){h.useGPUTranslations||(t.skipTranslation=!0,e.x=_.toPixels(e.x,!0),e.y=R.toPixels(e.y,!0)),i?o=[e.x,e.y,0,2].concat(o):ie(e.x,e.y,0,2)}}(e,u[u.length-1]),h.debug.timeSeriesProcessing&&console.timeEnd("building "+e.type+" series")},setSize:function(e,i){r===e&&s===i||!t||(r=e,s=i,t.bind(),t.setPMatrix(p(r,s)))},inited:function(){return d},setThreshold:E,init:function(e,r){var s=0,o=["webgl","experimental-webgl","moz-webgl","webkit-3d"];if(d=!1,!e)return!1;for(h.debug.timeSetup&&console.time("gl setup");s<o.length&&!(n=e.getContext(o[s],{}));s++);if(!n)return!1;if(r||b(),n.enable(n.BLEND),n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA),n.disable(n.DEPTH_TEST),n.depthFunc(n.LESS),!(t=GLShader(n)))return!1;function a(e,t){var i={isReady:!1,texture:doc.createElement("canvas"),handle:n.createTexture()},r=i.texture.getContext("2d");m[e]=i,i.texture.width=512,i.texture.height=512,r.mozImageSmoothingEnabled=!1,r.webkitImageSmoothingEnabled=!1,r.msImageSmoothingEnabled=!1,r.imageSmoothingEnabled=!1,r.strokeStyle="rgba(255, 255, 255, 0)",r.fillStyle="#FFF",t(r);try{n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,i.handle),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,i.texture),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.bindTexture(n.TEXTURE_2D,null),i.isReady=!0}catch(e){}}return i=GLVertexBuffer(n,t),a("circle",function(e){e.beginPath(),e.arc(256,256,256,0,2*Math.PI),e.stroke(),e.fill()}),a("square",function(e){e.fillRect(0,0,512,512)}),a("diamond",function(e){e.beginPath(),e.moveTo(256,0),e.lineTo(512,256),e.lineTo(256,512),e.lineTo(0,256),e.lineTo(256,0),e.fill()}),a("triangle",function(e){e.beginPath(),e.moveTo(0,512),e.lineTo(256,0),e.lineTo(512,512),e.lineTo(0,512),e.fill()}),a("triangle-down",function(e){e.beginPath(),e.moveTo(0,0),e.lineTo(256,512),e.lineTo(512,0),e.lineTo(0,0),e.fill()}),d=!0,h.debug.timeSetup&&console.timeEnd("gl setup"),!0},render:function e(t){if(x(),t.renderer.forExport)return y(t);d?y(t):setTimeout(function(){e(t)},1)},settings:h,valid:function(){return!1!==n},clear:x,flush:b,setXAxis:A,setYAxis:T,data:o,gl:function(){return n},allocateBuffer:function(e){var t=0;h.usePreallocated&&(e.series.forEach(function(e){e.isSeriesBoosting&&(t+=f(e))}),i.allocate(t))},destroy:function(){b(),i.destroy(),t.destroy(),n&&(objectEach(m,function(e){m[e].handle&&n.deleteTexture(m[e].handle)}),n.canvas.width=1,n.canvas.height=1)},setOptions:function(e){merge(!0,h,e)}}}export default GLRenderer;