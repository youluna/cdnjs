"use strict";import H from"./Globals.js";import U from"./Utilities.js";var clamp=U.clamp,css=U.css,defined=U.defined,discardElement=U.discardElement,extend=U.extend,format=U.format,isNumber=U.isNumber,isString=U.isString,merge=U.merge,offset=U.offset,pick=U.pick,splat=U.splat,syncTimeout=U.syncTimeout,timeUnits=U.timeUnits,doc=H.doc,Tooltip=function(){function t(t,e){this.crosshairs=[],this.distance=0,this.isHidden=!0,this.isSticky=!1,this.now={},this.options={},this.outside=!1,this.chart=t,this.init(t,e)}return t.prototype.applyFilter=function(){var t=this.chart;t.renderer.definition({tagName:"filter",id:"drop-shadow-"+t.index,opacity:.5,children:[{tagName:"feGaussianBlur",in:"SourceAlpha",stdDeviation:1},{tagName:"feOffset",dx:1,dy:1},{tagName:"feComponentTransfer",children:[{tagName:"feFuncA",type:"linear",slope:.3}]},{tagName:"feMerge",children:[{tagName:"feMergeNode"},{tagName:"feMergeNode",in:"SourceGraphic"}]}]}),t.renderer.definition({tagName:"style",textContent:".highcharts-tooltip-"+t.index+"{filter:url(#drop-shadow-"+t.index+")}"})},t.prototype.bodyFormatter=function(t){return t.map(function(t){var e=t.series.tooltipOptions;return(e[(t.point.formatPrefix||"point")+"Formatter"]||t.point.tooltipFormatter).call(t.point,e[(t.point.formatPrefix||"point")+"Format"]||"")})},t.prototype.cleanSplit=function(t){this.chart.series.forEach(function(e){var i=e&&e.tt;i&&(!i.isActive||t?e.tt=i.destroy():i.isActive=!1)})},t.prototype.defaultFormatter=function(t){var e,i=this.points||splat(this);return(e=(e=[t.tooltipFooterHeaderFormatter(i[0])]).concat(t.bodyFormatter(i))).push(t.tooltipFooterHeaderFormatter(i[0],!0)),e},t.prototype.destroy=function(){this.label&&(this.label=this.label.destroy()),this.split&&this.tt&&(this.cleanSplit(this.chart,!0),this.tt=this.tt.destroy()),this.renderer&&(this.renderer=this.renderer.destroy(),discardElement(this.container)),U.clearTimeout(this.hideTimer),U.clearTimeout(this.tooltipTimeout)},t.prototype.getAnchor=function(t,e){var i,o,r,s=this.chart,a=s.pointer,n=s.inverted,l=s.plotTop,h=s.plotLeft,c=0,d=0;return t=splat(t),this.followPointer&&e?(void 0===e.chartX&&(e=a.normalize(e)),i=[e.chartX-h,e.chartY-l]):t[0].tooltipPos?i=t[0].tooltipPos:(t.forEach(function(t){o=t.series.yAxis,r=t.series.xAxis,c+=t.plotX+(!n&&r?r.left-h:0),d+=(t.plotLow?(t.plotLow+t.plotHigh)/2:t.plotY)+(!n&&o?o.top-l:0)}),c/=t.length,d/=t.length,i=[n?s.plotWidth-d:c,this.shared&&!n&&t.length>1&&e?e.chartY-l:n?s.plotHeight-c:d]),i.map(Math.round)},t.prototype.getDateFormat=function(t,e,i,o){var r,s,a=this.chart.time,n=a.dateFormat("%m-%d %H:%M:%S.%L",e),l="01-01 00:00:00.000",h={millisecond:15,second:12,minute:9,hour:6,day:3},c="millisecond";for(s in timeUnits){if(t===timeUnits.week&&+a.dateFormat("%w",e)===i&&n.substr(6)===l.substr(6)){s="week";break}if(timeUnits[s]>t){s=c;break}if(h[s]&&n.substr(h[s])!==l.substr(h[s]))break;"week"!==s&&(c=s)}return s&&(r=a.resolveDTLFormat(o[s]).main),r},t.prototype.getLabel=function(){var t,e,i,o=this,r=this.chart.renderer,s=this.chart.styledMode,a=this.options,n="tooltip"+(defined(a.className)?" "+a.className:""),l=(null===(t=a.style)||void 0===t?void 0:t.pointerEvents)||(!this.followPointer&&a.stickOnContact?"auto":"none");return this.label||(this.outside&&(this.container=e=H.doc.createElement("div"),e.className="highcharts-tooltip-container",css(e,{position:"absolute",top:"1px",pointerEvents:l,zIndex:3}),H.doc.body.appendChild(e),this.renderer=r=new H.Renderer(e,0,0,{},void 0,void 0,r.styledMode)),this.split?this.label=r.g(n):(this.label=r.label("",0,0,a.shape||"callout",null,null,a.useHTML,null,n).attr({padding:a.padding,r:a.borderRadius}),s||this.label.attr({fill:a.backgroundColor,"stroke-width":a.borderWidth}).css(a.style).css({pointerEvents:l}).shadow(a.shadow)),s&&(this.applyFilter(),this.label.addClass("highcharts-tooltip-"+this.chart.index)),o.outside&&!o.split&&(i={x:this.label.xSetter,y:this.label.ySetter},this.label.xSetter=function(t,r){i[r].call(this.label,o.distance),e.style.left=t+"px"},this.label.ySetter=function(t,r){i[r].call(this.label,o.distance),e.style.top=t+"px"}),this.label.on("mouseenter",function(){o.inContact=!0}).on("mouseleave",function(){var t=o.chart.hoverSeries;o.inContact=!1,t&&t.onMouseOut&&t.onMouseOut()}).attr({zIndex:8}).add()),this.label},t.prototype.getPosition=function(t,e,i){var o,r=this.chart,s=this.distance,a={},n=r.inverted&&i.h||0,l=this.outside,h=l?doc.documentElement.clientWidth-2*s:r.chartWidth,c=l?Math.max(doc.body.scrollHeight,doc.documentElement.scrollHeight,doc.body.offsetHeight,doc.documentElement.offsetHeight,doc.documentElement.clientHeight):r.chartHeight,d=r.pointer.getChartPosition(),p=r.containerScaling,f=function(t){return p?t*p.scaleX:t},u=function(t){return p?t*p.scaleY:t},m=function(o){var a="x"===o;return[o,a?h:c,a?t:e].concat(l?[a?f(t):u(e),a?d.left-s+f(i.plotX+r.plotLeft):d.top-s+u(i.plotY+r.plotTop),0,a?h:c]:[a?t:e,a?i.plotX+r.plotLeft:i.plotY+r.plotTop,a?r.plotLeft:r.plotTop,a?r.plotLeft+r.plotWidth:r.plotTop+r.plotHeight])},g=m("y"),y=m("x"),v=!this.followPointer&&pick(i.ttBelow,!r.inverted==!!i.negative),x=function(t){var e=g;g=y,y=e,o=t},b=function(){!1!==function(t,e,i,o,r,l,h){var c="y"===t?u(s):f(s),d=(i-o)/2,p=o<r-s,m=r+s+o<e,g=r-c-i+d,y=r+c-d;if(v&&m)a[t]=y;else if(!v&&p)a[t]=g;else if(p)a[t]=Math.min(h-o,g-n<0?g:g-n);else{if(!m)return!1;a[t]=Math.max(l,y+n+i>e?y:y+n)}}.apply(0,g)?!1!==function(t,e,i,o,r){var n;return r<s||r>e-s?n=!1:a[t]=r<i/2?1:r>e-o/2?e-o-2:r-i/2,n}.apply(0,y)||o||(x(!0),b()):o?a.x=a.y=0:(x(!0),b())};return(r.inverted||this.len>1)&&x(),b(),a},t.prototype.getXDateFormat=function(t,e,i){var o=e.dateTimeLabelFormats,r=i&&i.closestPointRange;return(r?this.getDateFormat(r,t.x,i.options.startOfWeek,o):o.day)||o.year},t.prototype.hide=function(t){var e=this;U.clearTimeout(this.hideTimer),t=pick(t,this.options.hideDelay,500),this.isHidden||(this.hideTimer=syncTimeout(function(){e.getLabel()[t?"fadeOut":"hide"](),e.isHidden=!0},t))},t.prototype.init=function(t,e){this.chart=t,this.options=e,this.crosshairs=[],this.now={x:0,y:0},this.isHidden=!0,this.split=e.split&&!t.inverted&&!t.polar,this.shared=e.shared||this.split,this.outside=pick(e.outside,Boolean(t.scrollablePixelsX||t.scrollablePixelsY))},t.prototype.isStickyOnContact=function(){return!(this.followPointer||!this.options.stickOnContact||!this.inContact)},t.prototype.move=function(t,e,i,o){var r=this,s=r.now,a=!1!==r.options.animation&&!r.isHidden&&(Math.abs(t-s.x)>1||Math.abs(e-s.y)>1),n=r.followPointer||r.len>1;extend(s,{x:a?(2*s.x+t)/3:t,y:a?(s.y+e)/2:e,anchorX:n?void 0:a?(2*s.anchorX+i)/3:i,anchorY:n?void 0:a?(s.anchorY+o)/2:o}),r.getLabel().attr(s),r.drawTracker(),a&&(U.clearTimeout(this.tooltipTimeout),this.tooltipTimeout=setTimeout(function(){r&&r.move(t,e,i,o)},32))},t.prototype.refresh=function(t,e){var i,o,r,s,a,n=this.chart,l=this.options,h=t,c={},d=[],p=l.formatter||this.defaultFormatter,f=this.shared,u=n.styledMode;if(l.enabled){if(U.clearTimeout(this.hideTimer),this.followPointer=splat(h)[0].series.tooltipOptions.followPointer,i=(r=this.getAnchor(h,e))[0],o=r[1],!f||h.series&&h.series.noSharedTooltip?c=h.getLabelConfig():(n.pointer.applyInactiveState(h),h.forEach(function(t){t.setState("hover"),d.push(t.getLabelConfig())}),(c={x:h[0].category,y:h[0].y}).points=d,h=h[0]),this.len=d.length,s=p.call(c,this),a=h.series,this.distance=pick(a.tooltipOptions.distance,16),!1===s)this.hide();else{if(this.split)this.renderSplit(s,splat(t));else{var m=this.getLabel();l.style.width&&!u||m.css({width:this.chart.spacingBox.width}),m.attr({text:s&&s.join?s.join(""):s}),m.removeClass(/highcharts-color-[\d]+/g).addClass("highcharts-color-"+pick(h.colorIndex,a.colorIndex)),u||m.attr({stroke:l.borderColor||h.color||a.color||"#666666"}),this.updatePosition({plotX:i,plotY:o,negative:h.negative,ttBelow:h.ttBelow,h:r[2]||0})}this.isHidden&&this.label&&this.label.attr({opacity:1}).show(),this.isHidden=!1}H.fireEvent(this,"refresh")}},t.prototype.renderSplit=function(t,e){var i=this,o=i.chart,r=i.chart,s=r.chartWidth,a=r.chartHeight,n=r.plotHeight,l=r.plotLeft,h=r.plotTop,c=r.pointer,d=r.renderer,p=r.scrollablePixelsY,f=void 0===p?0:p,u=r.scrollingContainer,m=void 0===u?{scrollLeft:0,scrollTop:0}:u,g=m.scrollLeft,y=m.scrollTop,v=r.styledMode,x=i.distance,b=i.options,w=i.options.positioner,k={left:g,right:g+s,top:y,bottom:y+a},T=i.getLabel(),M=Boolean(o.xAxis[0]&&o.xAxis[0].opposite),F=h+y,C=0,S=n-f;function U(t,e,i,o,r){var s,a;return void 0===r&&(r=!0),i?(s=M?0:S,a=clamp(t-o/2,k.left,k.right-o)):(s=e-F,a=clamp(a=r?t-o-x:t+x,r?a:k.left,k.right)),{x:a,y:s}}isString(t)&&(t=[!1,t]);var L=t.slice(0,e.length+1).reduce(function(t,o,r){if(!1!==o&&""!==o){var s=e[r-1]||{isHeader:!0,plotX:e[0].plotX,plotY:n,series:{}},a=s.isHeader,c=a?i:s.series,p=c.tt=function(t,e,i){var o=t,r=e.isHeader,s=e.series,a="highcharts-color-"+pick(e.colorIndex,s.colorIndex,"none");if(!o){var n={padding:b.padding,r:b.borderRadius};v||(n.fill=b.backgroundColor,n["stroke-width"]=b.borderWidth),o=d.label("",0,0,b[r?"headerShape":"shape"]||"callout",void 0,void 0,b.useHTML).addClass((r?"highcharts-tooltip-header ":"")+"highcharts-tooltip-box "+a).attr(n).add(T)}return o.isActive=!0,o.attr({text:i}),v||o.css(b.style).shadow(b.shadow).attr({stroke:b.borderColor||e.color||s.color||"#333333"}),o}(c.tt,s,o),u=p.getBBox(),m=u.width+p.strokeWidth();a&&(C=u.height,S+=C,M&&(F-=C));var g=function(t){var e,i,o=t.isHeader,r=t.plotX,s=void 0===r?0:r,a=t.plotY,c=void 0===a?0:a,d=t.series;if(o)e=l+s,i=h+n/2;else{var p=d.xAxis,u=d.yAxis;e=p.pos+clamp(s,-x,p.len+x),u.pos+c>=y+h&&u.pos+c<=y+h+n-f&&(i=u.pos+c)}return{anchorX:e=clamp(e,k.left-x,k.right+x),anchorY:i}}(s),H=g.anchorX,L=g.anchorY;if("number"==typeof L){var X=u.height+1,P=w?w.call(i,m,X,s):U(H,L,a,m);t.push({align:w?0:void 0,anchorX:H,anchorY:L,boxWidth:m,point:s,rank:pick(P.rank,a?1:0),size:X,target:P.y,tt:p,x:P.x})}else p.isActive=!1}return t},[]);!w&&L.some(function(t){return t.x<k.left})&&(L=L.map(function(t){var e=U(t.anchorX,t.anchorY,t.point.isHeader,t.boxWidth,!1),i=e.x,o=e.y;return extend(t,{target:o,x:i})})),i.cleanSplit(),H.distribute(L,S),L.forEach(function(t){var e=t.anchorX,i=t.anchorY,o=t.pos,r=t.x;t.tt.attr({visibility:void 0===o?"hidden":"inherit",x:r,y:o+F,anchorX:e,anchorY:i})});var X=i.container,P=i.outside,Y=i.renderer;if(P&&X&&Y){var E=T.getBBox(),N=E.width,A=E.height,O=E.x,B=E.y;Y.setSize(N+O,A+B,!1);var W=c.getChartPosition();X.style.left=W.left+"px",X.style.top=W.top+"px"}},t.prototype.drawTracker=function(){if(!this.followPointer&&this.options.stickOnContact){var t=this.chart,e=this.label,i=t.hoverPoint;if(e&&i){var o={x:0,y:0,width:0,height:0},r=this.getAnchor(i),s=e.getBBox();r[0]+=t.plotLeft-e.translateX,r[1]+=t.plotTop-e.translateY,o.x=Math.min(0,r[0]),o.y=Math.min(0,r[1]),o.width=r[0]<0?Math.max(Math.abs(r[0]),s.width-r[0]):Math.max(Math.abs(r[0]),s.width),o.height=r[1]<0?Math.max(Math.abs(r[1]),s.height-Math.abs(r[1])):Math.max(Math.abs(r[1]),s.height),this.tracker?this.tracker.attr(o):(this.tracker=e.renderer.rect(o).addClass("highcharts-tracker").add(e),t.styledMode||this.tracker.attr({fill:"rgba(0,0,0,0)"}))}}else this.tracker&&this.tracker.destroy()},t.prototype.styledModeFormat=function(t){return t.replace('style="font-size: 10px"','class="highcharts-header"').replace(/style="color:{(point|series)\.color}"/g,'class="highcharts-color-{$1.colorIndex}"')},t.prototype.tooltipFooterHeaderFormatter=function(t,e){var i=e?"footer":"header",o=t.series,r=o.tooltipOptions,s=r.xDateFormat,a=o.xAxis,n=a&&"datetime"===a.options.type&&isNumber(t.key),l=r[i+"Format"],h={isFooter:e,labelConfig:t};return H.fireEvent(this,"headerFormatter",h,function(e){n&&!s&&(s=this.getXDateFormat(t,r,a)),n&&s&&(t.point&&t.point.tooltipDateKeys||["key"]).forEach(function(t){l=l.replace("{point."+t+"}","{point."+t+":"+s+"}")}),o.chart.styledMode&&(l=this.styledModeFormat(l)),e.text=format(l,{point:t,series:o},this.chart)}),h.text},t.prototype.update=function(t){this.destroy(),merge(!0,this.chart.options.tooltip.userOptions,t),this.init(this.chart,merge(!0,this.options,t))},t.prototype.updatePosition=function(t){var e,i,o=this.chart,r=o.pointer,s=this.getLabel(),a=t.plotX+o.plotLeft,n=t.plotY+o.plotTop,l=r.getChartPosition();if(e=(this.options.positioner||this.getPosition).call(this,s.width,s.height,t),this.outside){i=(this.options.borderWidth||0)+2*this.distance,this.renderer.setSize(s.width+i,s.height+i,!1);var h=o.containerScaling;h&&(css(this.container,{transform:"scale("+h.scaleX+", "+h.scaleY+")"}),a*=h.scaleX,n*=h.scaleY),a+=l.left-e.x,n+=l.top-e.y}this.move(Math.round(e.x),Math.round(e.y||0),a,n)},t}();H.Tooltip=Tooltip;export default H.Tooltip;