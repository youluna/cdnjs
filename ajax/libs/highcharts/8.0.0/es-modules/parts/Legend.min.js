"use strict";import Highcharts from"./Globals.js";import U from"./Utilities.js";var defined=U.defined,discardElement=U.discardElement,isNumber=U.isNumber,pick=U.pick,relativeLength=U.relativeLength,setAnimation=U.setAnimation,syncTimeout=U.syncTimeout,wrap=U.wrap,H=Highcharts,addEvent=H.addEvent,css=H.css,fireEvent=H.fireEvent,isFirefox=H.isFirefox,marginNames=H.marginNames,merge=H.merge,stableSort=H.stableSort,win=H.win;Highcharts.Legend=function(t,i){this.init(t,i)},Highcharts.Legend.prototype={init:function(t,i){this.chart=t,this.setOptions(i),i.enabled&&(this.render(),addEvent(this.chart,"endResize",function(){this.legend.positionCheckboxes()}),this.proximate?this.unchartrender=addEvent(this.chart,"render",function(){this.legend.proximatePositions(),this.legend.positionItems()}):this.unchartrender&&this.unchartrender())},setOptions:function(t){var i=pick(t.padding,8);this.options=t,this.chart.styledMode||(this.itemStyle=t.itemStyle,this.itemHiddenStyle=merge(this.itemStyle,t.itemHiddenStyle)),this.itemMarginTop=t.itemMarginTop||0,this.itemMarginBottom=t.itemMarginBottom||0,this.padding=i,this.initialItemY=i-5,this.symbolWidth=pick(t.symbolWidth,16),this.pages=[],this.proximate="proximate"===t.layout&&!this.chart.inverted},update:function(t,i){var e=this.chart;this.setOptions(merge(!0,this.options,t)),this.destroy(),e.isDirtyLegend=e.isDirtyBox=!0,pick(i,!0)&&e.redraw(),fireEvent(this,"afterUpdate")},colorizeItem:function(t,i){if(t.legendGroup[i?"removeClass":"addClass"]("highcharts-legend-item-hidden"),!this.chart.styledMode){var e=this.options,s=t.legendItem,h=t.legendLine,n=t.legendSymbol,o=this.itemHiddenStyle.color,r=i?e.itemStyle.color:o,a=i&&t.color||o,l=t.options&&t.options.marker,d={fill:a};s&&s.css({fill:r,color:r}),h&&h.attr({stroke:a}),n&&(l&&n.isMarker&&(d=t.pointAttribs(),i||(d.stroke=d.fill=o)),n.attr(d))}fireEvent(this,"afterColorizeItem",{item:t,visible:i})},positionItems:function(){this.allItems.forEach(this.positionItem,this),this.chart.isResizing||this.positionCheckboxes()},positionItem:function(t){var i=this.options,e=i.symbolPadding,s=!i.rtl,h=t._legendItemPos,n=h[0],o=h[1],r=t.checkbox,a=t.legendGroup;a&&a.element&&a[defined(a.translateY)?"animate":"attr"]({translateX:s?n:this.legendWidth-n-2*e-4,translateY:o}),r&&(r.x=n,r.y=o)},destroyItem:function(t){var i=t.checkbox;["legendItem","legendLine","legendSymbol","legendGroup"].forEach(function(i){t[i]&&(t[i]=t[i].destroy())}),i&&discardElement(t.checkbox)},destroy:function(){function t(t){this[t]&&(this[t]=this[t].destroy())}this.getAllItems().forEach(function(i){["legendItem","legendGroup"].forEach(t,i)}),["clipRect","up","down","pager","nav","box","title","group"].forEach(t,this),this.display=null},positionCheckboxes:function(){var t,i=this.group&&this.group.alignAttr,e=this.clipHeight||this.legendHeight,s=this.titleHeight;i&&(t=i.translateY,this.allItems.forEach(function(h){var n,o=h.checkbox;o&&(n=t+s+o.y+(this.scrollOffset||0)+3,css(o,{left:i.translateX+h.checkboxOffset+o.x-20+"px",top:n+"px",display:this.proximate||n>t-6&&n<t+e-6?"":"none"}))},this))},renderTitle:function(){var t,i=this.options,e=this.padding,s=i.title,h=0;s.text&&(this.title||(this.title=this.chart.renderer.label(s.text,e-3,e-4,null,null,null,i.useHTML,null,"legend-title").attr({zIndex:1}),this.chart.styledMode||this.title.css(s.style),this.title.add(this.group)),s.width||this.title.css({width:this.maxLegendWidth+"px"}),h=(t=this.title.getBBox()).height,this.offsetWidth=t.width,this.contentGroup.attr({translateY:h})),this.titleHeight=h},setText:function(t){var i=this.options;t.legendItem.attr({text:i.labelFormat?H.format(i.labelFormat,t,this.chart):i.labelFormatter.call(t)})},renderItem:function(t){var i,e=this.chart,s=e.renderer,h=this.options,n="horizontal"===h.layout,o=this.symbolWidth,r=h.symbolPadding,a=this.itemStyle,l=this.itemHiddenStyle,d=n?pick(h.itemDistance,20):0,c=!h.rtl,g=t.legendItem,m=!t.series,p=!m&&t.series.drawLegendSymbol?t.series:t,f=p.options,u=this.createCheckboxForItem&&f&&f.showCheckbox,x=o+r+d+(u?20:0),y=h.useHTML,b=t.options.className;g||(t.legendGroup=s.g("legend-item").addClass("highcharts-"+p.type+"-series highcharts-color-"+t.colorIndex+(b?" "+b:"")+(m?" highcharts-series-"+t.index:"")).attr({zIndex:1}).add(this.scrollGroup),t.legendItem=g=s.text("",c?o+r:-r,this.baseline||0,y),e.styledMode||g.css(merge(t.visible?a:l)),g.attr({align:c?"left":"right",zIndex:2}).add(t.legendGroup),this.baseline||(this.fontMetrics=s.fontMetrics(e.styledMode?12:a.fontSize,g),this.baseline=this.fontMetrics.f+3+this.itemMarginTop,g.attr("y",this.baseline)),this.symbolHeight=h.symbolHeight||this.fontMetrics.f,p.drawLegendSymbol(this,t),this.setItemEvents&&this.setItemEvents(t,g,y)),u&&!t.checkbox&&this.createCheckboxForItem(t),this.colorizeItem(t,t.visible),!e.styledMode&&a.width||g.css({width:(h.itemWidth||this.widthOption||e.spacingBox.width)-x}),this.setText(t),i=g.getBBox(),t.itemWidth=t.checkboxOffset=h.itemWidth||t.legendItemWidth||i.width+x,this.maxItemWidth=Math.max(this.maxItemWidth,t.itemWidth),this.totalItemWidth+=t.itemWidth,this.itemHeight=t.itemHeight=Math.round(t.legendItemHeight||i.height||this.symbolHeight)},layoutItem:function(t){var i=this.options,e=this.padding,s="horizontal"===i.layout,h=t.itemHeight,n=this.itemMarginBottom,o=this.itemMarginTop,r=s?pick(i.itemDistance,20):0,a=this.maxLegendWidth,l=i.alignColumns&&this.totalItemWidth>a?this.maxItemWidth:t.itemWidth;s&&this.itemX-e+l>a&&(this.itemX=e,this.lastLineHeight&&(this.itemY+=o+this.lastLineHeight+n),this.lastLineHeight=0),this.lastItemY=o+this.itemY+n,this.lastLineHeight=Math.max(h,this.lastLineHeight),t._legendItemPos=[this.itemX,this.itemY],s?this.itemX+=l:(this.itemY+=o+h+n,this.lastLineHeight=h),this.offsetWidth=this.widthOption||Math.max((s?this.itemX-e-(t.checkbox?0:r):l)+e,this.offsetWidth)},getAllItems:function(){var t=[];return this.chart.series.forEach(function(i){var e=i&&i.options;i&&pick(e.showInLegend,!defined(e.linkedTo)&&void 0,!0)&&(t=t.concat(i.legendItems||("point"===e.legendType?i.data:i)))}),fireEvent(this,"afterGetAllItems",{allItems:t}),t},getAlignment:function(){var t=this.options;return this.proximate?t.align.charAt(0)+"tv":t.floating?"":t.align.charAt(0)+t.verticalAlign.charAt(0)+t.layout.charAt(0)},adjustMargins:function(t,i){var e=this.chart,s=this.options,h=this.getAlignment();h&&[/(lth|ct|rth)/,/(rtv|rm|rbv)/,/(rbh|cb|lbh)/,/(lbv|lm|ltv)/].forEach(function(n,o){n.test(h)&&!defined(t[o])&&(e[marginNames[o]]=Math.max(e[marginNames[o]],e.legend[(o+1)%2?"legendHeight":"legendWidth"]+[1,-1,-1,1][o]*s[o%2?"x":"y"]+pick(s.margin,12)+i[o]+(e.titleOffset[o]||0)))})},proximatePositions:function(){var t=this.chart,i=[],e="left"===this.options.align;this.allItems.forEach(function(s){var h,n,o,r,a=e;s.yAxis&&s.points&&(s.xAxis.options.reversed&&(a=!a),h=H.find(a?s.points:s.points.slice(0).reverse(),function(t){return isNumber(t.plotY)}),n=this.itemMarginTop+s.legendItem.getBBox().height+this.itemMarginBottom,r=s.yAxis.top-t.plotTop,s.visible?(o=h?h.plotY:s.yAxis.height,o+=r-.3*n):o=r+s.yAxis.height,i.push({target:o,size:n,item:s}))},this),H.distribute(i,t.plotHeight),i.forEach(function(i){i.item._legendItemPos[1]=t.plotTop-t.spacing[0]+i.pos})},render:function(){var t,i,e,s,h,n=this.chart,o=n.renderer,r=this.group,a=this.box,l=this.options,d=this.padding;if(this.itemX=d,this.itemY=this.initialItemY,this.offsetWidth=0,this.lastItemY=0,this.widthOption=relativeLength(l.width,n.spacingBox.width-d),h=n.spacingBox.width-2*d-l.x,["rm","lm"].indexOf(this.getAlignment().substring(0,2))>-1&&(h/=2),this.maxLegendWidth=this.widthOption||h,r||(this.group=r=o.g("legend").attr({zIndex:7}).add(),this.contentGroup=o.g().attr({zIndex:1}).add(r),this.scrollGroup=o.g().add(this.contentGroup)),this.renderTitle(),t=this.getAllItems(),stableSort(t,function(t,i){return(t.options&&t.options.legendIndex||0)-(i.options&&i.options.legendIndex||0)}),l.reversed&&t.reverse(),this.allItems=t,this.display=i=!!t.length,this.lastLineHeight=0,this.maxItemWidth=0,this.totalItemWidth=0,this.itemHeight=0,t.forEach(this.renderItem,this),t.forEach(this.layoutItem,this),e=(this.widthOption||this.offsetWidth)+d,s=this.lastItemY+this.lastLineHeight+this.titleHeight,s=this.handleOverflow(s),s+=d,a||(this.box=a=o.rect().addClass("highcharts-legend-box").attr({r:l.borderRadius}).add(r),a.isNew=!0),n.styledMode||a.attr({stroke:l.borderColor,"stroke-width":l.borderWidth||0,fill:l.backgroundColor||"none"}).shadow(l.shadow),e>0&&s>0&&(a[a.isNew?"attr":"animate"](a.crisp.call({},{x:0,y:0,width:e,height:s},a.strokeWidth())),a.isNew=!1),a[i?"show":"hide"](),n.styledMode&&"none"===r.getStyle("display")&&(e=s=0),this.legendWidth=e,this.legendHeight=s,i){var c=n.spacingBox,g=c.y;/(lth|ct|rth)/.test(this.getAlignment())&&n.titleOffset[0]>0?g+=n.titleOffset[0]:/(lbh|cb|rbh)/.test(this.getAlignment())&&n.titleOffset[2]>0&&(g-=n.titleOffset[2]),g!==c.y&&(c=merge(c,{y:g})),r.align(merge(l,{width:e,height:s,verticalAlign:this.proximate?"top":l.verticalAlign}),!0,c)}this.proximate||this.positionItems(),fireEvent(this,"afterRender")},handleOverflow:function(t){var i,e,s=this,h=this.chart,n=h.renderer,o=this.options,r=o.y,a="top"===o.verticalAlign,l=this.padding,d=h.spacingBox.height+(a?-r:r)-l,c=o.maxHeight,g=this.clipRect,m=o.navigation,p=pick(m.animation,!0),f=m.arrowSize||12,u=this.nav,x=this.pages,y=this.allItems,b=function(t){"number"==typeof t?g.attr({height:t}):g&&(s.clipRect=g.destroy(),s.contentGroup.clip()),s.contentGroup.div&&(s.contentGroup.div.style.clip=t?"rect("+l+"px,9999px,"+(l+t)+"px,0)":"auto")},v=function(t){return s[t]=n.circle(0,0,1.3*f).translate(f/2,f/2).add(u),h.styledMode||s[t].attr("fill","rgba(0,0,0,0.0001)"),s[t]};return"horizontal"!==o.layout||"middle"===o.verticalAlign||o.floating||(d/=2),c&&(d=Math.min(d,c)),x.length=0,t>d&&!1!==m.enabled?(this.clipHeight=i=Math.max(d-20-this.titleHeight-l,0),this.currentPage=pick(this.currentPage,1),this.fullHeight=t,y.forEach(function(t,s){var h=t._legendItemPos[1],n=Math.round(t.legendItem.getBBox().height),o=x.length;(!o||h-x[o-1]>i&&(e||h)!==x[o-1])&&(x.push(e||h),o++),t.pageIx=o-1,e&&(y[s-1].pageIx=o-1),s===y.length-1&&h+n-x[o-1]>i&&h!==e&&(x.push(h),t.pageIx=o),h!==e&&(e=h)}),g||(g=s.clipRect=n.clipRect(0,l,9999,0),s.contentGroup.clip(g)),b(i),u||(this.nav=u=n.g().attr({zIndex:1}).add(this.group),this.up=n.symbol("triangle",0,0,f,f).add(u),v("upTracker").on("click",function(){s.scroll(-1,p)}),this.pager=n.text("",15,10).addClass("highcharts-legend-navigation"),h.styledMode||this.pager.css(m.style),this.pager.add(u),this.down=n.symbol("triangle-down",0,0,f,f).add(u),v("downTracker").on("click",function(){s.scroll(1,p)})),s.scroll(0),t=d):u&&(b(),this.nav=u.destroy(),this.scrollGroup.attr({translateY:1}),this.clipHeight=0),t},scroll:function(t,i){var e=this,s=this.chart,h=this.pages,n=h.length,o=this.currentPage+t,r=this.clipHeight,a=this.options.navigation,l=this.pager,d=this.padding;if(o>n&&(o=n),o>0){void 0!==i&&setAnimation(i,s),this.nav.attr({translateX:d,translateY:r+this.padding+7+this.titleHeight,visibility:"visible"}),[this.up,this.upTracker].forEach(function(t){t.attr({class:1===o?"highcharts-legend-nav-inactive":"highcharts-legend-nav-active"})}),l.attr({text:o+"/"+n}),[this.down,this.downTracker].forEach(function(t){t.attr({x:18+this.pager.getBBox().width,class:o===n?"highcharts-legend-nav-inactive":"highcharts-legend-nav-active"})},this),s.styledMode||(this.up.attr({fill:1===o?a.inactiveColor:a.activeColor}),this.upTracker.css({cursor:1===o?"default":"pointer"}),this.down.attr({fill:o===n?a.inactiveColor:a.activeColor}),this.downTracker.css({cursor:o===n?"default":"pointer"})),this.scrollOffset=-h[o-1]+this.initialItemY,this.scrollGroup.animate({translateY:this.scrollOffset}),this.currentPage=o,this.positionCheckboxes();var c=H.animObject(pick(i,s.renderer.globalAnimation,!0));syncTimeout(function(){fireEvent(e,"afterScroll",{currentPage:o})},c.duration||0)}}},H.LegendSymbolMixin={drawRectangle:function(t,i){var e=t.options,s=t.symbolHeight,h=e.squareSymbol,n=h?s:t.symbolWidth;i.legendSymbol=this.chart.renderer.rect(h?(t.symbolWidth-s)/2:0,t.baseline-s+1,n,s,pick(t.options.symbolRadius,s/2)).addClass("highcharts-point").attr({zIndex:3}).add(i.legendGroup)},drawLineMarker:function(t){var i,e,s=this.options,h=s.marker,n=t.symbolWidth,o=t.symbolHeight,r=o/2,a=this.chart.renderer,l=this.legendGroup,d=t.baseline-Math.round(.3*t.fontMetrics.b),c={};this.chart.styledMode||(c={"stroke-width":s.lineWidth||0},s.dashStyle&&(c.dashstyle=s.dashStyle)),this.legendLine=a.path(["M",0,d,"L",n,d]).addClass("highcharts-graph").attr(c).add(l),h&&!1!==h.enabled&&n&&(i=Math.min(pick(h.radius,r),r),0===this.symbol.indexOf("url")&&(h=merge(h,{width:o,height:o}),i=0),this.legendSymbol=e=a.symbol(this.symbol,n/2-i,d-i,2*i,2*i,h).addClass("highcharts-point").add(l),e.isMarker=!0)}},(/Trident\/7\.0/.test(win.navigator&&win.navigator.userAgent)||isFirefox)&&wrap(Highcharts.Legend.prototype,"positionItem",function(t,i){var e=this,s=function(){i._legendItemPos&&t.call(e,i)};s(),e.bubbleLegend||setTimeout(s)});