"use strict";import H from"./Globals.js";import U from"./Utilities.js";var correctFloat=U.correctFloat,defined=U.defined,destroyObjectProperties=U.destroyObjectProperties,objectEach=U.objectEach,pick=U.pick;import"./Axis.js";import"./Chart.js";import"./Series.js";var Axis=H.Axis,Chart=H.Chart,format=H.format,Series=H.Series;H.StackItem=function(t,i,e,s,a){var o=t.chart.inverted;this.axis=t,this.isNegative=e,this.options=i=i||{},this.x=s,this.total=null,this.points={},this.stack=a,this.leftCliff=0,this.rightCliff=0,this.alignOptions={align:i.align||(o?e?"left":"right":"center"),verticalAlign:i.verticalAlign||(o?"middle":e?"bottom":"top"),y:i.y,x:i.x},this.textAlign=i.textAlign||(o?e?"right":"left":"center")},H.StackItem.prototype={destroy:function(){destroyObjectProperties(this,this.axis)},render:function(t){var i=this.axis.chart,e=this.options,s=e.format,a={},o=s?format(s,this,i):e.formatter.call(this);this.label?this.label.attr({text:o,visibility:"hidden"}):(this.label=i.renderer.label(o,null,null,e.shape,null,null,e.useHTML,!1,"stack-labels"),a={text:o,align:this.textAlign,rotation:e.rotation,padding:pick(e.padding,0),visibility:"hidden"},this.label.attr(a),i.styledMode||this.label.css(e.style),this.label.added||this.label.add(t)),this.label.labelrank=i.plotHeight},setOffset:function(t,i,e,s,a){var o,n=this.axis,r=n.chart,c=n.translate(n.usePercentage?100:s||this.total,0,0,0,1),l=n.translate(e||0),h=defined(c)&&Math.abs(c-l),d=pick(a,r.xAxis[0].translate(this.x))+t,p=defined(c)&&this.getStackBox(r,this,d,c,i,h,n),k=this.label,u=this.isNegative,f="justify"===pick(this.options.overflow,"justify");if(k&&p){var x=k.getBBox(),g=r.inverted?u?x.width:0:x.width/2,v=r.inverted?x.height/2:u?-4:x.height+4;this.alignOptions.x=pick(this.options.x,0),k.align(this.alignOptions,null,p),o=k.alignAttr,k.show(),o.y-=v,f&&(o.x-=g,Series.prototype.justifyDataLabel.call(this.axis,k,this.alignOptions,o,x,p),o.x+=g),o.x=k.alignAttr.x,k.attr({x:o.x,y:o.y}),pick(!f&&this.options.crop,!0)&&(r.isInsidePlot(k.x+(r.inverted?0:-x.width/2),k.y)&&r.isInsidePlot(k.x+(r.inverted?u?-x.width:x.width:x.width/2),k.y+x.height)||k.hide())}},getStackBox:function(t,i,e,s,a,o,n){var r=i.axis.reversed,c=t.inverted,l=n.height+n.pos-(c?t.plotLeft:t.plotTop),h=i.isNegative&&!r||!i.isNegative&&r;return{x:c?h?s:s-o:e,y:c?l-e-a:h?l-s-o:l-s,width:c?o:a,height:c?a:o}}},Chart.prototype.getStacks=function(){var t=this,i=t.inverted;t.yAxis.forEach(function(t){t.stacks&&t.hasVisibleSeries&&(t.oldStacks=t.stacks)}),t.series.forEach(function(e){var s=e.xAxis&&e.xAxis.options||{};!e.options.stacking||!0!==e.visible&&!1!==t.options.chart.ignoreHiddenSeries||(e.stackKey=[e.type,pick(e.options.stack,""),i?s.top:s.left,i?s.height:s.width].join(","))})},Axis.prototype.buildStacks=function(){var t,i=this.series,e=pick(this.options.reversedStacks,!0),s=i.length;if(!this.isXAxis){for(this.usePercentage=!1,t=s;t--;)i[e?t:s-t-1].setStackedPoints();for(t=0;t<s;t++)i[t].modifyStacks();H.fireEvent(this,"afterBuildStacks")}},Axis.prototype.renderStackTotals=function(){var t=this.chart,i=t.renderer,e=this.stacks,s=this.stackTotalGroup;s||(this.stackTotalGroup=s=i.g("stack-labels").attr({visibility:"visible",zIndex:6}).add()),s.translate(t.plotLeft,t.plotTop),objectEach(e,function(t){objectEach(t,function(t){t.render(s)})})},Axis.prototype.resetStacks=function(){var t=this,i=t.stacks;t.isXAxis||objectEach(i,function(i){objectEach(i,function(e,s){e.touched<t.stacksTouched?(e.destroy(),delete i[s]):(e.total=null,e.cumulative=null)})})},Axis.prototype.cleanStacks=function(){var t;this.isXAxis||(this.oldStacks&&(t=this.stacks=this.oldStacks),objectEach(t,function(t){objectEach(t,function(t){t.cumulative=t.total})}))},Series.prototype.setStackedPoints=function(){if(this.options.stacking&&(!0===this.visible||!1===this.chart.options.chart.ignoreHiddenSeries)){var t,i,e,s,a,o,n,r,c,l=this.processedXData,h=this.processedYData,d=[],p=h.length,k=this.options,u=k.threshold,f=pick(k.startFromThreshold&&u,0),x=k.stack,g=k.stacking,v=this.stackKey,y="-"+v,b=this.negStacks,S=this.yAxis,m=S.stacks,A=S.oldStacks;for(S.stacksTouched+=1,n=0;n<p;n++)r=l[n],c=h[n],o=(t=this.getStackIndicator(t,r,this.index)).key,m[a=(i=b&&c<(f?0:u))?y:v]||(m[a]={}),m[a][r]||(A[a]&&A[a][r]?(m[a][r]=A[a][r],m[a][r].total=null):m[a][r]=new H.StackItem(S,S.options.stackLabels,i,r,x)),e=m[a][r],null!==c?(e.points[o]=e.points[this.index]=[pick(e.cumulative,f)],defined(e.cumulative)||(e.base=o),e.touched=S.stacksTouched,t.index>0&&!1===this.singleStacks&&(e.points[o][0]=e.points[this.index+","+r+",0"][0])):e.points[o]=e.points[this.index]=null,"percent"===g?(s=i?v:y,b&&m[s]&&m[s][r]?(s=m[s][r],e.total=s.total=Math.max(s.total,e.total)+Math.abs(c)||0):e.total=correctFloat(e.total+(Math.abs(c)||0))):e.total=correctFloat(e.total+(c||0)),e.cumulative=pick(e.cumulative,f)+(c||0),null!==c&&(e.points[o].push(e.cumulative),d[n]=e.cumulative);"percent"===g&&(S.usePercentage=!0),this.stackedYData=d,S.oldStacks={}}},Series.prototype.modifyStacks=function(){var t,i=this,e=i.stackKey,s=i.yAxis.stacks,a=i.processedXData,o=i.options.stacking;i[o+"Stacker"]&&[e,"-"+e].forEach(function(e){for(var n,r,c,l=a.length;l--;)n=a[l],t=i.getStackIndicator(t,n,i.index,e),(c=(r=s[e]&&s[e][n])&&r.points[t.key])&&i[o+"Stacker"](c,r,l)})},Series.prototype.percentStacker=function(t,i,e){var s=i.total?100/i.total:0;t[0]=correctFloat(t[0]*s),t[1]=correctFloat(t[1]*s),this.stackedYData[e]=t[1]},Series.prototype.getStackIndicator=function(t,i,e,s){return!defined(t)||t.x!==i||s&&t.key!==s?t={x:i,index:0,key:s}:t.index++,t.key=[e,i,t.index].join(","),t};