"use strict";import H from"../../parts/Globals.js";import U from"../../parts/Utilities.js";var pick=U.pick,defaultOptions={type:"oscillator",playCallbackInterval:20,oscillator:{waveformShape:"sine"}};function Instrument(t){this.init(t)}Instrument.prototype.init=function(t){if(this.initAudioContext()){this.options=H.merge(defaultOptions,t),this.id=this.options.id=t&&t.id||H.uniqueKey();var e=H.audioContext;this.gainNode=e.createGain(),this.setGain(0),this.panNode=e.createStereoPanner&&e.createStereoPanner(),this.panNode?(this.setPan(0),this.gainNode.connect(this.panNode),this.panNode.connect(e.destination)):this.gainNode.connect(e.destination),"oscillator"===this.options.type&&this.initOscillator(this.options.oscillator),this.playCallbackTimers=[]}else H.error(29)},Instrument.prototype.copy=function(t){return new Instrument(H.merge(this.options,{id:null},t))},Instrument.prototype.initAudioContext=function(){var t=H.win.AudioContext||H.win.webkitAudioContext,e=!!H.audioContext;return!!t&&(H.audioContext=H.audioContext||new t,!e&&H.audioContext&&"running"===H.audioContext.state&&H.audioContext.suspend(),!!(H.audioContext&&H.audioContext.createOscillator&&H.audioContext.createGain))},Instrument.prototype.initOscillator=function(t){var e=H.audioContext;this.oscillator=e.createOscillator(),this.oscillator.type=t.waveformShape,this.oscillator.connect(this.gainNode),this.oscillatorStarted=!1},Instrument.prototype.setPan=function(t){this.panNode&&this.panNode.pan.setValueAtTime(t,H.audioContext.currentTime)},Instrument.prototype.setGain=function(t,e){this.gainNode&&(t>1.2&&(console.warn("Highcharts sonification warning: Volume of instrument set too high."),t=1.2),e?(this.gainNode.gain.setValueAtTime(this.gainNode.gain.value,H.audioContext.currentTime),this.gainNode.gain.linearRampToValueAtTime(t,H.audioContext.currentTime+e/1e3)):this.gainNode.gain.setValueAtTime(t,H.audioContext.currentTime))},Instrument.prototype.cancelGainRamp=function(){this.gainNode&&this.gainNode.gain.cancelScheduledValues(0)},Instrument.prototype.getValidFrequency=function(t,e,i){var o=this.options.allowedFrequencies,n=pick(i,1/0),a=pick(e,-1/0);return o&&o.length?o.reduce(function(e,i){return Math.abs(i-t)<Math.abs(e-t)&&i<n&&i>a?i:e},1/0):t},Instrument.prototype.clearPlayCallbackTimers=function(){this.playCallbackTimers.forEach(function(t){clearInterval(t)}),this.playCallbackTimers=[]},Instrument.prototype.setFrequency=function(t,e){var i=e||{},o=this.getValidFrequency(t,i.min,i.max);"oscillator"===this.options.type&&this.oscillatorPlay(o)},Instrument.prototype.oscillatorPlay=function(t){this.oscillatorStarted||(this.oscillator.start(),this.oscillatorStarted=!0),this.oscillator.frequency.setValueAtTime(t,H.audioContext.currentTime)},Instrument.prototype.preparePlay=function(){this.setGain(.001),"suspended"===H.audioContext.state&&H.audioContext.resume(),this.oscillator&&!this.oscillatorStarted&&(this.oscillator.start(),this.oscillatorStarted=!0)},Instrument.prototype.play=function(t){var e=this,i=t.duration||0,o=function(i,o,n){var a=t.duration,s=0,r=e.options.playCallbackInterval;if("function"==typeof i){var l=setInterval(function(){var t=++s*r/a;t>=1?(e[o](i(1),n),clearInterval(l)):e[o](i(t),n)},r);e.playCallbackTimers.push(l)}else e[o](i,n)};if(e.id){if("suspended"===H.audioContext.state||this.oscillator&&!this.oscillatorStarted)return e.preparePlay(),void setTimeout(function(){e.play(t)},10);e.playCallbackTimers.length&&e.clearPlayCallbackTimers(),e.cancelGainRamp(),e.stopOscillatorTimeout&&(clearTimeout(e.stopOscillatorTimeout),delete e.stopOscillatorTimeout),e.stopTimeout&&(clearTimeout(e.stopTimeout),delete e.stopTimeout,e.stopCallback&&(e._play=e.play,e.play=function(){},e.stopCallback("cancelled"),e.play=e._play));var n=i<H.sonification.fadeOutDuration+20;e.stopCallback=t.onEnd;var a=function(){delete e.stopTimeout,e.stop(n)};i?(e.stopTimeout=setTimeout(a,n?i:i-H.sonification.fadeOutDuration),o(t.frequency,"setFrequency",{minFrequency:t.minFrequency,maxFrequency:t.maxFrequency}),o(pick(t.volume,1),"setGain",4),o(pick(t.pan,0),"setPan")):a()}},Instrument.prototype.mute=function(){this.setGain(1e-4,.8*H.sonification.fadeOutDuration)},Instrument.prototype.stop=function(t,e,i){var o=this,n=function(){o.stopOscillatorTimeout&&delete o.stopOscillatorTimeout;try{o.oscillator.stop()}catch(t){}o.oscillator.disconnect(o.gainNode),o.initOscillator(o.options.oscillator),e&&e(i),o.stopCallback&&o.stopCallback(i)};o.playCallbackTimers.length&&o.clearPlayCallbackTimers(),o.stopTimeout&&clearTimeout(o.stopTimeout),t?(o.setGain(0),n()):(o.mute(),o.stopOscillatorTimeout=setTimeout(n,H.sonification.fadeOutDuration+100))};export default Instrument;