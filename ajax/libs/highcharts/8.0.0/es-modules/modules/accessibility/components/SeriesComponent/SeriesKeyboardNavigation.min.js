"use strict";import H from"../../../../parts/Globals.js";import U from"../../../../parts/Utilities.js";var extend=U.extend,defined=U.defined;import KeyboardNavigationHandler from"../../KeyboardNavigationHandler.js";import EventProvider from"../../utils/EventProvider.js";import ChartUtilities from"../../utils/chartUtilities.js";var getPointFromXY=ChartUtilities.getPointFromXY,getSeriesFromName=ChartUtilities.getSeriesFromName;function getPointIndex(i){var t=i.index,e=i.series.points,n=e.length;if(e[t]===i)return t;for(;n--;)if(e[n]===i)return n}function isSkipSeries(i){var t=i.chart.options.accessibility.keyboardNavigation.seriesNavigation,e=i.options.accessibility||{},n=e.keyboardNavigation;return n&&!1===n.enabled||!1===e.enabled||!1===i.options.enableMouseTracking||!i.visible||t.pointNavigationEnabledThreshold&&t.pointNavigationEnabledThreshold<=i.points.length}function isSkipPoint(i){var t=i.series.chart.options.accessibility;return i.isNull&&t.keyboardNavigation.seriesNavigation.skipNullPoints||!1===i.visible||isSkipSeries(i.series)}function getClosestPoint(i,t,e,n){var o,r,s,h=1/0,a=t.points.length,l=function(i){return!(defined(i.plotX)&&defined(i.plotY))};if(!l(i)){for(;a--;)l(o=t.points[a])||(s=(i.plotX-o.plotX)*(i.plotX-o.plotX)*(e||1)+(i.plotY-o.plotY)*(i.plotY-o.plotY)*(n||1))<h&&(h=s,r=a);return defined(r)?t.points[r]:void 0}}function highlightFirstValidPointInChart(i){return delete i.highlightedPoint,i.series.reduce(function(i,t){return i||t.highlightFirstValidPoint()},!1)}function highlightLastValidPointInChart(i){for(var t=i.series.length,e=!1;t--&&(i.highlightedPoint=i.series[t].points[i.series[t].points.length-1],!(e=i.series[t].highlightFirstValidPoint())););return e}function updateChartFocusAfterDrilling(i){highlightFirstValidPointInChart(i),i.focusElement&&i.focusElement.removeFocusBorder()}function SeriesKeyboardNavigation(i,t){this.keyCodes=t,this.chart=i}H.Series.prototype.keyboardMoveVertical=!0,["column","pie"].forEach(function(i){H.seriesTypes[i]&&(H.seriesTypes[i].prototype.keyboardMoveVertical=!1)}),H.Point.prototype.highlight=function(){var i=this.series.chart;return this.isNull?i.tooltip&&i.tooltip.hide(0):this.onMouseOver(),this.graphic&&i.setFocusToElement(this.graphic),i.highlightedPoint=this,this},H.Chart.prototype.highlightAdjacentPoint=function(i){var t,e,n=this.series,o=this.highlightedPoint,r=o&&getPointIndex(o)||0,s=o&&o.series.points,h=this.series&&this.series[this.series.length-1],a=h&&h.points&&h.points[h.points.length-1];if(!n[0]||!n[0].points)return!1;if(o){if(t=n[o.series.index+(i?1:-1)],!(e=s[r+(i?1:-1)])&&t&&(e=t.points[i?0:t.points.length-1]),!e)return!1}else e=i?n[0].points[0]:a;return isSkipPoint(e)?(isSkipSeries(t=e.series)?this.highlightedPoint=i?t.points[t.points.length-1]:t.points[0]:this.highlightedPoint=e,this.highlightAdjacentPoint(i)):e.highlight()},H.Series.prototype.highlightFirstValidPoint=function(){var i=this.chart.highlightedPoint,t=(i&&i.series)===this?getPointIndex(i):0,e=this.points,n=e.length;if(e&&n){for(var o=t;o<n;++o)if(!isSkipPoint(e[o]))return e[o].highlight();for(var r=t;r>=0;--r)if(!isSkipPoint(e[r]))return e[r].highlight()}return!1},H.Chart.prototype.highlightAdjacentSeries=function(i){var t,e,n=this.highlightedPoint,o=this.series&&this.series[this.series.length-1],r=o&&o.points&&o.points[o.points.length-1];return this.highlightedPoint?!!(t=this.series[n.series.index+(i?-1:1)])&&(!!(e=getClosestPoint(n,t,4))&&(isSkipSeries(t)?(e.highlight(),this.highlightAdjacentSeries(i)||(n.highlight(),!1)):(e.highlight(),e.series.highlightFirstValidPoint()))):(t=i?this.series&&this.series[0]:o,!!(e=i?t&&t.points&&t.points[0]:r)&&e.highlight())},H.Chart.prototype.highlightAdjacentPointVertical=function(i){var t,e=this.highlightedPoint,n=1/0;return!(!defined(e.plotX)||!defined(e.plotY))&&(this.series.forEach(function(o){isSkipSeries(o)||o.points.forEach(function(r){if(defined(r.plotY)&&defined(r.plotX)&&r!==e){var s=r.plotY-e.plotY,h=Math.abs(r.plotX-e.plotX),a=Math.abs(s)*Math.abs(s)+h*h*4;o.yAxis.reversed&&(s*=-1),s<=0&&i||s>=0&&!i||a<5||isSkipPoint(r)||a<n&&(n=a,t=r)}})}),!!t&&t.highlight())},extend(SeriesKeyboardNavigation.prototype,{init:function(){var i=this,t=this.chart,e=this.eventProvider=new EventProvider;e.addEvent(H.Series,"destroy",function(){return i.onSeriesDestroy(this)}),e.addEvent(t,"afterDrilldown",function(){updateChartFocusAfterDrilling(this)}),e.addEvent(t,"drilldown",function(t){var e=t.point,n=e.series;i.lastDrilledDownPoint={x:e.x,y:e.y,seriesName:n?n.name:""}}),e.addEvent(t,"drillupall",function(){setTimeout(function(){i.onDrillupAll()},10)})},onDrillupAll:function(){var i,t=this.lastDrilledDownPoint,e=this.chart,n=t&&getSeriesFromName(e,t.seriesName);t&&n&&defined(t.x)&&defined(t.y)&&(i=getPointFromXY(n,t.x,t.y)),e.container&&e.container.focus(),i&&i.highlight&&i.highlight(),e.focusElement&&e.focusElement.removeFocusBorder()},getKeyboardNavigationHandler:function(){var i=this,t=this.keyCodes,e=this.chart,n=e.inverted;return new KeyboardNavigationHandler(e,{keyCodeMap:[[n?[t.up,t.down]:[t.left,t.right],function(t){return i.onKbdSideways(this,t)}],[n?[t.left,t.right]:[t.up,t.down],function(t){return i.onKbdVertical(this,t)}],[[t.enter,t.space],function(){return e.highlightedPoint&&e.highlightedPoint.firePointEvent("click"),this.response.success}]],init:function(t){return i.onHandlerInit(this,t)},terminate:function(){return i.onHandlerTerminate()}})},onKbdSideways:function(i,t){var e=this.keyCodes,n=t===e.right||t===e.down;return this.attemptHighlightAdjacentPoint(i,n)},onKbdVertical:function(i,t){var e=this.chart,n=this.keyCodes,o=t===n.down||t===n.right,r=e.options.accessibility.keyboardNavigation.seriesNavigation;return r.mode&&"serialize"===r.mode?this.attemptHighlightAdjacentPoint(i,o):(e[e.highlightedPoint&&e.highlightedPoint.series.keyboardMoveVertical?"highlightAdjacentPointVertical":"highlightAdjacentSeries"](o),i.response.success)},onHandlerInit:function(i,t){var e=this.chart;return t>0?highlightFirstValidPointInChart(e):highlightLastValidPointInChart(e),i.response.success},onHandlerTerminate:function(){var i=this.chart;i.tooltip&&i.tooltip.hide(0),delete i.highlightedPoint},attemptHighlightAdjacentPoint:function(i,t){var e=this.chart,n=e.options.accessibility.keyboardNavigation.wrapAround;return e.highlightAdjacentPoint(t)?i.response.success:n?i.init(t?1:-1):i.response[t?"next":"prev"]},onSeriesDestroy:function(i){var t=this.chart;t.highlightedPoint&&t.highlightedPoint.series===i&&(delete t.highlightedPoint,t.focusElement&&t.focusElement.removeFocusBorder())},destroy:function(){this.eventProvider.removeAddedEvents()}});export default SeriesKeyboardNavigation;