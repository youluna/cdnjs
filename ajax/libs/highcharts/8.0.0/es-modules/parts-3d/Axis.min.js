"use strict";import H from"../parts/Globals.js";import U from"../parts/Utilities.js";var extend=U.extend,pick=U.pick,splat=U.splat,wrap=U.wrap;import"../parts/Axis.js";import"../parts/Chart.js";import"../parts/Tick.js";var ZAxis,addEvent=H.addEvent,Axis=H.Axis,Chart=H.Chart,deg2rad=H.deg2rad,merge=H.merge,perspective=H.perspective,perspective3D=H.perspective3D,shapeArea=H.shapeArea,Tick=H.Tick,extendedOptions={labels:{position3d:"offset",skew3d:!1},title:{position3d:null,skew3d:null}};function fix3dPosition(t,i,s){if(!t.chart.is3d()||"colorAxis"===t.coll)return i;var e,o=t.chart,a=deg2rad*o.options.chart.options3d.alpha,r=deg2rad*o.options.chart.options3d.beta,p=pick(s&&t.options.title.position3d,t.options.labels.position3d),x=pick(s&&t.options.title.skew3d,t.options.labels.skew3d),h=o.frame3d,n=o.plotLeft,l=o.plotWidth+n,c=o.plotTop,y=o.plotHeight+c,d=!1,f=0,z=0,u={x:0,y:1,z:0};if(i=t.swapZ({x:i.x,y:i.y,z:0}),t.isZAxis)if(t.opposite){if(null===h.axes.z.top)return{};z=i.y-c,i.x=h.axes.z.top.x,i.y=h.axes.z.top.y,e=h.axes.z.top.xDir,d=!h.top.frontFacing}else{if(null===h.axes.z.bottom)return{};z=i.y-y,i.x=h.axes.z.bottom.x,i.y=h.axes.z.bottom.y,e=h.axes.z.bottom.xDir,d=!h.bottom.frontFacing}else if(t.horiz)if(t.opposite){if(null===h.axes.x.top)return{};z=i.y-c,i.y=h.axes.x.top.y,i.z=h.axes.x.top.z,e=h.axes.x.top.xDir,d=!h.top.frontFacing}else{if(null===h.axes.x.bottom)return{};z=i.y-y,i.y=h.axes.x.bottom.y,i.z=h.axes.x.bottom.z,e=h.axes.x.bottom.xDir,d=!h.bottom.frontFacing}else if(t.opposite){if(null===h.axes.y.right)return{};f=i.x-l,i.x=h.axes.y.right.x,i.z=h.axes.y.right.z,e={x:(e=h.axes.y.right.xDir).z,y:e.y,z:-e.x}}else{if(null===h.axes.y.left)return{};f=i.x-n,i.x=h.axes.y.left.x,i.z=h.axes.y.left.z,e=h.axes.y.left.xDir}if("chart"===p);else if("flap"===p)if(t.horiz){var v=Math.sin(a),b=Math.cos(a);t.opposite&&(v=-v),d&&(v=-v),u={x:e.z*v,y:b,z:-e.x*v}}else e={x:Math.cos(r),y:0,z:Math.sin(r)};else if("ortho"===p)if(t.horiz){var A=Math.sin(a),m=Math.cos(a),g={x:Math.sin(r)*m,y:-A,z:-m*Math.cos(r)};u={x:e.y*g.z-e.z*g.y,y:e.z*g.x-e.x*g.z,z:e.x*g.y-e.y*g.x};var M=1/Math.sqrt(u.x*u.x+u.y*u.y+u.z*u.z);d&&(M=-M),u={x:M*u.x,y:M*u.y,z:M*u.z}}else e={x:Math.cos(r),y:0,z:Math.sin(r)};else t.horiz?u={x:Math.sin(r)*Math.sin(a),y:Math.cos(a),z:-Math.cos(r)*Math.sin(a)}:e={x:Math.cos(r),y:0,z:Math.sin(r)};i.x+=f*e.x+z*u.x,i.y+=f*e.y+z*u.y,i.z+=f*e.z+z*u.z;var k=perspective([i],t.chart)[0];if(x){shapeArea(perspective([i,{x:i.x+e.x,y:i.y+e.y,z:i.z+e.z},{x:i.x+u.x,y:i.y+u.y,z:i.z+u.z}],t.chart))<0&&(e={x:-e.x,y:-e.y,z:-e.z});var w=perspective([{x:i.x,y:i.y,z:i.z},{x:i.x+e.x,y:i.y+e.y,z:i.z+e.z},{x:i.x+u.x,y:i.y+u.y,z:i.z+u.z}],t.chart);k.matrix=[w[1].x-w[0].x,w[1].y-w[0].y,w[2].x-w[0].x,w[2].y-w[0].y,k.x,k.y],k.matrix[4]-=k.x*k.matrix[0]+k.y*k.matrix[2],k.matrix[5]-=k.x*k.matrix[1]+k.y*k.matrix[3]}return k}merge(!0,Axis.prototype.defaultOptions,extendedOptions),addEvent(Axis,"afterSetOptions",function(){var t;this.chart.is3d&&this.chart.is3d()&&"colorAxis"!==this.coll&&((t=this.options).tickWidth=pick(t.tickWidth,0),t.gridLineWidth=pick(t.gridLineWidth,1))}),wrap(Axis.prototype,"getPlotLinePath",function(t){var i=t.apply(this,[].slice.call(arguments,1));if(!this.chart.is3d()||"colorAxis"===this.coll)return i;if(null===i)return i;var s=this.chart,e=s.options.chart.options3d,o=this.isZAxis?s.plotWidth:e.depth,a=s.frame3d,r=[this.swapZ({x:i[1],y:i[2],z:0}),this.swapZ({x:i[1],y:i[2],z:o}),this.swapZ({x:i[4],y:i[5],z:0}),this.swapZ({x:i[4],y:i[5],z:o})],p=[];return this.horiz?this.isZAxis?(a.left.visible&&p.push(r[0],r[2]),a.right.visible&&p.push(r[1],r[3]),a.top.visible&&p.push(r[0],r[1]),a.bottom.visible&&p.push(r[2],r[3])):(a.front.visible&&p.push(r[0],r[2]),a.back.visible&&p.push(r[1],r[3]),a.top.visible&&p.push(r[0],r[1]),a.bottom.visible&&p.push(r[2],r[3])):(a.front.visible&&p.push(r[0],r[2]),a.back.visible&&p.push(r[1],r[3]),a.left.visible&&p.push(r[0],r[1]),a.right.visible&&p.push(r[2],r[3])),p=perspective(p,this.chart,!1),this.chart.renderer.toLineSegments(p)}),wrap(Axis.prototype,"getLinePath",function(t){return this.chart.is3d()&&"colorAxis"!==this.coll?[]:t.apply(this,[].slice.call(arguments,1))}),wrap(Axis.prototype,"getPlotBandPath",function(t){if(!this.chart.is3d()||"colorAxis"===this.coll)return t.apply(this,[].slice.call(arguments,1));var i=arguments,s=i[1],e=i[2],o=[],a=this.getPlotLinePath({value:s}),r=this.getPlotLinePath({value:e});if(a&&r)for(var p=0;p<a.length;p+=6)o.push("M",a[p+1],a[p+2],"L",a[p+4],a[p+5],"L",r[p+4],r[p+5],"L",r[p+1],r[p+2],"Z");return o}),wrap(Tick.prototype,"getMarkPath",function(t){var i=t.apply(this,[].slice.call(arguments,1)),s=[fix3dPosition(this.axis,{x:i[1],y:i[2],z:0}),fix3dPosition(this.axis,{x:i[4],y:i[5],z:0})];return this.axis.chart.renderer.toLineSegments(s)}),addEvent(Tick,"afterGetLabelPosition",function(t){extend(t.pos,fix3dPosition(this.axis,t.pos))}),wrap(Axis.prototype,"getTitlePosition",function(t){return fix3dPosition(this,t.apply(this,[].slice.call(arguments,1)),!0)}),addEvent(Axis,"drawCrosshair",function(t){this.chart.is3d()&&"colorAxis"!==this.coll&&t.point&&(t.point.crosshairPos=this.isXAxis?t.point.axisXpos:this.len-t.point.axisYpos)}),addEvent(Axis,"destroy",function(){["backFrame","bottomFrame","sideFrame"].forEach(function(t){this[t]&&(this[t]=this[t].destroy())},this)}),Chart.prototype.addZAxis=function(t){return new ZAxis(this,t)},Chart.prototype.collectionsWithUpdate.push("zAxis"),Chart.prototype.collectionsWithInit.zAxis=[Chart.prototype.addZAxis],Axis.prototype.swapZ=function(t,i){if(this.isZAxis){var s=i?0:this.chart.plotLeft;return{x:s+t.z,y:t.y,z:t.x-s}}return t},ZAxis=H.ZAxis=function(){this.init.apply(this,arguments)},extend(ZAxis.prototype,Axis.prototype),extend(ZAxis.prototype,{isZAxis:!0,setOptions:function(t){t=merge({offset:0,lineWidth:0},t),Axis.prototype.setOptions.call(this,t),this.coll="zAxis"},setAxisSize:function(){Axis.prototype.setAxisSize.call(this),this.width=this.len=this.chart.options.chart.options3d.depth,this.right=this.chart.chartWidth-this.width-this.left},getSeriesExtremes:function(){var t=this,i=t.chart;t.hasVisibleSeries=!1,t.dataMin=t.dataMax=t.ignoreMinPadding=t.ignoreMaxPadding=null,t.buildStacks&&t.buildStacks(),t.series.forEach(function(s){if(s.visible||!i.options.chart.ignoreHiddenSeries){var e,o=s.options.threshold;t.hasVisibleSeries=!0,t.positiveValuesOnly&&o<=0&&(o=null),(e=s.zData).length&&(t.dataMin=Math.min(pick(t.dataMin,e[0]),Math.min.apply(null,e)),t.dataMax=Math.max(pick(t.dataMax,e[0]),Math.max.apply(null,e)))}})}}),addEvent(Chart,"afterGetAxes",function(){var t=this,i=this.options,s=i.zAxis=splat(i.zAxis||{});t.is3d()&&(this.zAxis=[],s.forEach(function(i,s){i.index=s,i.isX=!0,t.addZAxis(i).setScale()}))}),wrap(Axis.prototype,"getSlotWidth",function(t,i){if(this.chart.is3d()&&i&&i.label&&this.categories&&this.chart.frameShapes){var s,e,o,a=this.chart,r=this.ticks,p=this.gridGroup.element.childNodes[0].getBBox(),x=a.frameShapes.left.getBBox(),h=a.options.chart.options3d,n={x:a.plotWidth/2,y:a.plotHeight/2,z:h.depth/2,vd:pick(h.depth,1)*pick(h.viewDistance,0)},l=i.pos,c=r[l-1],y=r[l+1];return 0!==l&&c&&c.label.xy&&(e=perspective3D({x:c.label.xy.x,y:c.label.xy.y,z:null},n,n.vd)),y&&y.label.xy&&(o=perspective3D({x:y.label.xy.x,y:y.label.xy.y,z:null},n,n.vd)),s={x:i.label.xy.x,y:i.label.xy.y,z:null},s=perspective3D(s,n,n.vd),Math.abs(e?s.x-e.x:o?o.x-s.x:p.x-x.x)}return t.apply(this,[].slice.call(arguments,1))});