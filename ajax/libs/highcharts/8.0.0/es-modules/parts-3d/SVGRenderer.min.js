"use strict";import H from"../parts/Globals.js";import U from"../parts/Utilities.js";var animObject=U.animObject,defined=U.defined,extend=U.extend,objectEach=U.objectEach,pick=U.pick;import"../parts/Color.js";import"../parts/SvgRenderer.js";var dFactor,element3dMethods,cuboidMethods,cos=Math.cos,PI=Math.PI,sin=Math.sin,charts=H.charts,color=H.color,deg2rad=H.deg2rad,merge=H.merge,perspective=H.perspective,SVGElement=H.SVGElement,SVGRenderer=H.SVGRenderer;function curveTo(t,e,r,n,a,i,s,o){var c=[],d=i-a;return i>a&&i-a>Math.PI/2+1e-4?c=(c=c.concat(curveTo(t,e,r,n,a,a+Math.PI/2,s,o))).concat(curveTo(t,e,r,n,a+Math.PI/2,i,s,o)):i<a&&a-i>Math.PI/2+1e-4?c=(c=c.concat(curveTo(t,e,r,n,a,a-Math.PI/2,s,o))).concat(curveTo(t,e,r,n,a-Math.PI/2,i,s,o)):["C",t+r*Math.cos(a)-r*dFactor*d*Math.sin(a)+s,e+n*Math.sin(a)+n*dFactor*d*Math.cos(a)+o,t+r*Math.cos(i)+r*dFactor*d*Math.sin(i)+s,e+n*Math.sin(i)-n*dFactor*d*Math.cos(i)+o,t+r*Math.cos(i)+s,e+n*Math.sin(i)+o]}dFactor=4*(Math.sqrt(2)-1)/3/(PI/2),SVGRenderer.prototype.toLinePath=function(t,e){var r=[];return t.forEach(function(t){r.push("L",t.x,t.y)}),t.length&&(r[0]="M",e&&r.push("Z")),r},SVGRenderer.prototype.toLineSegments=function(t){var e=[],r=!0;return t.forEach(function(t){e.push(r?"M":"L",t.x,t.y),r=!r}),e},SVGRenderer.prototype.face3d=function(t){var e=this,r=this.createElement("path");return r.vertexes=[],r.insidePlotArea=!1,r.enabled=!0,r.attr=function(t){if("object"==typeof t&&(defined(t.enabled)||defined(t.vertexes)||defined(t.insidePlotArea))){this.enabled=pick(t.enabled,this.enabled),this.vertexes=pick(t.vertexes,this.vertexes),this.insidePlotArea=pick(t.insidePlotArea,this.insidePlotArea),delete t.enabled,delete t.vertexes,delete t.insidePlotArea;var r=charts[e.chartIndex],n=perspective(this.vertexes,r,this.insidePlotArea),a=e.toLinePath(n,!0),i=H.shapeArea(n),s=this.enabled&&i>0?"visible":"hidden";t.d=a,t.visibility=s}return SVGElement.prototype.attr.apply(this,arguments)},r.animate=function(t){if("object"==typeof t&&(defined(t.enabled)||defined(t.vertexes)||defined(t.insidePlotArea))){this.enabled=pick(t.enabled,this.enabled),this.vertexes=pick(t.vertexes,this.vertexes),this.insidePlotArea=pick(t.insidePlotArea,this.insidePlotArea),delete t.enabled,delete t.vertexes,delete t.insidePlotArea;var r=charts[e.chartIndex],n=perspective(this.vertexes,r,this.insidePlotArea),a=e.toLinePath(n,!0),i=H.shapeArea(n),s=this.enabled&&i>0?"visible":"hidden";t.d=a,this.attr("visibility",s)}return SVGElement.prototype.animate.apply(this,arguments)},r.attr(t)},SVGRenderer.prototype.polyhedron=function(t){var e=this,r=this.g(),n=r.destroy;return this.styledMode||r.attr({"stroke-linejoin":"round"}),r.faces=[],r.destroy=function(){for(var t=0;t<r.faces.length;t++)r.faces[t].destroy();return n.call(this)},r.attr=function(t,n,a,i){if("object"==typeof t&&defined(t.faces)){for(;r.faces.length>t.faces.length;)r.faces.pop().destroy();for(;r.faces.length<t.faces.length;)r.faces.push(e.face3d().add(r));for(var s=0;s<t.faces.length;s++)e.styledMode&&delete t.faces[s].fill,r.faces[s].attr(t.faces[s],null,a,i);delete t.faces}return SVGElement.prototype.attr.apply(this,arguments)},r.animate=function(t,n,a){if(t&&t.faces){for(;r.faces.length>t.faces.length;)r.faces.pop().destroy();for(;r.faces.length<t.faces.length;)r.faces.push(e.face3d().add(r));for(var i=0;i<t.faces.length;i++)r.faces[i].animate(t.faces[i],n,a);delete t.faces}return SVGElement.prototype.animate.apply(this,arguments)},r.attr(t)},element3dMethods={initArgs:function(t){var e=this,r=e.renderer,n=r[e.pathType+"Path"](t),a=n.zIndexes;e.parts.forEach(function(t){e[t]=r.path(n[t]).attr({class:"highcharts-3d-"+t,zIndex:a[t]||0}).add(e)}),e.attr({"stroke-linejoin":"round",zIndex:a.group}),e.originalDestroy=e.destroy,e.destroy=e.destroyParts},singleSetterForParts:function(t,e,r,n,a,i){var s={},o=[null,null,n||"attr",a,i],c=r&&r.zIndexes;return r?(objectEach(r,function(e,n){s[n]={},s[n][t]=e,c&&(s[n].zIndex=r.zIndexes[n]||0)}),o[1]=s):(s[t]=e,o[0]=s),this.processParts.apply(this,o)},processParts:function(t,e,r,n,a){var i=this;return i.parts.forEach(function(s){e&&(t=pick(e[s],!1)),!1!==t&&i[s][r](t,n,a)}),i},destroyParts:function(){return this.processParts(null,null,"destroy"),this.originalDestroy()}},cuboidMethods=H.merge(element3dMethods,{parts:["front","top","side"],pathType:"cuboid",attr:function(t,e,r,n){if("string"==typeof t&&void 0!==e){var a=t;(t={})[a]=e}return t.shapeArgs||defined(t.x)?this.singleSetterForParts("d",null,this.renderer[this.pathType+"Path"](t.shapeArgs||t)):SVGElement.prototype.attr.call(this,t,void 0,r,n)},animate:function(t,e,r){if(defined(t.x)&&defined(t.y)){var n=this.renderer[this.pathType+"Path"](t);this.singleSetterForParts("d",null,n,"animate",e,r),this.attr({zIndex:n.zIndexes.group})}else SVGElement.prototype.animate.call(this,t,e,r);return this},fillSetter:function(t){return this.singleSetterForParts("fill",null,{front:t,top:color(t).brighten(.1).get(),side:color(t).brighten(-.1).get()}),this.color=this.fill=t,this}}),SVGRenderer.prototype.elements3d={base:element3dMethods,cuboid:cuboidMethods},SVGRenderer.prototype.element3d=function(t,e){var r=this.g();return extend(r,this.elements3d[t]),r.initArgs(e),r},SVGRenderer.prototype.cuboid=function(t){return this.element3d("cuboid",t)},H.SVGRenderer.prototype.cuboidPath=function(t){var e,r,n,a,i,s,o,c,d=t.x,h=t.y,l=t.z,p=t.height,u=t.width,f=t.depth,v=charts[this.chartIndex],y=v.options.chart.options3d.alpha,M=0,P=[{x:d,y:h,z:l},{x:d+u,y:h,z:l},{x:d+u,y:h+p,z:l},{x:d,y:h+p,z:l},{x:d,y:h+p,z:l+f},{x:d+u,y:h+p,z:l+f},{x:d+u,y:h,z:l+f},{x:d,y:h,z:l+f}];function x(t){return P[t]}return P=perspective(P,v,t.insidePlotArea),c=function(t,e){var r=[[],-1];return t=t.map(x),e=e.map(x),H.shapeArea(t)<0?r=[t,0]:H.shapeArea(e)<0&&(r=[e,1]),r},r=(e=c([3,2,1,0],[7,6,5,4]))[0],i=e[1],n=(e=c([1,6,7,0],[4,5,2,3]))[0],s=e[1],a=(e=c([1,2,5,6],[0,7,4,3]))[0],1===(o=e[1])?M+=1e4*(1e3-d):o||(M+=1e4*d),M+=10*(!s||y>=0&&y<=180||y<360&&y>357.5?v.plotHeight-h:10+h),1===i?M+=100*l:i||(M+=100*(1e3-l)),{front:this.toLinePath(r,!0),top:this.toLinePath(n,!0),side:this.toLinePath(a,!0),zIndexes:{group:Math.round(M)},isFront:i,isTop:s}},H.SVGRenderer.prototype.arc3d=function(t){var e=this.g(),r=e.renderer,n=["x","y","r","innerR","start","end"];function a(t){var e,r=!1,a={};for(e in t=merge(t))-1!==n.indexOf(e)&&(a[e]=t[e],delete t[e],r=!0);return!!r&&a}return(t=merge(t)).alpha=(t.alpha||0)*deg2rad,t.beta=(t.beta||0)*deg2rad,e.top=r.path(),e.side1=r.path(),e.side2=r.path(),e.inn=r.path(),e.out=r.path(),e.onAdd=function(){var t=e.parentGroup,r=e.attr("class");e.top.add(e),["out","inn","side1","side2"].forEach(function(n){e[n].attr({class:r+" highcharts-3d-side"}).add(t)})},["addClass","removeClass"].forEach(function(t){e[t]=function(){var r=arguments;["top","out","inn","side1","side2"].forEach(function(n){e[n][t].apply(e[n],r)})}}),e.setPaths=function(t){var r=e.renderer.arc3dPath(t),n=100*r.zTop;e.attribs=t,e.top.attr({d:r.top,zIndex:r.zTop}),e.inn.attr({d:r.inn,zIndex:r.zInn}),e.out.attr({d:r.out,zIndex:r.zOut}),e.side1.attr({d:r.side1,zIndex:r.zSide1}),e.side2.attr({d:r.side2,zIndex:r.zSide2}),e.zIndex=n,e.attr({zIndex:n}),t.center&&(e.top.setRadialReference(t.center),delete t.center)},e.setPaths(t),e.fillSetter=function(t){var e=color(t).brighten(-.1).get();return this.fill=t,this.side1.attr({fill:e}),this.side2.attr({fill:e}),this.inn.attr({fill:e}),this.out.attr({fill:e}),this.top.attr({fill:t}),this},["opacity","translateX","translateY","visibility"].forEach(function(t){e[t+"Setter"]=function(t,r){e[r]=t,["out","inn","side1","side2","top"].forEach(function(n){e[n].attr(r,t)})}}),e.attr=function(t){var r;return"object"==typeof t&&(r=a(t))&&(extend(e.attribs,r),e.setPaths(e.attribs)),SVGElement.prototype.attr.apply(e,arguments)},e.animate=function(t,r,n){var i,s,o,c=this.attribs,d="data-"+Math.random().toString(26).substring(2,9);return delete t.center,delete t.z,delete t.depth,delete t.alpha,delete t.beta,(o=animObject(pick(r,this.renderer.globalAnimation))).duration&&(i=a(t),e[d]=0,t[d]=1,e[d+"Setter"]=H.noop,i&&(s=i,o.step=function(t,e){function r(t){return c[t]+(pick(s[t],c[t])-c[t])*e.pos}e.prop===d&&e.elem.setPaths(merge(c,{x:r("x"),y:r("y"),r:r("r"),innerR:r("innerR"),start:r("start"),end:r("end")}))}),r=o),SVGElement.prototype.animate.call(this,t,r,n)},e.destroy=function(){return this.top.destroy(),this.out.destroy(),this.inn.destroy(),this.side1.destroy(),this.side2.destroy(),SVGElement.prototype.destroy.call(this)},e.hide=function(){this.top.hide(),this.out.hide(),this.inn.hide(),this.side1.hide(),this.side2.hide()},e.show=function(t){this.top.show(t),this.out.show(t),this.inn.show(t),this.side1.show(t),this.side2.show(t)},e},SVGRenderer.prototype.arc3dPath=function(t){var e=t.x,r=t.y,n=t.start,a=t.end-1e-5,i=t.r,s=t.innerR||0,o=t.depth||0,c=t.alpha,d=t.beta,h=Math.cos(n),l=Math.sin(n),p=Math.cos(a),u=Math.sin(a),f=i*Math.cos(d),v=i*Math.cos(c),y=s*Math.cos(d),M=s*Math.cos(c),P=o*Math.sin(d),x=o*Math.sin(c),b=["M",e+f*h,r+v*l];b=(b=(b=(b=b.concat(curveTo(e,r,f,v,n,a,0,0))).concat(["L",e+y*p,r+M*u])).concat(curveTo(e,r,y,M,a,n,0,0))).concat(["Z"]);var g=d>0?Math.PI/2:0,m=c>0?0:Math.PI/2,I=n>-g?n:a>-g?-g:n,S=a<PI-m?a:n<PI-m?PI-m:a,z=2*PI-m,G=["M",e+f*cos(I),r+v*sin(I)];G=G.concat(curveTo(e,r,f,v,I,S,0,0)),a>z&&n<z?G=(G=(G=(G=(G=(G=(G=(G=G.concat(["L",e+f*cos(S)+P,r+v*sin(S)+x])).concat(curveTo(e,r,f,v,S,z,P,x))).concat(["L",e+f*cos(z),r+v*sin(z)])).concat(curveTo(e,r,f,v,z,a,0,0))).concat(["L",e+f*cos(a)+P,r+v*sin(a)+x])).concat(curveTo(e,r,f,v,a,z,P,x))).concat(["L",e+f*cos(z),r+v*sin(z)])).concat(curveTo(e,r,f,v,z,S,0,0)):a>PI-m&&n<PI-m&&(G=(G=(G=(G=G.concat(["L",e+f*Math.cos(S)+P,r+v*Math.sin(S)+x])).concat(curveTo(e,r,f,v,S,a,P,x))).concat(["L",e+f*Math.cos(a),r+v*Math.sin(a)])).concat(curveTo(e,r,f,v,a,S,0,0))),G=(G=(G=G.concat(["L",e+f*Math.cos(S)+P,r+v*Math.sin(S)+x])).concat(curveTo(e,r,f,v,S,I,P,x))).concat(["Z"]);var T=["M",e+y*h,r+M*l];T=(T=(T=(T=T.concat(curveTo(e,r,y,M,n,a,0,0))).concat(["L",e+y*Math.cos(a)+P,r+M*Math.sin(a)+x])).concat(curveTo(e,r,y,M,a,n,P,x))).concat(["Z"]);var A=["M",e+f*h,r+v*l,"L",e+f*h+P,r+v*l+x,"L",e+y*h+P,r+M*l+x,"L",e+y*h,r+M*l,"Z"],E=["M",e+f*p,r+v*u,"L",e+f*p+P,r+v*u+x,"L",e+y*p+P,r+M*u+x,"L",e+y*p,r+M*u,"Z"],L=Math.atan2(x,-P),V=Math.abs(a+L),R=Math.abs(n+L),H=Math.abs((n+a)/2+L);function j(t){return(t%=2*Math.PI)>Math.PI&&(t=2*Math.PI-t),t}V=j(V),R=j(R);var k=1e5*(H=j(H)),F=1e5*R,w=1e5*V;return{top:b,zTop:1e5*Math.PI+1,out:G,zOut:Math.max(k,F,w),inn:T,zInn:Math.max(k,F,w),side1:A,zSide1:.99*w,side2:E,zSide2:.99*F}};