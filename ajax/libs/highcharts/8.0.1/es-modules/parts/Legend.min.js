"use strict";import H from"./Globals.js";import U from"./Utilities.js";var addEvent=U.addEvent,css=U.css,defined=U.defined,discardElement=U.discardElement,find=U.find,fireEvent=U.fireEvent,format=U.format,isNumber=U.isNumber,merge=U.merge,pick=U.pick,relativeLength=U.relativeLength,setAnimation=U.setAnimation,stableSort=U.stableSort,syncTimeout=U.syncTimeout,wrap=U.wrap,isFirefox=H.isFirefox,marginNames=H.marginNames,win=H.win,Legend=function(){function t(t,i){this.allItems=[],this.box=void 0,this.contentGroup=void 0,this.display=!1,this.group=void 0,this.initialItemY=0,this.itemHeight=0,this.itemMarginBottom=0,this.itemMarginTop=0,this.itemX=0,this.itemY=0,this.lastItemY=0,this.lastLineHeight=0,this.legendHeight=0,this.legendWidth=0,this.maxItemWidth=0,this.maxLegendWidth=0,this.offsetWidth=0,this.options={},this.padding=0,this.pages=[],this.proximate=!1,this.scrollGroup=void 0,this.symbolHeight=0,this.symbolWidth=0,this.titleHeight=0,this.totalItemWidth=0,this.widthOption=0,this.chart=t,this.init(t,i)}return t.prototype.init=function(t,i){this.chart=t,this.setOptions(i),i.enabled&&(this.render(),addEvent(this.chart,"endResize",function(){this.legend.positionCheckboxes()}),this.proximate?this.unchartrender=addEvent(this.chart,"render",function(){this.legend.proximatePositions(),this.legend.positionItems()}):this.unchartrender&&this.unchartrender())},t.prototype.setOptions=function(t){var i=pick(t.padding,8);this.options=t,this.chart.styledMode||(this.itemStyle=t.itemStyle,this.itemHiddenStyle=merge(this.itemStyle,t.itemHiddenStyle)),this.itemMarginTop=t.itemMarginTop||0,this.itemMarginBottom=t.itemMarginBottom||0,this.padding=i,this.initialItemY=i-5,this.symbolWidth=pick(t.symbolWidth,16),this.pages=[],this.proximate="proximate"===t.layout&&!this.chart.inverted,this.baseline=void 0},t.prototype.update=function(t,i){var e=this.chart;this.setOptions(merge(!0,this.options,t)),this.destroy(),e.isDirtyLegend=e.isDirtyBox=!0,pick(i,!0)&&e.redraw(),fireEvent(this,"afterUpdate")},t.prototype.colorizeItem=function(t,i){if(t.legendGroup[i?"removeClass":"addClass"]("highcharts-legend-item-hidden"),!this.chart.styledMode){var e=this.options,s=t.legendItem,h=t.legendLine,o=t.legendSymbol,n=this.itemHiddenStyle.color,r=i?e.itemStyle.color:n,a=i&&t.color||n,l=t.options&&t.options.marker,d={fill:a};s&&s.css({fill:r,color:r}),h&&h.attr({stroke:a}),o&&(l&&o.isMarker&&(d=t.pointAttribs(),i||(d.stroke=d.fill=n)),o.attr(d))}fireEvent(this,"afterColorizeItem",{item:t,visible:i})},t.prototype.positionItems=function(){this.allItems.forEach(this.positionItem,this),this.chart.isResizing||this.positionCheckboxes()},t.prototype.positionItem=function(t){var i=this.options,e=i.symbolPadding,s=!i.rtl,h=t._legendItemPos,o=h[0],n=h[1],r=t.checkbox,a=t.legendGroup;a&&a.element&&a[defined(a.translateY)?"animate":"attr"]({translateX:s?o:this.legendWidth-o-2*e-4,translateY:n}),r&&(r.x=o,r.y=n)},t.prototype.destroyItem=function(t){var i=t.checkbox;["legendItem","legendLine","legendSymbol","legendGroup"].forEach(function(i){t[i]&&(t[i]=t[i].destroy())}),i&&discardElement(t.checkbox)},t.prototype.destroy=function(){function t(t){this[t]&&(this[t]=this[t].destroy())}this.getAllItems().forEach(function(i){["legendItem","legendGroup"].forEach(t,i)}),["clipRect","up","down","pager","nav","box","title","group"].forEach(t,this),this.display=null},t.prototype.positionCheckboxes=function(){var t,i=this.group&&this.group.alignAttr,e=this.clipHeight||this.legendHeight,s=this.titleHeight;i&&(t=i.translateY,this.allItems.forEach(function(h){var o,n=h.checkbox;n&&(o=t+s+n.y+(this.scrollOffset||0)+3,css(n,{left:i.translateX+h.checkboxOffset+n.x-20+"px",top:o+"px",display:this.proximate||o>t-6&&o<t+e-6?"":"none"}))},this))},t.prototype.renderTitle=function(){var t,i=this.options,e=this.padding,s=i.title,h=0;s.text&&(this.title||(this.title=this.chart.renderer.label(s.text,e-3,e-4,null,null,null,i.useHTML,null,"legend-title").attr({zIndex:1}),this.chart.styledMode||this.title.css(s.style),this.title.add(this.group)),s.width||this.title.css({width:this.maxLegendWidth+"px"}),h=(t=this.title.getBBox()).height,this.offsetWidth=t.width,this.contentGroup.attr({translateY:h})),this.titleHeight=h},t.prototype.setText=function(t){var i=this.options;t.legendItem.attr({text:i.labelFormat?format(i.labelFormat,t,this.chart):i.labelFormatter.call(t)})},t.prototype.renderItem=function(t){var i,e=this.chart,s=e.renderer,h=this.options,o="horizontal"===h.layout,n=this.symbolWidth,r=h.symbolPadding,a=this.itemStyle,l=this.itemHiddenStyle,d=o?pick(h.itemDistance,20):0,c=!h.rtl,g=t.legendItem,p=!t.series,m=!p&&t.series.drawLegendSymbol?t.series:t,f=m.options,u=this.createCheckboxForItem&&f&&f.showCheckbox,y=n+r+d+(u?20:0),x=h.useHTML,v=t.options.className;g||(t.legendGroup=s.g("legend-item").addClass("highcharts-"+m.type+"-series highcharts-color-"+t.colorIndex+(v?" "+v:"")+(p?" highcharts-series-"+t.index:"")).attr({zIndex:1}).add(this.scrollGroup),t.legendItem=g=s.text("",c?n+r:-r,this.baseline||0,x),e.styledMode||g.css(merge(t.visible?a:l)),g.attr({align:c?"left":"right",zIndex:2}).add(t.legendGroup),this.baseline||(this.fontMetrics=s.fontMetrics(e.styledMode?12:a.fontSize,g),this.baseline=this.fontMetrics.f+3+this.itemMarginTop,g.attr("y",this.baseline)),this.symbolHeight=h.symbolHeight||this.fontMetrics.f,m.drawLegendSymbol(this,t),this.setItemEvents&&this.setItemEvents(t,g,x)),u&&!t.checkbox&&this.createCheckboxForItem&&this.createCheckboxForItem(t),this.colorizeItem(t,t.visible),!e.styledMode&&a.width||g.css({width:(h.itemWidth||this.widthOption||e.spacingBox.width)-y}),this.setText(t),i=g.getBBox(),t.itemWidth=t.checkboxOffset=h.itemWidth||t.legendItemWidth||i.width+y,this.maxItemWidth=Math.max(this.maxItemWidth,t.itemWidth),this.totalItemWidth+=t.itemWidth,this.itemHeight=t.itemHeight=Math.round(t.legendItemHeight||i.height||this.symbolHeight)},t.prototype.layoutItem=function(t){var i=this.options,e=this.padding,s="horizontal"===i.layout,h=t.itemHeight,o=this.itemMarginBottom,n=this.itemMarginTop,r=s?pick(i.itemDistance,20):0,a=this.maxLegendWidth,l=i.alignColumns&&this.totalItemWidth>a?this.maxItemWidth:t.itemWidth;s&&this.itemX-e+l>a&&(this.itemX=e,this.lastLineHeight&&(this.itemY+=n+this.lastLineHeight+o),this.lastLineHeight=0),this.lastItemY=n+this.itemY+o,this.lastLineHeight=Math.max(h,this.lastLineHeight),t._legendItemPos=[this.itemX,this.itemY],s?this.itemX+=l:(this.itemY+=n+h+o,this.lastLineHeight=h),this.offsetWidth=this.widthOption||Math.max((s?this.itemX-e-(t.checkbox?0:r):l)+e,this.offsetWidth)},t.prototype.getAllItems=function(){var t=[];return this.chart.series.forEach(function(i){var e=i&&i.options;i&&pick(e.showInLegend,!defined(e.linkedTo)&&void 0,!0)&&(t=t.concat(i.legendItems||("point"===e.legendType?i.data:i)))}),fireEvent(this,"afterGetAllItems",{allItems:t}),t},t.prototype.getAlignment=function(){var t=this.options;return this.proximate?t.align.charAt(0)+"tv":t.floating?"":t.align.charAt(0)+t.verticalAlign.charAt(0)+t.layout.charAt(0)},t.prototype.adjustMargins=function(t,i){var e=this.chart,s=this.options,h=this.getAlignment();h&&[/(lth|ct|rth)/,/(rtv|rm|rbv)/,/(rbh|cb|lbh)/,/(lbv|lm|ltv)/].forEach(function(o,n){o.test(h)&&!defined(t[n])&&(e[marginNames[n]]=Math.max(e[marginNames[n]],e.legend[(n+1)%2?"legendHeight":"legendWidth"]+[1,-1,-1,1][n]*s[n%2?"x":"y"]+pick(s.margin,12)+i[n]+(e.titleOffset[n]||0)))})},t.prototype.proximatePositions=function(){var t=this.chart,i=[],e="left"===this.options.align;this.allItems.forEach(function(s){var h,o,n,r,a=e;s.yAxis&&s.points&&(s.xAxis.options.reversed&&(a=!a),h=find(a?s.points:s.points.slice(0).reverse(),function(t){return isNumber(t.plotY)}),o=this.itemMarginTop+s.legendItem.getBBox().height+this.itemMarginBottom,r=s.yAxis.top-t.plotTop,s.visible?(n=h?h.plotY:s.yAxis.height,n+=r-.3*o):n=r+s.yAxis.height,i.push({target:n,size:o,item:s}))},this),H.distribute(i,t.plotHeight),i.forEach(function(i){i.item._legendItemPos[1]=t.plotTop-t.spacing[0]+i.pos})},t.prototype.render=function(){var t,i,e,s,h,o=this.chart,n=o.renderer,r=this.group,a=this.box,l=this.options,d=this.padding;if(this.itemX=d,this.itemY=this.initialItemY,this.offsetWidth=0,this.lastItemY=0,this.widthOption=relativeLength(l.width,o.spacingBox.width-d),h=o.spacingBox.width-2*d-l.x,["rm","lm"].indexOf(this.getAlignment().substring(0,2))>-1&&(h/=2),this.maxLegendWidth=this.widthOption||h,r||(this.group=r=n.g("legend").attr({zIndex:7}).add(),this.contentGroup=n.g().attr({zIndex:1}).add(r),this.scrollGroup=n.g().add(this.contentGroup)),this.renderTitle(),t=this.getAllItems(),stableSort(t,function(t,i){return(t.options&&t.options.legendIndex||0)-(i.options&&i.options.legendIndex||0)}),l.reversed&&t.reverse(),this.allItems=t,this.display=i=!!t.length,this.lastLineHeight=0,this.maxItemWidth=0,this.totalItemWidth=0,this.itemHeight=0,t.forEach(this.renderItem,this),t.forEach(this.layoutItem,this),e=(this.widthOption||this.offsetWidth)+d,s=this.lastItemY+this.lastLineHeight+this.titleHeight,s=this.handleOverflow(s),s+=d,a||(this.box=a=n.rect().addClass("highcharts-legend-box").attr({r:l.borderRadius}).add(r),a.isNew=!0),o.styledMode||a.attr({stroke:l.borderColor,"stroke-width":l.borderWidth||0,fill:l.backgroundColor||"none"}).shadow(l.shadow),e>0&&s>0&&(a[a.isNew?"attr":"animate"](a.crisp.call({},{x:0,y:0,width:e,height:s},a.strokeWidth())),a.isNew=!1),a[i?"show":"hide"](),o.styledMode&&"none"===r.getStyle("display")&&(e=s=0),this.legendWidth=e,this.legendHeight=s,i){var c=o.spacingBox,g=c.y;/(lth|ct|rth)/.test(this.getAlignment())&&o.titleOffset[0]>0?g+=o.titleOffset[0]:/(lbh|cb|rbh)/.test(this.getAlignment())&&o.titleOffset[2]>0&&(g-=o.titleOffset[2]),g!==c.y&&(c=merge(c,{y:g})),r.align(merge(l,{width:e,height:s,verticalAlign:this.proximate?"top":l.verticalAlign}),!0,c)}this.proximate||this.positionItems(),fireEvent(this,"afterRender")},t.prototype.handleOverflow=function(t){var i,e,s=this,h=this.chart,o=h.renderer,n=this.options,r=n.y,a="top"===n.verticalAlign,l=this.padding,d=h.spacingBox.height+(a?-r:r)-l,c=n.maxHeight,g=this.clipRect,p=n.navigation,m=pick(p.animation,!0),f=p.arrowSize||12,u=this.nav,y=this.pages,x=this.allItems,v=function(t){"number"==typeof t?g.attr({height:t}):g&&(s.clipRect=g.destroy(),s.contentGroup.clip()),s.contentGroup.div&&(s.contentGroup.div.style.clip=t?"rect("+l+"px,9999px,"+(l+t)+"px,0)":"auto")},b=function(t){return s[t]=o.circle(0,0,1.3*f).translate(f/2,f/2).add(u),h.styledMode||s[t].attr("fill","rgba(0,0,0,0.0001)"),s[t]};return"horizontal"!==n.layout||"middle"===n.verticalAlign||n.floating||(d/=2),c&&(d=Math.min(d,c)),y.length=0,t>d&&!1!==p.enabled?(this.clipHeight=i=Math.max(d-20-this.titleHeight-l,0),this.currentPage=pick(this.currentPage,1),this.fullHeight=t,x.forEach(function(t,s){var h=t._legendItemPos[1],o=Math.round(t.legendItem.getBBox().height),n=y.length;(!n||h-y[n-1]>i&&(e||h)!==y[n-1])&&(y.push(e||h),n++),t.pageIx=n-1,e&&(x[s-1].pageIx=n-1),s===x.length-1&&h+o-y[n-1]>i&&h!==e&&(y.push(h),t.pageIx=n),h!==e&&(e=h)}),g||(g=s.clipRect=o.clipRect(0,l,9999,0),s.contentGroup.clip(g)),v(i),u||(this.nav=u=o.g().attr({zIndex:1}).add(this.group),this.up=o.symbol("triangle",0,0,f,f).add(u),b("upTracker").on("click",function(){s.scroll(-1,m)}),this.pager=o.text("",15,10).addClass("highcharts-legend-navigation"),h.styledMode||this.pager.css(p.style),this.pager.add(u),this.down=o.symbol("triangle-down",0,0,f,f).add(u),b("downTracker").on("click",function(){s.scroll(1,m)})),s.scroll(0),t=d):u&&(v(),this.nav=u.destroy(),this.scrollGroup.attr({translateY:1}),this.clipHeight=0),t},t.prototype.scroll=function(t,i){var e=this,s=this.chart,h=this.pages,o=h.length,n=this.currentPage+t,r=this.clipHeight,a=this.options.navigation,l=this.pager,d=this.padding;if(n>o&&(n=o),n>0){void 0!==i&&setAnimation(i,s),this.nav.attr({translateX:d,translateY:r+this.padding+7+this.titleHeight,visibility:"visible"}),[this.up,this.upTracker].forEach(function(t){t.attr({class:1===n?"highcharts-legend-nav-inactive":"highcharts-legend-nav-active"})}),l.attr({text:n+"/"+o}),[this.down,this.downTracker].forEach(function(t){t.attr({x:18+this.pager.getBBox().width,class:n===o?"highcharts-legend-nav-inactive":"highcharts-legend-nav-active"})},this),s.styledMode||(this.up.attr({fill:1===n?a.inactiveColor:a.activeColor}),this.upTracker.css({cursor:1===n?"default":"pointer"}),this.down.attr({fill:n===o?a.inactiveColor:a.activeColor}),this.downTracker.css({cursor:n===o?"default":"pointer"})),this.scrollOffset=-h[n-1]+this.initialItemY,this.scrollGroup.animate({translateY:this.scrollOffset}),this.currentPage=n,this.positionCheckboxes();var c=H.animObject(pick(i,s.renderer.globalAnimation,!0));syncTimeout(function(){fireEvent(e,"afterScroll",{currentPage:n})},c.duration||0)}},t}();(/Trident\/7\.0/.test(win.navigator&&win.navigator.userAgent)||isFirefox)&&wrap(Legend.prototype,"positionItem",function(t,i){var e=this,s=function(){i._legendItemPos&&t.call(e,i)};s(),e.bubbleLegend||setTimeout(s)}),H.Legend=Legend;export default H.Legend;