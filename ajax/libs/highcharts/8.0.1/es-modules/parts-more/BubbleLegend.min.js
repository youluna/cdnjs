"use strict";import H from"../parts/Globals.js";import Color from"../parts/Color.js";var color=Color.parse;import Legend from"../parts/Legend.js";import U from"../parts/Utilities.js";var addEvent=U.addEvent,arrayMax=U.arrayMax,arrayMin=U.arrayMin,isNumber=U.isNumber,merge=U.merge,objectEach=U.objectEach,pick=U.pick,stableSort=U.stableSort,wrap=U.wrap,Series=H.Series,Chart=H.Chart,noop=H.noop,setOptions=H.setOptions;setOptions({legend:{bubbleLegend:{borderColor:void 0,borderWidth:2,className:void 0,color:void 0,connectorClassName:void 0,connectorColor:void 0,connectorDistance:60,connectorWidth:1,enabled:!1,labels:{className:void 0,allowOverlap:!1,format:"",formatter:void 0,align:"right",style:{fontSize:10,color:void 0},x:0,y:0},maxSize:60,minSize:10,legendIndex:0,ranges:{value:void 0,borderColor:void 0,color:void 0,connectorColor:void 0},sizeBy:"area",sizeByAbsoluteValue:!1,zIndex:1,zThreshold:0}}}),H.BubbleLegend=function(e,t){this.init(e,t)},H.BubbleLegend.prototype={init:function(e,t){this.options=e,this.visible=!0,this.chart=t.chart,this.legend=t},setState:noop,addToLegend:function(e){e.splice(this.options.legendIndex,0,this)},drawLegendSymbol:function(e){var t,i,s,n,o=this.chart,r=this.options,a=pick(e.options.itemDistance,20),l=r.ranges,h=r.connectorDistance;this.fontMetrics=o.renderer.fontMetrics(r.labels.style.fontSize.toString()+"px"),l&&l.length&&isNumber(l[0].value)?(stableSort(l,function(e,t){return t.value-e.value}),this.ranges=l,this.setOptions(),this.render(),n=this.getMaxLabelSize(),t=2*(s=this.ranges[0].radius),i=(i=h-s+n.width)>0?i:0,this.maxLabel=n,this.movementX="left"===r.labels.align?i:0,this.legendItemWidth=t+i+a,this.legendItemHeight=t+this.fontMetrics.h/2):e.options.bubbleLegend.autoRanges=!0},setOptions:function(){var e=this.ranges,t=this.options,i=this.chart.series[t.seriesIndex],s=this.legend.baseline,n={"z-index":t.zIndex,"stroke-width":t.borderWidth},o={"z-index":t.zIndex,"stroke-width":t.connectorWidth},r=this.getLabelStyles(),a=i.options.marker.fillOpacity,l=this.chart.styledMode;e.forEach(function(h,d){l||(n.stroke=pick(h.borderColor,t.borderColor,i.color),n.fill=pick(h.color,t.color,1!==a?color(i.color).setOpacity(a).get("rgba"):i.color),o.stroke=pick(h.connectorColor,t.connectorColor,i.color)),e[d].radius=this.getRangeRadius(h.value),e[d]=merge(e[d],{center:e[0].radius-e[d].radius+s}),l||merge(!0,e[d],{bubbleStyle:merge(!1,n),connectorStyle:merge(!1,o),labelStyle:r})},this)},getLabelStyles:function(){var e=this.options,t={},i="left"===e.labels.align,s=this.legend.options.rtl;return objectEach(e.labels.style,function(e,i){"color"!==i&&"fontSize"!==i&&"z-index"!==i&&(t[i]=e)}),merge(!1,t,{"font-size":e.labels.style.fontSize,fill:pick(e.labels.style.color,"#000000"),"z-index":e.zIndex,align:s||i?"right":"left"})},getRangeRadius:function(e){var t=this.options,i=this.options.seriesIndex,s=this.chart.series[i],n=t.ranges[0].value,o=t.ranges[t.ranges.length-1].value,r=t.minSize,a=t.maxSize;return s.getRadius.call(this,o,n,r,a,e)},render:function(){var e=this.chart.renderer,t=this.options.zThreshold;this.symbols||(this.symbols={connectors:[],bubbleItems:[],labels:[]}),this.legendSymbol=e.g("bubble-legend"),this.legendItem=e.g("bubble-legend-item"),this.legendSymbol.translateX=0,this.legendSymbol.translateY=0,this.ranges.forEach(function(e){e.value>=t&&this.renderRange(e)},this),this.legendSymbol.add(this.legendItem),this.legendItem.add(this.legendGroup),this.hideOverlappingLabels()},renderRange:function(e){var t,i,s,n=this.ranges[0],o=this.legend,r=this.options,a=r.labels,l=this.chart.renderer,h=this.symbols,d=h.labels,b=e.center,c=Math.abs(e.radius),g=r.connectorDistance,u=a.align,p=o.options.rtl,m=a.style.fontSize,f=p||"left"===u?-g:g,v=r.borderWidth,S=r.connectorWidth,y=n.radius,x=b-c-v/2+S/2,L=m/2-(this.fontMetrics.h-m)/2,z=(x%1?1:.5)-(S%2?0:.5),I=l.styledMode;"center"===u&&(f=0,r.connectorDistance=0,e.labelStyle.align="center"),i=x+r.labels.y,s=y+f+r.labels.x,h.bubbleItems.push(l.circle(y,b+z,c).attr(I?{}:e.bubbleStyle).addClass((I?"highcharts-color-"+this.options.seriesIndex+" ":"")+"highcharts-bubble-legend-symbol "+(r.className||"")).add(this.legendSymbol)),h.connectors.push(l.path(l.crispLine(["M",y,x,"L",y+f,x],r.connectorWidth)).attr(I?{}:e.connectorStyle).addClass((I?"highcharts-color-"+this.options.seriesIndex+" ":"")+"highcharts-bubble-legend-connectors "+(r.connectorClassName||"")).add(this.legendSymbol)),t=l.text(this.formatLabel(e),s,i+L).attr(I?{}:e.labelStyle).addClass("highcharts-bubble-legend-labels "+(r.labels.className||"")).add(this.legendSymbol),d.push(t),t.placed=!0,t.alignAttr={x:s,y:i+L}},getMaxLabelSize:function(){var e,t;return this.symbols.labels.forEach(function(i){t=i.getBBox(!0),e=e?t.width>e.width?t:e:t}),e||{}},formatLabel:function(e){var t=this.options,i=t.labels.formatter,s=t.labels.format,n=this.chart.numberFormatter;return s?U.format(s,e):i?i.call(e):n(e.value,1)},hideOverlappingLabels:function(){var e=this.chart,t=this.options.labels.allowOverlap,i=this.symbols;!t&&i&&(e.hideOverlappingLabels(i.labels),i.labels.forEach(function(e,t){e.newOpacity?e.newOpacity!==e.oldOpacity&&i.connectors[t].show():i.connectors[t].hide()}))},getRanges:function(){var e,t,i=this.legend.bubbleLegend,s=i.chart.series,n=i.options.ranges,o=Number.MAX_VALUE,r=-Number.MAX_VALUE;return s.forEach(function(e){e.isBubble&&!e.ignoreSeries&&(t=e.zData.filter(isNumber)).length&&(o=pick(e.options.zMin,Math.min(o,Math.max(arrayMin(t),!1===e.options.displayNegative?e.options.zThreshold:-Number.MAX_VALUE))),r=pick(e.options.zMax,Math.max(r,arrayMax(t))))}),e=o===r?[{value:r}]:[{value:o},{value:(o+r)/2},{value:r,autoRanges:!0}],n.length&&n[0].radius&&e.reverse(),e.forEach(function(t,i){n&&n[i]&&(e[i]=merge(!1,n[i],t))}),e},predictBubbleSizes:function(){var e,t=this.chart,i=this.fontMetrics,s=t.legend.options,n=s.floating,o="horizontal"===s.layout,r=o?t.legend.lastLineHeight:0,a=t.plotSizeX,l=t.plotSizeY,h=t.series[this.options.seriesIndex],d=Math.ceil(h.minPxSize),b=Math.ceil(h.maxPxSize),c=h.options.maxSize,g=Math.min(l,a);return n||!/%$/.test(c)?e=b:(c=parseFloat(c),e=(g+r-i.h/2)*c/100/(c/100+1),(o&&l-e>=a||!o&&a-e>=l)&&(e=b)),[d,Math.ceil(e)]},updateRanges:function(e,t){var i=this.legend.options.bubbleLegend;i.minSize=e,i.maxSize=t,i.ranges=this.getRanges()},correctSizes:function(){var e=this.legend,t=this.chart.series[this.options.seriesIndex],i=t.maxPxSize,s=this.options.maxSize;Math.abs(Math.ceil(i)-s)>1&&(this.updateRanges(this.options.minSize,t.maxPxSize),e.render())}},addEvent(Legend,"afterGetAllItems",function(e){var t=this.bubbleLegend,i=this.options,s=i.bubbleLegend,n=this.chart.getVisibleBubbleSeriesIndex();t&&t.ranges&&t.ranges.length&&(s.ranges.length&&(s.autoRanges=!!s.ranges[0].autoRanges),this.destroyItem(t)),n>=0&&i.enabled&&s.enabled&&(s.seriesIndex=n,this.bubbleLegend=new H.BubbleLegend(s,this),this.bubbleLegend.addToLegend(e.allItems))}),Chart.prototype.getVisibleBubbleSeriesIndex=function(){for(var e=this.series,t=0;t<e.length;){if(e[t]&&e[t].isBubble&&e[t].visible&&e[t].zData.length)return t;t++}return-1},Legend.prototype.getLinesHeights=function(){var e,t=this.allItems,i=[],s=t.length,n=0,o=0;for(n=0;n<s;n++)if(t[n].legendItemHeight&&(t[n].itemHeight=t[n].legendItemHeight),t[n]===t[s-1]||t[n+1]&&t[n]._legendItemPos[1]!==t[n+1]._legendItemPos[1]){for(i.push({height:0}),e=i[i.length-1];o<=n;o++)t[o].itemHeight>e.height&&(e.height=t[o].itemHeight);e.step=n}return i},Legend.prototype.retranslateItems=function(e){var t,i,s,n=this.allItems,o=this.options.rtl,r=0;n.forEach(function(n,a){t=n.legendGroup.translateX,i=n._legendItemPos[1],((s=n.movementX)||o&&n.ranges)&&(s=o?t-n.options.maxSize/2:t+s,n.legendGroup.attr({translateX:s})),a>e[r].step&&r++,n.legendGroup.attr({translateY:Math.round(i+e[r].height/2)}),n._legendItemPos[1]=i+e[r].height/2})},addEvent(Series,"legendItemClick",function(){var e,t=this.chart,i=this.visible,s=this.chart.legend;s&&s.bubbleLegend&&(this.visible=!i,this.ignoreSeries=i,e=t.getVisibleBubbleSeriesIndex()>=0,s.bubbleLegend.visible!==e&&(s.update({bubbleLegend:{enabled:e}}),s.bubbleLegend.visible=e),this.visible=i)}),wrap(Chart.prototype,"drawChartBox",function(e,t,i){var s,n,o=this.legend,r=this.getVisibleBubbleSeriesIndex()>=0;o&&o.options.enabled&&o.bubbleLegend&&o.options.bubbleLegend.autoRanges&&r?(s=o.bubbleLegend.options,n=o.bubbleLegend.predictBubbleSizes(),o.bubbleLegend.updateRanges(n[0],n[1]),s.placed||(o.group.placed=!1,o.allItems.forEach(function(e){e.legendGroup.translateY=null})),o.render(),this.getMargins(),this.axes.forEach(function(e){e.visible&&e.render(),s.placed||(e.setScale(),e.updateNames(),objectEach(e.ticks,function(e){e.isNew=!0,e.isNewLabel=!0}))}),s.placed=!0,this.getMargins(),e.call(this,t,i),o.bubbleLegend.correctSizes(),o.retranslateItems(o.getLinesHeights())):(e.call(this,t,i),o&&o.options.enabled&&o.bubbleLegend&&(o.render(),o.retranslateItems(o.getLinesHeights())))});