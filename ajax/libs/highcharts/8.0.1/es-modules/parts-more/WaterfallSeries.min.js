"use strict";import H from"../parts/Globals.js";import Point from"../parts/Point.js";import U from"../parts/Utilities.js";var addEvent=U.addEvent,arrayMax=U.arrayMax,arrayMin=U.arrayMin,correctFloat=U.correctFloat,isNumber=U.isNumber,objectEach=U.objectEach,pick=U.pick,seriesType=U.seriesType;import"../parts/Options.js";import"../parts/Series.js";var Axis=H.Axis,Chart=H.Chart,Series=H.Series,StackItem=H.StackItem,seriesTypes=H.seriesTypes;function ownProp(t,e){return Object.hasOwnProperty.call(t,e)}addEvent(Axis,"afterInit",function(){this.isXAxis||(this.waterfallStacks={changed:!1})}),addEvent(Axis,"afterBuildStacks",function(){this.waterfallStacks.changed=!1,delete this.waterfallStacks.alreadyChanged}),addEvent(Chart,"beforeRedraw",function(){for(var t=this.axes,e=this.series,a=e.length;a--;)e[a].options.stacking&&(t.forEach(function(t){t.isXAxis||(t.waterfallStacks.changed=!0)}),a=0)}),addEvent(Axis,"afterRender",function(){var t=this.options.stackLabels;t&&t.enabled&&this.waterfallStacks&&this.renderWaterfallStackTotals()}),Axis.prototype.renderWaterfallStackTotals=function(){var t=this.waterfallStacks,e=this.stackTotalGroup,a=new StackItem(this,this.options.stackLabels,!1,0,void 0);this.dummyStackItem=a,objectEach(t,function(t){objectEach(t,function(t){a.total=t.stackTotal,t.label&&(a.label=t.label),StackItem.prototype.render.call(a,e),t.label=a.label,delete a.label})}),a.total=null},seriesType("waterfall","column",{dataLabels:{inside:!0},lineWidth:1,lineColor:"#333333",dashStyle:"Dot",borderColor:"#333333",states:{hover:{lineWidthPlus:0}}},{pointValKey:"y",showLine:!0,generatePoints:function(){var t,e,a,s;for(seriesTypes.column.prototype.generatePoints.apply(this),a=0,e=this.points.length;a<e;a++)t=this.points[a],s=this.processedYData[a],(t.isIntermediateSum||t.isSum)&&(t.y=correctFloat(s))},translate:function(){var t,e,a,s,i,o,r,n,h,l,c,d,p,u,y,g,m,f=this.options,k=this.yAxis,S=pick(f.minPointLength,5),b=S/2,x=f.threshold,P=f.stacking,T=k.waterfallStacks[this.stackKey];for(seriesTypes.column.prototype.translate.apply(this),n=h=x,e=0,t=(a=this.points).length;e<t;e++)s=a[e],r=this.processedYData[e],i=s.shapeArgs,l=[0,r],y=s.y,P?(T&&(d=T[e],"overlap"===P?(u=d.stackState[d.stateIndex--],o=y>=0?u:u-y,ownProp(d,"absolutePos")&&delete d.absolutePos,ownProp(d,"absoluteNeg")&&delete d.absoluteNeg):(y>=0?(u=d.threshold+d.posTotal,d.posTotal-=y,o=u):(u=d.threshold+d.negTotal,d.negTotal-=y,o=u-y),d.posTotal||ownProp(d,"absolutePos")&&(d.posTotal=d.absolutePos,delete d.absolutePos),d.negTotal||ownProp(d,"absoluteNeg")&&(d.negTotal=d.absoluteNeg,delete d.absoluteNeg)),s.isSum||(d.connectorThreshold=d.threshold+d.stackTotal),k.reversed?(g=y>=0?o-y:o+y,m=o):(g=o,m=o-y),s.below=g<=pick(x,0),i.y=k.translate(g,0,1,0,1),i.height=Math.abs(i.y-k.translate(m,0,1,0,1))),(p=k.dummyStackItem)&&(p.x=e,p.label=T[e].label,p.setOffset(this.pointXOffset||0,this.barW||0,this.stackedYNeg[e],this.stackedYPos[e]))):(o=Math.max(n,n+y)+l[0],i.y=k.translate(o,0,1,0,1),s.isSum?(i.y=k.translate(l[1],0,1,0,1),i.height=Math.min(k.translate(l[0],0,1,0,1),k.len)-i.y):s.isIntermediateSum?(y>=0?(g=l[1]+h,m=h):(g=h,m=l[1]+h),k.reversed&&(g^=m,g^=m^=g),i.y=k.translate(g,0,1,0,1),i.height=Math.abs(i.y-Math.min(k.translate(m,0,1,0,1),k.len)),h+=l[1]):(i.height=r>0?k.translate(n,0,1,0,1)-i.y:k.translate(n,0,1,0,1)-k.translate(n-r,0,1,0,1),n+=r,s.below=n<pick(x,0)),i.height<0&&(i.y+=i.height,i.height*=-1)),s.plotY=i.y=Math.round(i.y)-this.borderWidth%2/2,i.height=Math.max(Math.round(i.height),.001),s.yBottom=i.y+i.height,i.height<=S&&!s.isNull?(i.height=S,i.y-=b,s.plotY=i.y,s.y<0?s.minPointLengthOffset=-b:s.minPointLengthOffset=b):(s.isNull&&(i.width=0),s.minPointLengthOffset=0),c=s.plotY+(s.negative?i.height:0),this.chart.inverted?s.tooltipPos[0]=k.len-c:s.tooltipPos[1]=c},processData:function(t){var e,a,s,i,o,r,n,h=this.options,l=this.yData,c=h.data,d=l.length,p=h.threshold||0;for(s=a=i=o=0,n=0;n<d;n++)r=l[n],e=c&&c[n]?c[n]:{},"sum"===r||e.isSum?l[n]=correctFloat(s):"intermediateSum"===r||e.isIntermediateSum?(l[n]=correctFloat(a),a=0):(s+=r,a+=r),i=Math.min(s,i),o=Math.max(s,o);Series.prototype.processData.call(this,t),h.stacking||(this.dataMin=i+p,this.dataMax=o)},toYData:function(t){return t.isSum?"sum":t.isIntermediateSum?"intermediateSum":t.y},updateParallelArrays:function(t,e){Series.prototype.updateParallelArrays.call(this,t,e),"sum"!==this.yData[0]&&"intermediateSum"!==this.yData[0]||(this.yData[0]=null)},pointAttribs:function(t,e){var a,s=this.options.upColor;return s&&!t.options.color&&(t.color=t.y>0?s:null),delete(a=seriesTypes.column.prototype.pointAttribs.call(this,t,e)).dashstyle,a},getGraphPath:function(){return["M",0,0]},getCrispPath:function(){var t,e,a,s,i,o,r,n,h,l,c=this.data,d=this.yAxis,p=c.length,u=Math.round(this.graph.strokeWidth())%2/2,y=Math.round(this.borderWidth)%2/2,g=this.xAxis.reversed,m=this.yAxis.reversed,f=this.options.stacking,k=[];for(h=1;h<p;h++)n=c[h].shapeArgs,s=c[h-1],r=c[h-1].shapeArgs,e=d.waterfallStacks[this.stackKey],o=s.y>0?-r.height:0,e&&(a=e[h-1],f?(t=a.connectorThreshold,i=Math.round(d.translate(t,0,1,0,1)+(m?o:0))-u):i=r.y+s.minPointLengthOffset+y-u,l=["M",r.x+(g?0:r.width),i,"L",n.x+(g?n.width:0),i]),(!f&&l&&s.y<0&&!m||s.y>0&&m)&&(l[2]+=r.height,l[5]+=r.height),k=k.concat(l);return k},drawGraph:function(){Series.prototype.drawGraph.call(this),this.graph.attr({d:this.getCrispPath()})},setStackedPoints:function(){var t,e,a,s,i,o,r,n,h,l,c,d,p,u=this.options,y=this.yAxis.waterfallStacks,g=u.threshold,m=g||0,f=m,k=this.stackKey,S=this.xData,b=S.length;function x(t,a,s,i){if(o)for(;s<o;s++)e.stackState[s]+=i;else e.stackState[0]=t,o=e.stackState.length;e.stackState.push(e.stackState[o-1]+a)}if(this.yAxis.usePercentage=!1,a=s=i=m,this.visible||!this.chart.options.chart.ignoreHiddenSeries){p=y.changed,(d=y.alreadyChanged)&&d.indexOf(k)<0&&(p=!0),y[k]||(y[k]={}),t=y[k];for(var P=0;P<b;P++)t[c=S[P]]&&!p||(t[c]={negTotal:0,posTotal:0,stackTotal:0,threshold:0,stateIndex:0,stackState:[],label:p&&t[c]?t[c].label:void 0}),e=t[c],(l=this.yData[P])>=0?e.posTotal+=l:e.negTotal+=l,h=u.data[P],r=e.absolutePos=e.posTotal,n=e.absoluteNeg=e.negTotal,e.stackTotal=r+n,o=e.stackState.length,h&&h.isIntermediateSum?(x(i,s,0,i),i=s,s=g,m^=f,m^=f^=m):h&&h.isSum?(x(g,a,o),m=g):(x(m,l,0,a),h&&(a+=l,s+=l)),e.stateIndex++,e.threshold=m,m+=e.stackTotal;y.changed=!1,y.alreadyChanged||(y.alreadyChanged=[]),y.alreadyChanged.push(k)}},getExtremes:function(){var t,e,a,s=this.options.stacking;s&&(t=this.yAxis.waterfallStacks,e=this.stackedYNeg=[],a=this.stackedYPos=[],objectEach(t[this.stackKey],"overlap"===s?function(t){e.push(arrayMin(t.stackState)),a.push(arrayMax(t.stackState))}:function(t){e.push(t.negTotal+t.threshold),a.push(t.posTotal+t.threshold)}),this.dataMin=arrayMin(e),this.dataMax=arrayMax(a))}},{getClassName:function(){var t=Point.prototype.getClassName.call(this);return this.isSum?t+=" highcharts-sum":this.isIntermediateSum&&(t+=" highcharts-intermediate-sum"),t},isValid:function(){return isNumber(this.y)||this.isSum||this.isIntermediateSum}});