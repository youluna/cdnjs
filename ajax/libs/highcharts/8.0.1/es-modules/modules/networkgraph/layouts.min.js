"use strict";import H from"../../parts/Globals.js";import U from"../../parts/Utilities.js";var addEvent=U.addEvent,clamp=U.clamp,defined=U.defined,extend=U.extend,isFunction=U.isFunction,pick=U.pick,setAnimation=U.setAnimation;import"./integrations.js";import"./QuadTree.js";var Chart=H.Chart;H.layouts={"reingold-fruchterman":function(){}},extend(H.layouts["reingold-fruchterman"].prototype,{init:function(t){this.options=t,this.nodes=[],this.links=[],this.series=[],this.box={x:0,y:0,width:0,height:0},this.setInitialRendering(!0),this.integration=H.networkgraphIntegrations[t.integration],this.attractiveForce=pick(t.attractiveForce,this.integration.attractiveForceFunction),this.repulsiveForce=pick(t.repulsiveForce,this.integration.repulsiveForceFunction),this.approximation=t.approximation},start:function(){var t=this.series,i=this.options;this.currentStep=0,this.forces=t[0]&&t[0].forces||[],this.initialRendering&&(this.initPositions(),t.forEach(function(t){t.render()})),this.setK(),this.resetSimulation(i),i.enableSimulation&&this.step()},step:function(){var t=this,i=this.series,e=this.options;t.currentStep++,"barnes-hut"===t.approximation&&(t.createQuadTree(),t.quadTree.calculateMassAndCenter()),t.forces.forEach(function(i){t[i+"Forces"](t.temperature)}),t.applyLimits(t.temperature),t.temperature=t.coolDown(t.startTemperature,t.diffTemperature,t.currentStep),t.prevSystemTemperature=t.systemTemperature,t.systemTemperature=t.getSystemTemperature(),e.enableSimulation&&(i.forEach(function(t){t.chart&&t.render()}),t.maxIterations--&&isFinite(t.temperature)&&!t.isStable()?(t.simulation&&H.win.cancelAnimationFrame(t.simulation),t.simulation=H.win.requestAnimationFrame(function(){t.step()})):t.simulation=!1)},stop:function(){this.simulation&&H.win.cancelAnimationFrame(this.simulation)},setArea:function(t,i,e,n){this.box={left:t,top:i,width:e,height:n}},setK:function(){this.k=this.options.linkLength||this.integration.getK(this)},addElementsToCollection:function(t,i){t.forEach(function(t){-1===i.indexOf(t)&&i.push(t)})},removeElementFromCollection:function(t,i){var e=i.indexOf(t);-1!==e&&i.splice(e,1)},clear:function(){this.nodes.length=0,this.links.length=0,this.series.length=0,this.resetSimulation()},resetSimulation:function(){this.forcedStop=!1,this.systemTemperature=0,this.setMaxIterations(),this.setTemperature(),this.setDiffTemperature()},setMaxIterations:function(t){this.maxIterations=pick(t,this.options.maxIterations)},setTemperature:function(){this.temperature=this.startTemperature=Math.sqrt(this.nodes.length)},setDiffTemperature:function(){this.diffTemperature=this.startTemperature/(this.options.maxIterations+1)},setInitialRendering:function(t){this.initialRendering=t},createQuadTree:function(){this.quadTree=new H.QuadTree(this.box.left,this.box.top,this.box.width,this.box.height),this.quadTree.insertNodes(this.nodes)},initPositions:function(){var t=this.options.initialPositions;isFunction(t)?(t.call(this),this.nodes.forEach(function(t){defined(t.prevX)||(t.prevX=t.plotX),defined(t.prevY)||(t.prevY=t.plotY),t.dispX=0,t.dispY=0})):"circle"===t?this.setCircularPositions():this.setRandomPositions()},setCircularPositions:function(){var t=this.box,i=this.nodes,e=i.length+1,n=2*Math.PI/e,o=i.filter(function(t){return 0===t.linksTo.length}),r=[],s={},a=this.options.initialPositionRadius;o.forEach(function(t){r.push(t),function t(i){i.linksFrom.forEach(function(i){s[i.toNode.id]||(s[i.toNode.id]=!0,r.push(i.toNode),t(i.toNode))})}(t)}),r.length?i.forEach(function(t){-1===r.indexOf(t)&&r.push(t)}):r=i,r.forEach(function(i,e){i.plotX=i.prevX=pick(i.plotX,t.width/2+a*Math.cos(e*n)),i.plotY=i.prevY=pick(i.plotY,t.height/2+a*Math.sin(e*n)),i.dispX=0,i.dispY=0})},setRandomPositions:function(){var t=this.box,i=this.nodes,e=i.length+1;function n(t){var i=t*t/Math.PI;return i-=Math.floor(i)}i.forEach(function(i,o){i.plotX=i.prevX=pick(i.plotX,t.width*n(o)),i.plotY=i.prevY=pick(i.plotY,t.height*n(e+o)),i.dispX=0,i.dispY=0})},force:function(t){this.integration[t].apply(this,Array.prototype.slice.call(arguments,1))},barycenterForces:function(){this.getBarycenter(),this.force("barycenter")},getBarycenter:function(){var t=0,i=0,e=0;return this.nodes.forEach(function(n){i+=n.plotX*n.mass,e+=n.plotY*n.mass,t+=n.mass}),this.barycenter={x:i,y:e,xFactor:i/t,yFactor:e/t},this.barycenter},barnesHutApproximation:function(t,i){var e,n,o=this.getDistXY(t,i),r=this.vectorLength(o);return t!==i&&0!==r&&(i.isInternal?i.boxSize/r<this.options.theta&&0!==r?(n=this.repulsiveForce(r,this.k),this.force("repulsive",t,n*i.mass,o,r),e=!1):e=!0:(n=this.repulsiveForce(r,this.k),this.force("repulsive",t,n*i.mass,o,r))),e},repulsiveForces:function(){var t=this;"barnes-hut"===t.approximation?t.nodes.forEach(function(i){t.quadTree.visitNodeRecursive(null,function(e){return t.barnesHutApproximation(i,e)})}):t.nodes.forEach(function(i){t.nodes.forEach(function(e){var n,o,r;i===e||i.fixedPosition||(r=t.getDistXY(i,e),0!==(o=t.vectorLength(r))&&(n=t.repulsiveForce(o,t.k),t.force("repulsive",i,n*e.mass,r,o)))})})},attractiveForces:function(){var t,i,e,n=this;n.links.forEach(function(o){o.fromNode&&o.toNode&&(t=n.getDistXY(o.fromNode,o.toNode),0!==(i=n.vectorLength(t))&&(e=n.attractiveForce(i,n.k),n.force("attractive",o,e,t,i)))})},applyLimits:function(){var t=this;t.nodes.forEach(function(i){i.fixedPosition||(t.integration.integrate(t,i),t.applyLimitBox(i,t.box),i.dispX=0,i.dispY=0)})},applyLimitBox:function(t,i){var e=t.radius;t.plotX=clamp(t.plotX,i.left+e,i.width-e),t.plotY=clamp(t.plotY,i.top+e,i.height-e)},coolDown:function(t,i,e){return t-i*e},isStable:function(){return Math.abs(this.systemTemperature-this.prevSystemTemperature)<1e-5||this.temperature<=0},getSystemTemperature:function(){return this.nodes.reduce(function(t,i){return t+i.temperature},0)},vectorLength:function(t){return Math.sqrt(t.x*t.x+t.y*t.y)},getDistR:function(t,i){var e=this.getDistXY(t,i);return this.vectorLength(e)},getDistXY:function(t,i){var e=t.plotX-i.plotX,n=t.plotY-i.plotY;return{x:e,y:n,absX:Math.abs(e),absY:Math.abs(n)}}}),addEvent(Chart,"predraw",function(){this.graphLayoutsLookup&&this.graphLayoutsLookup.forEach(function(t){t.stop()})}),addEvent(Chart,"render",function(){var t,i=!1;function e(e){e.maxIterations--&&isFinite(e.temperature)&&!e.isStable()&&!e.options.enableSimulation&&(e.beforeStep&&e.beforeStep(),e.step(),t=!1,i=!0)}if(this.graphLayoutsLookup){for(setAnimation(!1,this),this.graphLayoutsLookup.forEach(function(t){t.start()});!t;)t=!0,this.graphLayoutsLookup.forEach(e);i&&this.series.forEach(function(t){t&&t.layout&&t.render()})}});