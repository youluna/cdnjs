"use strict";import H from"../parts/Globals.js";import mixinTreeSeries from"../mixins/tree-series.js";import drawPoint from"../mixins/draw-point.js";import Color from"../parts/Color.js";var color=Color.parse;import LegendSymbolMixin from"../mixins/legend-symbol.js";import Point from"../parts/Point.js";import U from"../parts/Utilities.js";var addEvent=U.addEvent,correctFloat=U.correctFloat,defined=U.defined,error=U.error,extend=U.extend,fireEvent=U.fireEvent,isArray=U.isArray,isNumber=U.isNumber,isObject=U.isObject,isString=U.isString,merge=U.merge,objectEach=U.objectEach,pick=U.pick,seriesType=U.seriesType,stableSort=U.stableSort;import"../parts/Options.js";import"../parts/Series.js";var AXIS_MAX=100,seriesTypes=H.seriesTypes,noop=H.noop,getColor=mixinTreeSeries.getColor,getLevelOptions=mixinTreeSeries.getLevelOptions,isBoolean=function(t){return"boolean"==typeof t},Series=H.Series,eachObject=function(t,e,i){i=i||this,objectEach(t,function(o,r){e.call(i,o,r,t)})},recursive=function(t,e,i){var o;i=i||this,!1!==(o=e.call(i,t))&&recursive(o,e,i)},updateRootId=mixinTreeSeries.updateRootId,treemapAxisDefaultValues=!1;seriesType("treemap","scatter",{allowTraversingTree:!1,animationLimit:250,showInLegend:!1,marker:!1,colorByPoint:!1,dataLabels:{defer:!1,enabled:!0,formatter:function(){var t=this&&this.point?this.point:{};return isString(t.name)?t.name:""},inside:!0,verticalAlign:"middle"},tooltip:{headerFormat:"",pointFormat:"<b>{point.name}</b>: {point.value}<br/>"},ignoreHiddenPoint:!0,layoutAlgorithm:"sliceAndDice",layoutStartingDirection:"vertical",alternateStartingDirection:!1,levelIsConstant:!0,drillUpButton:{position:{align:"right",x:-10,y:10}},traverseUpButton:{position:{align:"right",x:-10,y:10}},borderColor:"#e6e6e6",borderWidth:1,colorKey:"colorValue",opacity:.15,states:{hover:{borderColor:"#999999",brightness:seriesTypes.heatmap?0:.1,halo:!1,opacity:.75,shadow:!1}}},{pointArrayMap:["value"],directTouch:!0,optionalAxis:"colorAxis",getSymbol:noop,parallelArrays:["x","y","value","colorValue"],colorKey:"colorValue",trackerGroups:["group","dataLabelsGroup"],getListOfParents:function(t,e){var i=isArray(t)?t:[],o=isArray(e)?e:[],r=i.reduce(function(t,e,i){var o=pick(e.parent,"");return void 0===t[o]&&(t[o]=[]),t[o].push(i),t},{"":[]});return eachObject(r,function(t,e,i){""!==e&&-1===o.indexOf(e)&&(t.forEach(function(t){i[""].push(t)}),delete i[e])}),r},getTree:function(){var t=this.data.map(function(t){return t.id}),e=this.getListOfParents(this.data,t);return this.nodeMap=[],this.buildNode("",-1,0,e,null)},hasData:function(){return!!this.processedXData.length},init:function(t,e){var i=H.colorMapSeriesMixin;i&&(this.colorAttribs=i.colorAttribs),this.eventsToUnbind.push(addEvent(this,"setOptions",function(t){var e=t.userOptions;defined(e.allowDrillToNode)&&!defined(e.allowTraversingTree)&&(e.allowTraversingTree=e.allowDrillToNode,delete e.allowDrillToNode),defined(e.drillUpButton)&&!defined(e.traverseUpButton)&&(e.traverseUpButton=e.drillUpButton,delete e.drillUpButton)})),Series.prototype.init.call(this,t,e),this.options.allowTraversingTree&&this.eventsToUnbind.push(addEvent(this,"click",this.onClickDrillToNode))},buildNode:function(t,e,i,o,r){var n,s,a=this,l=[],h=a.points[e],d=0;return(o[t]||[]).forEach(function(e){s=a.buildNode(a.points[e].id,e,i+1,o,t),d=Math.max(s.height+1,d),l.push(s)}),n={id:t,i:e,children:l,height:d,level:i,parent:r,visible:!1},a.nodeMap[n.id]=n,h&&(h.node=n),n},setTreeValues:function(t){var e,i=this,o=i.options,r=i.rootNode,n=i.nodeMap[r],s=!isBoolean(o.levelIsConstant)||o.levelIsConstant,a=0,l=[],h=i.points[t.i];return t.children.forEach(function(t){t=i.setTreeValues(t),l.push(t),t.ignore||(a+=t.val)}),stableSort(l,function(t,e){return t.sortIndex-e.sortIndex}),e=pick(h&&h.options.value,a),h&&(h.value=e),extend(t,{children:l,childrenTotal:a,ignore:!(pick(h&&h.visible,!0)&&e>0),isLeaf:t.visible&&!a,levelDynamic:t.level-(s?0:n.level),name:pick(h&&h.name,""),sortIndex:pick(h&&h.sortIndex,-e),val:e}),t},calculateChildrenAreas:function(t,e){var i,o,r=this,n=r.options,s=r.mapOptionsToLevel[t.level+1],a=pick(r[s&&s.layoutAlgorithm]&&s.layoutAlgorithm,n.layoutAlgorithm),l=n.alternateStartingDirection;o=t.children.filter(function(t){return!t.ignore}),s&&s.layoutStartingDirection&&(e.direction="vertical"===s.layoutStartingDirection?0:1),i=r[a](e,o),o.forEach(function(t,o){var n=i[o];t.values=merge(n,{val:t.childrenTotal,direction:l?1-e.direction:e.direction}),t.pointValues=merge(n,{x:n.x/r.axisRatio,y:AXIS_MAX-n.y-n.height,width:n.width/r.axisRatio}),t.children.length&&r.calculateChildrenAreas(t,t.values)})},setPointValues:function(){var t=this,e=t.points,i=t.xAxis,o=t.yAxis,r=t.chart.styledMode;e.forEach(function(e){var n=e.node,s=n.pointValues,a=n.visible;if(s&&a){var l=s.height,h=s.width,d=s.x,c=s.y,p=function(e){return r?0:(t.pointAttribs(e)["stroke-width"]||0)%2/2}(e),u=Math.round(i.toPixels(d,!0))-p,v=Math.round(i.toPixels(d+h,!0))-p,g=Math.round(o.toPixels(c,!0))-p,f=Math.round(o.toPixels(c+l,!0))-p;e.shapeArgs={x:Math.min(u,v),y:Math.min(g,f),width:Math.abs(v-u),height:Math.abs(f-g)},e.plotX=e.shapeArgs.x+e.shapeArgs.width/2,e.plotY=e.shapeArgs.y+e.shapeArgs.height/2}else delete e.plotX,delete e.plotY})},setColorRecursive:function(t,e,i,o,r){var n,s,a=this,l=a&&a.chart,h=l&&l.options&&l.options.colors;t&&(n=getColor(t,{colors:h,index:o,mapOptionsToLevel:a.mapOptionsToLevel,parentColor:e,parentColorIndex:i,series:a,siblings:r}),(s=a.points[t.i])&&(s.color=n.color,s.colorIndex=n.colorIndex),(t.children||[]).forEach(function(e,i){a.setColorRecursive(e,n.color,n.colorIndex,i,t.children.length)}))},algorithmGroup:function(t,e,i,o){this.height=t,this.width=e,this.plot=o,this.direction=i,this.startDirection=i,this.total=0,this.nW=0,this.lW=0,this.nH=0,this.lH=0,this.elArr=[],this.lP={total:0,lH:0,nH:0,lW:0,nW:0,nR:0,lR:0,aspectRatio:function(t,e){return Math.max(t/e,e/t)}},this.addElement=function(t){this.lP.total=this.elArr[this.elArr.length-1],this.total=this.total+t,0===this.direction?(this.lW=this.nW,this.lP.lH=this.lP.total/this.lW,this.lP.lR=this.lP.aspectRatio(this.lW,this.lP.lH),this.nW=this.total/this.height,this.lP.nH=this.lP.total/this.nW,this.lP.nR=this.lP.aspectRatio(this.nW,this.lP.nH)):(this.lH=this.nH,this.lP.lW=this.lP.total/this.lH,this.lP.lR=this.lP.aspectRatio(this.lP.lW,this.lH),this.nH=this.total/this.width,this.lP.nW=this.lP.total/this.nH,this.lP.nR=this.lP.aspectRatio(this.lP.nW,this.nH)),this.elArr.push(t)},this.reset=function(){this.nW=0,this.lW=0,this.elArr=[],this.total=0}},algorithmCalcPoints:function(t,e,i,o){var r,n,s,a,l,h=i.lW,d=i.lH,c=i.plot,p=0,u=i.elArr.length-1;e?(h=i.nW,d=i.nH):l=i.elArr[i.elArr.length-1],i.elArr.forEach(function(t){(e||p<u)&&(0===i.direction?(r=c.x,n=c.y,a=t/(s=h)):(r=c.x,n=c.y,s=t/(a=d)),o.push({x:r,y:n,width:s,height:correctFloat(a)}),0===i.direction?c.y=c.y+a:c.x=c.x+s),p+=1}),i.reset(),0===i.direction?i.width=i.width-h:i.height=i.height-d,c.y=c.parent.y+(c.parent.height-i.height),c.x=c.parent.x+(c.parent.width-i.width),t&&(i.direction=1-i.direction),e||i.addElement(l)},algorithmLowAspectRatio:function(t,e,i){var o,r=[],n=this,s={x:e.x,y:e.y,parent:e},a=e.direction,l=0,h=i.length-1,d=new this.algorithmGroup(e.height,e.width,a,s);return i.forEach(function(i){o=e.width*e.height*(i.val/e.val),d.addElement(o),d.lP.nR>d.lP.lR&&n.algorithmCalcPoints(t,!1,d,r,s),l===h&&n.algorithmCalcPoints(t,!0,d,r,s),l+=1}),r},algorithmFill:function(t,e,i){var o,r,n,s,a,l=[],h=e.direction,d=e.x,c=e.y,p=e.width,u=e.height;return i.forEach(function(i){o=e.width*e.height*(i.val/e.val),r=d,n=c,0===h?(p-=s=o/(a=u),d+=s):(u-=a=o/(s=p),c+=a),l.push({x:r,y:n,width:s,height:a}),t&&(h=1-h)}),l},strip:function(t,e){return this.algorithmLowAspectRatio(!1,t,e)},squarified:function(t,e){return this.algorithmLowAspectRatio(!0,t,e)},sliceAndDice:function(t,e){return this.algorithmFill(!0,t,e)},stripes:function(t,e){return this.algorithmFill(!1,t,e)},translate:function(){var t,e,i,o,r,n=this,s=n.options,a=updateRootId(n);Series.prototype.translate.call(n),o=n.tree=n.getTree(),t=n.nodeMap[a],n.renderTraverseUpButton(a),n.mapOptionsToLevel=getLevelOptions({from:t.level+1,levels:s.levels,to:o.height,defaults:{levelIsConstant:n.options.levelIsConstant,colorByPoint:s.colorByPoint}}),""===a||t&&t.children.length||(n.setRootNode("",!1),a=n.rootNode,t=n.nodeMap[a]),recursive(n.nodeMap[n.rootNode],function(t){var e=!1,i=t.parent;return t.visible=!0,(i||""===i)&&(e=n.nodeMap[i]),e}),recursive(n.nodeMap[n.rootNode].children,function(t){var e=!1;return t.forEach(function(t){t.visible=!0,t.children.length&&(e=(e||[]).concat(t.children))}),e}),n.setTreeValues(o),n.axisRatio=n.xAxis.len/n.yAxis.len,n.nodeMap[""].pointValues=e={x:0,y:0,width:AXIS_MAX,height:AXIS_MAX},n.nodeMap[""].values=i=merge(e,{width:e.width*n.axisRatio,direction:"vertical"===s.layoutStartingDirection?0:1,val:o.val}),n.calculateChildrenAreas(o,i),n.colorAxis||s.colorByPoint||n.setColorRecursive(n.tree),s.allowTraversingTree&&(r=t.pointValues,n.xAxis.setExtremes(r.x,r.x+r.width,!1),n.yAxis.setExtremes(r.y,r.y+r.height,!1),n.xAxis.setScale(),n.yAxis.setScale()),n.setPointValues()},drawDataLabels:function(){var t,e,i=this,o=i.mapOptionsToLevel;i.points.filter(function(t){return t.node.visible}).forEach(function(r){e=o[r.node.level],t={style:{}},r.node.isLeaf||(t.enabled=!1),e&&e.dataLabels&&(t=merge(t,e.dataLabels),i._hasPointLabels=!0),r.shapeArgs&&(t.style.width=r.shapeArgs.width,r.dataLabel&&r.dataLabel.css({width:r.shapeArgs.width+"px"})),r.dlOptions=merge(t,r.options.dataLabels)}),Series.prototype.drawDataLabels.call(this)},alignDataLabel:function(t,e,i){var o=i.style;!defined(o.textOverflow)&&e.text&&e.getBBox().width>e.text.textWidth&&e.css({textOverflow:"ellipsis",width:o.width+="px"}),seriesTypes.column.prototype.alignDataLabel.apply(this,arguments),t.dataLabel&&t.dataLabel.attr({zIndex:(t.node.zIndex||0)+1})},pointAttribs:function(t,e){var i,o,r=isObject(this.mapOptionsToLevel)?this.mapOptionsToLevel:{},n=t&&r[t.node.level]||{},s=this.options,a=e&&s.states[e]||{},l=t&&t.getClassName()||"";return i={stroke:t&&t.borderColor||n.borderColor||a.borderColor||s.borderColor,"stroke-width":pick(t&&t.borderWidth,n.borderWidth,a.borderWidth,s.borderWidth),dashstyle:t&&t.borderDashStyle||n.borderDashStyle||a.borderDashStyle||s.borderDashStyle,fill:t&&t.color||this.color},-1!==l.indexOf("highcharts-above-level")?(i.fill="none",i["stroke-width"]=0):-1!==l.indexOf("highcharts-internal-node-interactive")?(o=pick(a.opacity,s.opacity),i.fill=color(i.fill).setOpacity(o).get(),i.cursor="pointer"):-1!==l.indexOf("highcharts-internal-node")?i.fill="none":e&&(i.fill=color(i.fill).brighten(a.brightness).get()),i},drawPoints:function(){var t=this,e=t.chart,i=e.renderer,o=t.points,r=e.styledMode,n=t.options,s=r?{}:n.shadow,a=n.borderRadius,l=e.pointCount<n.animationLimit,h=n.allowTraversingTree;o.forEach(function(e){var o=e.node.levelDynamic,d={},c={},p={},u="level-group-"+o,v=!!e.graphic,g=l&&v,f=e.shapeArgs;e.shouldDraw()&&(a&&(c.r=a),merge(!0,g?d:c,v?f:{},r?{}:t.pointAttribs(e,e.selected&&"select")),t.colorAttribs&&r&&extend(p,t.colorAttribs(e)),t[u]||(t[u]=i.g(u).attr({zIndex:1e3-o}).add(t.group),t[u].survive=!0)),e.draw({animatableAttribs:d,attribs:c,css:p,group:t[u],renderer:i,shadow:s,shapeArgs:f,shapeType:"rect"}),h&&e.graphic&&(e.drillId=n.interactByLeaf?t.drillToByLeaf(e):t.drillToByGroup(e))})},onClickDrillToNode:function(t){var e=t.point,i=e&&e.drillId;isString(i)&&(e.setState(""),this.setRootNode(i,!0,{trigger:"click"}))},drillToByGroup:function(t){var e=!1;return t.node.level-this.nodeMap[this.rootNode].level!=1||t.node.isLeaf||(e=t.id),e},drillToByLeaf:function(t){var e,i=!1;if(t.node.parent!==this.rootNode&&t.node.isLeaf)for(e=t.node;!i;)(e=this.nodeMap[e.parent]).parent===this.rootNode&&(i=e.id);return i},drillUp:function(){var t=this.nodeMap[this.rootNode];t&&isString(t.parent)&&this.setRootNode(t.parent,!0,{trigger:"traverseUpButton"})},drillToNode:function(t,e){error("WARNING: treemap.drillToNode has been renamed to treemap.setRootNode, and will be removed in the next major version."),this.setRootNode(t,e)},setRootNode:function(t,e,i){var o=extend({newRootId:t,previousRootId:this.rootNode,redraw:pick(e,!0),series:this},i);fireEvent(this,"setRootNode",o,function(t){var e=t.series;e.idPreviousRoot=t.previousRootId,e.rootNode=t.newRootId,e.isDirty=!0,t.redraw&&e.chart.redraw()})},renderTraverseUpButton:function(t){var e,i,o=this,r=o.nodeMap[t].name,n=o.options.traverseUpButton,s=pick(n.text,r,"< Back");""===t?o.drillUpButton&&(o.drillUpButton=o.drillUpButton.destroy()):this.drillUpButton?(this.drillUpButton.placed=!1,this.drillUpButton.attr({text:s}).align()):(i=(e=n.theme)&&e.states,this.drillUpButton=this.chart.renderer.button(s,null,null,function(){o.drillUp()},e,i&&i.hover,i&&i.select).addClass("highcharts-drillup-button").attr({align:n.position.align,zIndex:7}).add().align(n.position,!1,n.relativeTo||"plotBox"))},buildKDTree:noop,drawLegendSymbol:LegendSymbolMixin.drawRectangle,getExtremes:function(){Series.prototype.getExtremes.call(this,this.colorValueData),this.valueMin=this.dataMin,this.valueMax=this.dataMax,Series.prototype.getExtremes.call(this)},getExtremesFromAll:!0,setState:function(t){this.options.inactiveOtherPoints=!0,Series.prototype.setState.call(this,t,!1),this.options.inactiveOtherPoints=!1},utils:{recursive:recursive}},{draw:drawPoint,setVisible:seriesTypes.pie.prototype.pointClass.prototype.setVisible,getClassName:function(){var t=Point.prototype.getClassName.call(this),e=this.series,i=e.options;return this.node.level<=e.nodeMap[e.rootNode].level?t+=" highcharts-above-level":this.node.isLeaf||pick(i.interactByLeaf,!i.allowTraversingTree)?this.node.isLeaf||(t+=" highcharts-internal-node"):t+=" highcharts-internal-node-interactive",t},isValid:function(){return this.id||isNumber(this.value)},setState:function(t){Point.prototype.setState.call(this,t),this.graphic&&this.graphic.attr({zIndex:"hover"===t?1:0})},shouldDraw:function(){return isNumber(this.plotY)&&null!==this.y}}),addEvent(H.Series,"afterBindAxes",function(){var t,e=this.xAxis,i=this.yAxis;e&&i&&(this.is("treemap")?(t={endOnTick:!1,gridLineWidth:0,lineWidth:0,min:0,dataMin:0,minPadding:0,max:AXIS_MAX,dataMax:AXIS_MAX,maxPadding:0,startOnTick:!1,title:null,tickPositions:[]},extend(i.options,t),extend(e.options,t),treemapAxisDefaultValues=!0):treemapAxisDefaultValues&&(i.setOptions(i.userOptions),e.setOptions(e.userOptions),treemapAxisDefaultValues=!1))});