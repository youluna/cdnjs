"use strict";import H from"../parts/Globals.js";import Color from"../parts/Color.js";var color=Color.parse;import U from"../parts/Utilities.js";var addEvent=U.addEvent,extend=U.extend,fireEvent=U.fireEvent,isNumber=U.isNumber,merge=U.merge,pick=U.pick,wrap=U.wrap;import"../parts/Series.js";import"../parts/Options.js";var destroyLoadingDiv,win=H.win,doc=win.document,noop=function(){},Series=H.Series,seriesTypes=H.seriesTypes,CHUNK_SIZE=5e4;H.initCanvasBoost=function(){H.seriesTypes.heatmap&&wrap(H.seriesTypes.heatmap.prototype,"drawPoints",function(){var t=this.chart,e=this.getContext(),o=this.chart.inverted,i=this.xAxis,r=this.yAxis;e?(this.points.forEach(function(s){var a,n,c=s.plotY;void 0===c||isNaN(c)||null===s.y||(a=s.shapeArgs,n=t.styledMode?s.series.colorAttribs(s):s.series.pointAttribs(s),e.fillStyle=n.fill,o?e.fillRect(r.len-a.y+i.left,i.len-a.x+r.top,-a.height,-a.width):e.fillRect(a.x+i.left,a.y+r.top,a.width,a.height))}),this.canvasToSVG()):this.chart.showLoading("Your browser doesn't support HTML5 canvas, <br>please use a modern browser")}),extend(Series.prototype,{getContext:function(){var t,e=this.chart,o=e.chartWidth,i=e.chartHeight,r=e.seriesGroup||this.group,s=this,a=function(t,e,o,i,r,s,a){t.call(this,o,e,i,r,s,a)};return e.isChartSeriesBoosting()&&(s=e,r=e.seriesGroup),t=s.ctx,s.canvas?H.Chart:(s.canvas=doc.createElement("canvas"),s.renderTarget=e.renderer.image("",0,0,o,i).addClass("highcharts-boost-canvas").add(r),s.ctx=t=s.canvas.getContext("2d"),e.inverted&&["moveTo","lineTo","rect","arc"].forEach(function(e){wrap(t,e,a)}),s.boostCopy=function(){s.renderTarget.attr({href:s.canvas.toDataURL("image/png")})},s.boostClear=function(){t.clearRect(0,0,s.canvas.width,s.canvas.height),s===this&&s.renderTarget.attr({href:""})},s.boostClipRect=e.renderer.clipRect(),s.renderTarget.clip(s.boostClipRect)),s.canvas.width!==o&&(s.canvas.width=o),s.canvas.height!==i&&(s.canvas.height=i),s.renderTarget.attr({x:0,y:0,width:o,height:i,style:"pointer-events: none",href:""}),s.boostClipRect.attr(e.getBoostClipRect(s)),t},canvasToSVG:function(){this.chart.isChartSeriesBoosting()?this.boostClear&&this.boostClear():(this.boostCopy||this.chart.boostCopy)&&(this.boostCopy||this.chart.boostCopy)()},cvsLineTo:function(t,e,o){t.lineTo(e,o)},renderCanvas:function(){var t,e,o,i,r,s,a,n,c,l,p=this,h=p.options,d=p.chart,v=this.xAxis,u=this.yAxis,g=d.options.boost||{},y=g.timeRendering||!1,f=(g.timeSeriesProcessing,g.timeSetup,0),m=p.processedXData,b=p.processedYData,C=h.data,T=v.getExtremes(),x=T.min,w=T.max,S=u.getExtremes(),k=S.min,D=S.max,E={},M=!!p.sampling,N=h.marker&&h.marker.radius,P=this.cvsDrawPoint,A=h.lineWidth?this.cvsLineTo:void 0,R=N&&N<=1?this.cvsMarkerSquare:this.cvsMarkerCircle,G=this.cvsStrokeBatch||1e3,L=!1!==h.enableMouseTracking,B=h.threshold,X=u.getThreshold(B),Y=isNumber(B),j=X,O=this.fill,I=p.pointArrayMap&&"low,high"===p.pointArrayMap.join(","),K=!!h.stacking,V=p.cropStart||0,W=d.options.loading,q=p.requireSorting,_=h.connectNulls,Z=!m,z=K?p.data:m||C,J=p.fillOpacity?new Color(p.color).setOpacity(pick(h.fillOpacity,.75)).get():p.color,F=function(){O?(t.fillStyle=J,t.fill()):(t.strokeStyle=p.color,t.lineWidth=h.lineWidth,t.stroke())},Q=function(e,o,s,a){0===f&&(t.beginPath(),A&&(t.lineJoin="round")),d.scroller&&"highcharts-navigator-series"===p.options.className?(o+=d.scroller.top,s&&(s+=d.scroller.top)):o+=d.plotTop,e+=d.plotLeft,r?t.moveTo(e,o):P?P(t,e,o,s,i):A?A(t,e,o):R&&R.call(p,t,e,o,N,a),(f+=1)===G&&(F(),f=0),i={clientX:e,plotY:o,yBottom:s}},$="x"===h.findNearestPointBy,tt=this.xData||this.options.xData||this.processedXData||!1,et=function(t,e,i){l=$?t:t+","+e,L&&!E[l]&&(E[l]=!0,d.inverted&&(t=v.len-t,e=u.len-e),o.push({x:!!tt&&tt[V+i],clientX:t,plotX:t,plotY:e,i:V+i}))};this.renderTarget&&this.renderTarget.attr({href:""}),(this.points||this.graph)&&this.destroyGraphics(),p.plotGroup("group","series",p.visible?"visible":"hidden",h.zIndex,d.seriesGroup),p.markerGroup=p.group,addEvent(p,"destroy",function(){p.markerGroup=null}),o=this.points=[],t=this.getContext(),p.buildKDTree=noop,this.boostClear&&this.boostClear(),this.visible&&(C.length>99999&&(d.options.loading=merge(W,{labelStyle:{backgroundColor:color("#ffffff").setOpacity(.75).get(),padding:"1em",borderRadius:"0.5em"},style:{backgroundColor:"none",opacity:1}}),U.clearTimeout(destroyLoadingDiv),d.showLoading("Drawing..."),d.options.loading=W),y&&console.time("canvas rendering"),H.eachAsync(z,function(t,o){var i,l,h,g,y,f,m=!1,C=!1,T=!1,S=!1,E=void 0===d.index,H=!0;return E||(Z?(i=t[0],l=t[1],z[o+1]&&(T=z[o+1][0]),z[o-1]&&(S=z[o-1][0])):(i=t,l=b[o],z[o+1]&&(T=z[o+1]),z[o-1]&&(S=z[o-1])),T&&T>=x&&T<=w&&(m=!0),S&&S>=x&&S<=w&&(C=!0),I?(Z&&(l=t.slice(1,3)),f=l[0],l=l[1]):K&&(i=t.x,f=(l=t.stackY)-t.y),q||(H=l>=k&&l<=D),!(y=null===l)&&(i>=x&&i<=w&&H||m||C)&&(h=Math.round(v.toPixels(i,!0)),M?(void 0!==n&&h!==e||(I||(f=l),(void 0===c||l>a)&&(a=l,c=o),(void 0===n||f<s)&&(s=f,n=o)),h!==e&&(void 0!==n&&(g=u.toPixels(a,!0),X=u.toPixels(s,!0),Q(h,Y?Math.min(g,j):g,Y?Math.max(X,j):X,o),et(h,g,c),X!==g&&et(h,X,n)),n=c=void 0,e=h)):(g=Math.round(u.toPixels(l,!0)),Q(h,g,X,o),et(h,g,o))),r=y&&!_,o%CHUNK_SIZE==0&&(p.boostCopy||p.chart.boostCopy)&&(p.boostCopy||p.chart.boostCopy)()),!E},function(){var t=d.loadingDiv,e=d.loadingShown;F(),p.canvasToSVG(),y&&console.timeEnd("canvas rendering"),fireEvent(p,"renderedCanvas"),e&&(extend(t.style,{transition:"opacity 250ms",opacity:0}),d.loadingShown=!1,destroyLoadingDiv=setTimeout(function(){t.parentNode&&t.parentNode.removeChild(t),d.loadingDiv=d.loadingSpan=null},250)),delete p.buildKDTree,p.buildKDTree()},d.renderer.forExport?Number.MAX_VALUE:void 0))}}),seriesTypes.scatter.prototype.cvsMarkerCircle=function(t,e,o,i){t.moveTo(e,o),t.arc(e,o,i,0,2*Math.PI,!1)},seriesTypes.scatter.prototype.cvsMarkerSquare=function(t,e,o,i){t.rect(e-i,o-i,2*i,2*i)},seriesTypes.scatter.prototype.fill=!0,seriesTypes.bubble&&(seriesTypes.bubble.prototype.cvsMarkerCircle=function(t,e,o,i,r){t.moveTo(e,o),t.arc(e,o,this.radii&&this.radii[r],0,2*Math.PI,!1)},seriesTypes.bubble.prototype.cvsStrokeBatch=1),extend(seriesTypes.area.prototype,{cvsDrawPoint:function(t,e,o,i,r){r&&e!==r.clientX&&(t.moveTo(r.clientX,r.yBottom),t.lineTo(r.clientX,r.plotY),t.lineTo(e,o),t.lineTo(e,i))},fill:!0,fillOpacity:!0,sampling:!0}),extend(seriesTypes.column.prototype,{cvsDrawPoint:function(t,e,o,i){t.rect(e-1,o,1,i-o)},fill:!0,sampling:!0}),H.Chart.prototype.callbacks.push(function(t){addEvent(t,"predraw",function(){t.renderTarget&&t.renderTarget.attr({href:""}),t.canvas&&t.canvas.getContext("2d").clearRect(0,0,t.canvas.width,t.canvas.height)}),addEvent(t,"render",function(){t.boostCopy&&t.boostCopy()})})};