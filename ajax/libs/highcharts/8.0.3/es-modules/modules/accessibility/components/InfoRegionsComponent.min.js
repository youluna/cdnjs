"use strict";import H from"../../../parts/Globals.js";var doc=H.win.document;import U from"../../../parts/Utilities.js";var extend=U.extend,format=U.format,pick=U.pick;import AccessibilityComponent from"../AccessibilityComponent.js";import Announcer from"../utils/Announcer.js";import AnnotationsA11y from"./AnnotationsA11y.js";var getAnnotationsInfoHTML=AnnotationsA11y.getAnnotationsInfoHTML;import ChartUtilities from"../utils/chartUtilities.js";var unhideChartElementFromAT=ChartUtilities.unhideChartElementFromAT,getChartTitle=ChartUtilities.getChartTitle,getAxisDescription=ChartUtilities.getAxisDescription;import HTMLUtilities from"../utils/htmlUtilities.js";var addClass=HTMLUtilities.addClass,setElAttrs=HTMLUtilities.setElAttrs,escapeStringForHTML=HTMLUtilities.escapeStringForHTML,stripHTMLTagsFromString=HTMLUtilities.stripHTMLTagsFromString,getElement=HTMLUtilities.getElement,visuallyHideElement=HTMLUtilities.visuallyHideElement;function getTypeDescForMapChart(t,e){return e.mapTitle?t.langFormat("accessibility.chartTypes.mapTypeDescription",e):t.langFormat("accessibility.chartTypes.unknownMap",e)}function getTypeDescForCombinationChart(t,e){return t.langFormat("accessibility.chartTypes.combinationChart",e)}function getTypeDescForEmptyChart(t,e){return t.langFormat("accessibility.chartTypes.emptyChart",e)}function buildTypeDescriptionFromSeries(t,e,i){var n=e[0],r=t.langFormat("accessibility.seriesTypeDescriptions."+n,i),a=t.series&&t.series.length<2?"Single":"Multiple";return(t.langFormat("accessibility.chartTypes."+n+a,i)||t.langFormat("accessibility.chartTypes.default"+a,i))+(r?" "+r:"")}function getTableSummary(t){return t.langFormat("accessibility.table.tableSummary",{chart:t})}function stripEmptyHTMLTags(t){return t.replace(/<(\w+)[^>]*?>\s*<\/\1>/g,"")}function enableSimpleHTML(t){return t.replace(/&lt;(h[1-7]|p|div|ul|ol|li)&gt;/g,"<$1>").replace(/&lt;&#x2F;(h[1-7]|p|div|ul|ol|li|a|button)&gt;/g,"</$1>").replace(/&lt;(div|a|button) id=&quot;([a-zA-Z\-0-9#]*?)&quot;&gt;/g,'<$1 id="$2">')}function stringToSimpleHTML(t){return stripEmptyHTMLTags(enableSimpleHTML(escapeStringForHTML(t)))}H.Chart.prototype.getTypeDescription=function(t){var e=t[0],i=this.series&&this.series[0]||{},n={numSeries:this.series.length,numPoints:i.points&&i.points.length,chart:this,mapTitle:i.mapTitle};return e?"map"===e?getTypeDescForMapChart(this,n):this.types.length>1?getTypeDescForCombinationChart(this,n):buildTypeDescriptionFromSeries(this,t,n):getTypeDescForEmptyChart(this,n)};var InfoRegionsComponent=function(){};InfoRegionsComponent.prototype=new AccessibilityComponent,extend(InfoRegionsComponent.prototype,{init:function(){var t=this.chart,e=this;this.initRegionsDefinitions(),this.addEvent(t,"afterGetTable",function(t){e.onDataTableCreated(t)}),this.addEvent(t,"afterViewData",function(t){e.dataTableDiv=t,setTimeout(function(){e.focusDataTable()},300)}),this.announcer=new Announcer(t,"assertive")},initRegionsDefinitions:function(){var t=this;this.screenReaderSections={before:{element:null,buildContent:function(e){var i=e.options.accessibility.screenReaderSection.beforeChartFormatter;return i?i(e):t.defaultBeforeChartFormatter(e)},insertIntoDOM:function(t,e){e.renderTo.insertBefore(t,e.renderTo.firstChild)},afterInserted:function(){void 0!==t.sonifyButtonId&&t.initSonifyButton(t.sonifyButtonId),void 0!==t.dataTableButtonId&&t.initDataTableButton(t.dataTableButtonId)}},after:{element:null,buildContent:function(e){var i=e.options.accessibility.screenReaderSection.afterChartFormatter;return i?i(e):t.defaultAfterChartFormatter()},insertIntoDOM:function(t,e){e.renderTo.insertBefore(t,e.container.nextSibling)}}}},onChartRender:function(){var t=this;this.linkedDescriptionElement=this.getLinkedDescriptionElement(),this.setLinkedDescriptionAttrs(),Object.keys(this.screenReaderSections).forEach(function(e){t.updateScreenReaderSection(e)})},getLinkedDescriptionElement:function(){var t=this.chart.options.accessibility.linkedDescription;if(t){if("string"!=typeof t)return t;var e=format(t,this.chart),i=doc.querySelectorAll(e);return 1===i.length?i[0]:void 0}},setLinkedDescriptionAttrs:function(){var t=this.linkedDescriptionElement;t&&(t.setAttribute("aria-hidden","true"),addClass(t,"highcharts-linked-description"))},updateScreenReaderSection:function(t){var e=this.chart,i=this.screenReaderSections[t],n=i.buildContent(e),r=i.element=i.element||this.createElement("div"),a=r.firstChild||this.createElement("div");this.setScreenReaderSectionAttribs(r,t),a.innerHTML=n,r.appendChild(a),i.insertIntoDOM(r,e),visuallyHideElement(a),unhideChartElementFromAT(e,a),i.afterInserted&&i.afterInserted()},setScreenReaderSectionAttribs:function(t,e){var i="accessibility.screenReaderSection."+e+"RegionLabel",n=this.chart,r=n.langFormat(i,{chart:n}),a="highcharts-screen-reader-region-"+e+"-"+n.index;setElAttrs(t,{id:a,"aria-label":r}),t.style.position="relative","all"===n.options.accessibility.landmarkVerbosity&&r&&t.setAttribute("role","region")},defaultBeforeChartFormatter:function(){var t=this.chart,e=t.options.accessibility.screenReaderSection.beforeChartFormat,i=this.getAxesDescription(),n="highcharts-a11y-sonify-data-btn-"+t.index,r="hc-linkto-highcharts-data-table-"+t.index,a=getAnnotationsInfoHTML(t),s=t.langFormat("accessibility.screenReaderSection.annotations.heading",{chart:t}),o={chartTitle:getChartTitle(t),typeDescription:this.getTypeDescriptionText(),chartSubtitle:this.getSubtitleText(),chartLongdesc:this.getLongdescText(),xAxisDescription:i.xAxis,yAxisDescription:i.yAxis,playAsSoundButton:t.sonify?this.getSonifyButtonText(n):"",viewTableButton:t.getCSV?this.getDataTableButtonText(r):"",annotationsTitle:a?s:"",annotationsList:a},c=H.i18nFormat(e,o,t);return this.dataTableButtonId=r,this.sonifyButtonId=n,stringToSimpleHTML(c)},defaultAfterChartFormatter:function(){var t=this.chart,e=t.options.accessibility.screenReaderSection.afterChartFormat,i={endOfChartMarker:this.getEndOfChartMarkerText()};return stringToSimpleHTML(H.i18nFormat(e,i,t))},getLinkedDescription:function(){var t=this.linkedDescriptionElement,e=t&&t.innerHTML||"";return stripHTMLTagsFromString(e)},getLongdescText:function(){var t=this.chart.options,e=t.caption,i=e&&e.text,n=this.getLinkedDescription();return t.accessibility.description||n||i||""},getTypeDescriptionText:function(){var t=this.chart;return t.types?t.options.accessibility.typeDescription||t.getTypeDescription(t.types):""},getDataTableButtonText:function(t){var e=this.chart;return'<a id="'+t+'">'+e.langFormat("accessibility.table.viewAsDataTableButtonText",{chart:e,chartTitle:getChartTitle(e)})+"</a>"},getSonifyButtonText:function(t){var e,i=this.chart;return!1===(null===(e=i.options.sonification)||void 0===e?void 0:e.enabled)?"":'<button id="'+t+'">'+i.langFormat("accessibility.sonification.playAsSoundButtonText",{chart:i,chartTitle:getChartTitle(i)})+"</button>"},getSubtitleText:function(){var t=this.chart.options.subtitle;return stripHTMLTagsFromString(t&&t.text||"")},getEndOfChartMarkerText:function(){var t=this.chart,e=t.langFormat("accessibility.screenReaderSection.endOfChartMarker",{chart:t});return'<div id="'+("highcharts-end-of-chart-marker-"+t.index)+'">'+e+"</div>"},onDataTableCreated:function(t){var e=this.chart;e.options.accessibility.enabled&&(this.viewDataTableButton&&this.viewDataTableButton.setAttribute("aria-expanded","true"),t.html=t.html.replace("<table ",'<table tabindex="0" summary="'+getTableSummary(e)+'"'))},focusDataTable:function(){var t=this.dataTableDiv,e=t&&t.getElementsByTagName("table")[0];e&&e.focus&&e.focus()},initSonifyButton:function(t){var e=this,i=this.sonifyButton=getElement(t),n=this.chart;i&&n&&(setElAttrs(i,{tabindex:"-1"}),i.onclick=function(t){var r;((null===(r=n.options.accessibility)||void 0===r?void 0:r.screenReaderSection.onPlayAsSoundClick)||function(t){null==i||i.setAttribute("aria-hidden","true"),null==i||i.setAttribute("aria-label",""),t.preventDefault(),t.stopPropagation();var r=n.langFormat("accessibility.sonification.playAsSoundClickAnnouncement",{chart:n});e.announcer.announce(r),setTimeout(function(){null==i||i.removeAttribute("aria-hidden"),null==i||i.removeAttribute("aria-label"),n.sonify&&n.sonify()},1e3)}).call(this,t,n)})},initDataTableButton:function(t){var e=this.viewDataTableButton=getElement(t),i=this.chart,n=t.replace("hc-linkto-","");e&&(setElAttrs(e,{role:"button",tabindex:"-1","aria-expanded":!!getElement(n),href:"#"+n}),e.onclick=i.options.accessibility.screenReaderSection.onViewDataTableClick||function(){i.viewData()})},getAxesDescription:function(){var t=this.chart,e=function(e,i){var n=t[e];return n.length>1||n[0]&&pick(n[0].options.accessibility&&n[0].options.accessibility.enabled,i)},i=!!t.types&&t.types.indexOf("map")<0,n=!!t.hasCartesianSeries,r=e("xAxis",!t.angular&&n&&i),a=e("yAxis",n&&i),s={};return r&&(s.xAxis=this.getAxisDescriptionText("xAxis")),a&&(s.yAxis=this.getAxisDescriptionText("yAxis")),s},getAxisDescriptionText:function(t){var e=this,i=this.chart,n=i[t];return i.langFormat("accessibility.axis."+t+"Description"+(n.length>1?"Plural":"Singular"),{chart:i,names:n.map(function(t){return getAxisDescription(t)}),ranges:n.map(function(t){return e.getAxisRangeDescription(t)}),numAxes:n.length})},getAxisRangeDescription:function(t){var e=t.options||{};return e.accessibility&&void 0!==e.accessibility.rangeDescription?e.accessibility.rangeDescription:t.categories?this.getCategoryAxisRangeDesc(t):!t.isDatetimeAxis||0!==t.min&&0!==t.dataMin?this.getAxisFromToDescription(t):this.getAxisTimeLengthDesc(t)},getCategoryAxisRangeDesc:function(t){var e=this.chart;return t.dataMax&&t.dataMin?e.langFormat("accessibility.axis.rangeCategories",{chart:e,axis:t,numCategories:t.dataMax-t.dataMin+1}):""},getAxisTimeLengthDesc:function(t){var e=this.chart,i={},n="Seconds";i.Seconds=((t.max||0)-(t.min||0))/1e3,i.Minutes=i.Seconds/60,i.Hours=i.Minutes/60,i.Days=i.Hours/24,["Minutes","Hours","Days"].forEach(function(t){i[t]>2&&(n=t)});var r=i[n].toFixed("Seconds"!==n&&"Minutes"!==n?1:0);return e.langFormat("accessibility.axis.timeRange"+n,{chart:e,axis:t,range:r.replace(".0","")})},getAxisFromToDescription:function(t){var e=this.chart,i=e.options.accessibility.screenReaderSection.axisRangeDateFormat,n=function(n){return t.isDatetimeAxis?e.time.dateFormat(i,t[n]):t[n]};return e.langFormat("accessibility.axis.rangeFromTo",{chart:e,axis:t,rangeFrom:n("min"),rangeTo:n("max")})},destroy:function(){var t;null===(t=this.announcer)||void 0===t||t.destroy()}});export default InfoRegionsComponent;