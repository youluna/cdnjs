"use strict";import H from"../../parts/Globals.js";import Point from"../../parts/Point.js";import U from"../../parts/Utilities.js";var find=U.find,isArray=U.isArray,merge=U.merge,pick=U.pick,splat=U.splat;import utilities from"./utilities.js";function getPointTimeValue(i,n){return"function"==typeof n?n(i):pick(i[n],i.options[n])}function getTimeExtremes(i,n){return i.points.reduce(function(i,t){var e=getPointTimeValue(t,n);return i.min=Math.min(i.min,e),i.max=Math.max(i.max,e),i},{min:1/0,max:-1/0})}function getExtremesForInstrumentProps(i,n,t){return(n||[]).reduce(function(n,t){return Object.keys(t.instrumentMapping||{}).forEach(function(e){var r=t.instrumentMapping[e];"string"!=typeof r||n[r]||(n[r]=utilities.calculateDataExtremes(i,r))}),n},merge(t))}function getPointEarcons(i,n){return n.reduce(function(n,t){var e,r=t.earcon;return t.condition?(e=t.condition(i))instanceof H.sonification.Earcon?n.push(e):e&&n.push(r):t.onPoint&&i.id===t.onPoint&&n.push(r),n},[])}function makeInstrumentCopies(i){return i.map(function(i){var n=i.instrument,t=("string"==typeof n?H.sonification.instruments[n]:n).copy();return merge(i,{instrument:t})})}function buildTimelinePathFromSeries(i,n){var t=n.timeExtremes||getTimeExtremes(i,n.pointPlayTime),e=getExtremesForInstrumentProps(i.chart,n.instruments,n.dataExtremes),r=makeInstrumentCopies(n.instruments),s=i.points.reduce(function(i,s){var o=getPointEarcons(s,n.earcons||[]),a=function(i){return utilities.virtualAxisTranslate(getPointTimeValue(i,n.pointPlayTime),t,{min:0,max:n.duration})}(s);return i.concat(new H.sonification.TimelineEvent({eventObject:s,time:a,id:s.id,playOptions:{instruments:r,dataExtremes:e}}),o.map(function(i){return new H.sonification.TimelineEvent({eventObject:i,time:a})}))},[]);return new H.sonification.TimelinePath({events:s,onStart:function(){n.onStart&&n.onStart(i)},onEventStart:function(i){var t=i.options&&i.options.eventObject;if(t instanceof Point){if(!t.series.visible&&!t.series.chart.series.some(function(i){return i.visible}))return i.timelinePath.timeline.pause(),i.timelinePath.timeline.resetCursor(),!1;n.onPointStart&&n.onPointStart(i,t)}},onEventEnd:function(i){var t=i.event&&i.event.options&&i.event.options.eventObject;t instanceof Point&&n.onPointEnd&&n.onPointEnd(i.event,t)},onEnd:function(){n.onEnd&&n.onEnd(i)}})}function seriesSonify(i){var n=buildTimelinePathFromSeries(this,i),t=this.chart.sonification;t.timeline&&t.timeline.pause(),t.duration=i.duration,t.timeline=new H.sonification.Timeline({paths:[n]}),t.timeline.play()}function buildSeriesOptions(i,n,t){var e=t.seriesOptions||{};return merge({dataExtremes:n,timeExtremes:getTimeExtremes(i,t.pointPlayTime),instruments:t.instruments,onStart:t.onSeriesStart,onEnd:t.onSeriesEnd,earcons:t.earcons},isArray(e)?find(e,function(n){return n.id===pick(i.id,i.options.id)})||{}:e,{pointPlayTime:t.pointPlayTime})}function buildPathOrder(i,n,t){var e;return"sequential"===i||"simultaneous"===i?(e=n.series.reduce(function(i,n){return n.visible&&i.push({series:n,seriesOptions:t(n)}),i},[]),"simultaneous"===i&&(e=[e])):e=i.reduce(function(i,e){var r=splat(e).reduce(function(i,e){var r;if("string"==typeof e){var s=n.get(e);s.visible&&(r={series:s,seriesOptions:t(s)})}else e instanceof H.sonification.Earcon&&(r=new H.sonification.TimelinePath({events:[new H.sonification.TimelineEvent({eventObject:e})]}));return e.silentWait&&(r=new H.sonification.TimelinePath({silentWait:e.silentWait})),r&&i.push(r),i},[]);return r.length&&i.push(r),i},[]),e}function addAfterSeriesWaits(i,n){return n?i.reduce(function(t,e,r){var s=splat(e);return t.push(s),r<i.length-1&&s.some(function(i){return i.series})&&t.push(new H.sonification.TimelinePath({silentWait:n})),t},[]):i}function getWaitTime(i){return i.reduce(function(i,n){var t=splat(n);return i+(1===t.length&&t[0].options&&t[0].options.silentWait||0)},0)}function syncSimultaneousPaths(i){var n=i.reduce(function(i,n){var t=n.events;return t&&t.length&&(i.min=Math.min(t[0].time,i.min),i.max=Math.max(t[t.length-1].time,i.max)),i},{min:1/0,max:-1/0});i.forEach(function(i){var t=i.events,e=t&&t.length,r=[];e&&t[0].time<=n.min||r.push(new H.sonification.TimelineEvent({time:n.min})),e&&t[t.length-1].time>=n.max||r.push(new H.sonification.TimelineEvent({time:n.max})),r.length&&i.addTimelineEvents(r)})}function getSimulPathDurationTotal(i){return i.reduce(function(i,n){return i+splat(n).reduce(function(i,n){var t=n.series&&n.seriesOptions&&n.seriesOptions.timeExtremes;return t?Math.max(i,t.max-t.min):i},0)},0)}function getSeriesDurationMs(i,n,t){return utilities.virtualAxisTranslate(i,{min:0,max:n},{min:0,max:t})}function buildPathsFromOrder(i,n){var t=Math.max(n-getWaitTime(i),0),e=getSimulPathDurationTotal(i);return i.reduce(function(i,n){var r=splat(n).reduce(function(i,n){return n instanceof H.sonification.TimelinePath?i.push(n):n.series&&(n.seriesOptions.duration=n.seriesOptions.duration||getSeriesDurationMs(n.seriesOptions.timeExtremes.max-n.seriesOptions.timeExtremes.min,e,t),i.push(buildTimelinePathFromSeries(n.series,n.seriesOptions))),i},[]);return i.push(r),i},[])}function getChartSonifyOptions(i,n){return merge(i.options.sonification,n)}function chartSonify(i){var n=getChartSonifyOptions(this,i);if(!1!==n.enabled){this.sonification.timeline&&this.sonification.timeline.pause(),this.sonification.duration=n.duration;var t=getExtremesForInstrumentProps(this,n.instruments,n.dataExtremes),e=buildPathOrder(n.order,this,function(i){return buildSeriesOptions(i,t,n)}),r=buildPathsFromOrder(e=addAfterSeriesWaits(e,n.afterSeriesWait||0),n.duration);r.forEach(function(i){syncSimultaneousPaths(i)}),this.sonification.timeline=new H.sonification.Timeline({paths:r,onEnd:n.onEnd}),this.sonification.timeline.play()}}function getCurrentPoints(){var i;return this.sonification.timeline?(i=this.sonification.timeline.getCursor(),Object.keys(i).map(function(n){return i[n].eventObject}).filter(function(i){return i instanceof Point})):[]}function setCursor(i){var n=this.sonification.timeline;n&&splat(i).forEach(function(i){n.setCursor(i.id)})}function pause(i){this.sonification.timeline?this.sonification.timeline.pause(pick(i,!0)):this.sonification.currentlyPlayingPoint&&this.sonification.currentlyPlayingPoint.cancelSonify(i)}function resume(i){this.sonification.timeline&&this.sonification.timeline.play(i)}function rewind(i){this.sonification.timeline&&this.sonification.timeline.rewind(i)}function cancel(i){this.pauseSonify(i),this.resetSonifyCursor()}function resetCursor(){this.sonification.timeline&&this.sonification.timeline.resetCursor()}function resetCursorEnd(){this.sonification.timeline&&this.sonification.timeline.resetCursorEnd()}var chartSonifyFunctions={chartSonify:chartSonify,seriesSonify:seriesSonify,pause:pause,resume:resume,rewind:rewind,cancel:cancel,getCurrentPoints:getCurrentPoints,setCursor:setCursor,resetCursor:resetCursor,resetCursorEnd:resetCursorEnd};export default chartSonifyFunctions;