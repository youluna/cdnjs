!function(e){"object"==typeof exports&&"object"==typeof module?exports.init=e:"function"==typeof define&&define.amd?define({init:e}):tern.def={init:e}}(function(e,w){"use strict";function f(e,t){return Object.prototype.hasOwnProperty.call(e,t)}var h=e.TypeParser=function(e,t,r,n){this.pos=t||0,this.spec=e,this.base=r,this.forceNew=n};function A(e,t,r){return e.call?e(t,r):e}function a(e,t){if("!ret"!=t)return e.getProp(t);if(e.retval)return e.retval;var r=new w.AVal;return e.propagate(new w.IsCallee(w.ANull,[],null,r)),r}function i(e){if(e instanceof w.Fn&&e.args)for(var t=0;t<e.args.length;++t){var r=e.args[t];r instanceof w.Fn&&r.args&&r.args.length&&n(e,t)}}function n(r,n){g(r,function(e,t){t[n]&&t[n].propagate(new w.IsCallee(w.cx().topScope,r.args[n].args,null,w.ANull))})}function c(e,t,r,n){var a=new h(e,null,r,n).parseType(!1,t,!0);return a instanceof w.AVal?a.types.forEach(i):i(a),a}function g(e,i,o){var s=e.computeRet,p=e.retval;e.computeRet=function(e,t,r){var n=i(e,t,r),a=s?s(e,t,r):p;return o?n:a}}h.prototype={eat:function(e){if(1==e.length?this.spec.charAt(this.pos)==e:this.spec.indexOf(e,this.pos)==this.pos)return this.pos+=e.length,!0},word:function(e){var t,r="";for(e=e||/[\w$]/;(t=this.spec.charAt(this.pos))&&e.test(t);)r+=t,++this.pos;return r},error:function(){throw new Error("Unrecognized type spec: "+this.spec+" (at "+this.pos+")")},parseFnType:function(e,t,r,n){var a,i,o,s,p=[],l=[],u=!1;if(!this.eat(")"))for(;;0){var f,c=this.spec.indexOf(": ",this.pos);-1!=c&&(f=this.spec.slice(this.pos,c),/^(\.\.\.)?[$\w?]+$/.test(f)?this.pos=c+2:f=null),l.push(f);var h=this.parseType(e);if(h.call&&(u=!0),p.push(h),!this.eat(", ")){this.eat(")")||this.error();break}}if(this.eat(" -> ")){var g=this.pos;(a=this.parseType(!0)).call&&!u&&(i=a,a=w.ANull,o=g)}else a=w.ANull;return u?function(a,i,o,s){return function(e,t){for(var r=[],n=0;n<i.length;n++)r.push(A(i[n],e,t));return new w.Fn(a,w.ANull,r,A(o,e,t),s)}}(t,p,a,n):(r&&(s=this.base)?w.Fn.call(this.base,t,w.ANull,p,l,a,n):s=new w.Fn(t,w.ANull,p,l,a,n),i&&(s.computeRet=i),null!=o&&(s.computeRetSource=this.spec.slice(o,this.pos)),s)},parseType:function(e,t,r){var n=this.parseTypeMaybeProp(e,t,r);if(!this.eat("|"))return n;for(var a=[n],i=n.call;;){var o=this.parseTypeMaybeProp(e,t,r);if(a.push(o),o.call&&(i=!0),!this.eat("|"))break}if(i)return function(a){return function(e,t){for(var r=new w.AVal,n=0;n<a.length;n++)A(a[n],e,t).propagate(r);return r.maxWeight=1e5,r}}(a);for(var s=new w.AVal,p=0;p<a.length;p++)a[p].propagate(s);return s.maxWeight=1e5,s},parseTypeMaybeProp:function(e,t,r){for(var n=this.parseTypeInner(e,t,r);e&&this.eat(".");)n=this.extendWithProp(n);return n},extendWithProp:function(r){var n=this.word(/[\w<>$!:]/)||this.error();return r.apply?function(e,t){return a(r(e,t),n)}:a(r,n)},parseTypeInner:function(e,t,r){var n;if(this.eat("fn(")||(n=this.eat("fn*(")))return this.parseFnType(e,t,r,n);if(this.eat("[")){for(var a=this.parseType(e),i=a.call;this.eat(", ");){s=s||[a];var o=this.parseType(e);s.push(o),i=i||o.call}return this.eat("]")||this.error(),i?s?function(e){return function(t,r){return new w.Arr(e.map(function(e){return A(e,t,r)}))}}(s):function(r){return function(e,t){return new w.Arr(r(e,t))}}(a):r&&this.base?(w.Arr.call(this.base,s||a),this.base):new w.Arr(s||a)}if(this.eat("{")){var s=[],p=[];i=!1;if(!this.eat("}"))for(;;0){var l,u=this.spec.indexOf(": ",this.pos);-1!=u&&(l=this.spec.slice(this.pos,u),/^[$\w?]+$/.test(l)?this.pos=u+2:l=null);var f=this.parseType(e);if(f.call&&(i=!0),p.push(l),s.push(f),!this.eat(", ")){this.eat("}")||this.error();break}}if(i)return function(e,i){return function(r,n){var a=new w.Obj;return e.forEach(function(e,t){a.defProp(e).addType(A(i[t],r,n))}),a}}(p,s);var c=new w.Obj;return p.forEach(function(e,t){c.defProp(e).addType(s[t])}),c}if(this.eat("+")){var h=this.word(/[\w$<>\.:!]/);if(!(g=w.cx().localDefs[h+".prototype"])){var g;if(!((g=b(h))instanceof w.Obj))return g;var v=m(g,["prototype"]);(v=v&&v.getObjType())&&(g=v)}return e&&this.eat("[")?this.parsePoly(g):r&&this.base?((t=(this.base.proto=g).hasCtor&&g.hasCtor.name||g.name)&&(this.base.name=t),this.base):r&&this.forceNew?new w.Obj(g):w.getInstance(g)}if(this.eat(":")){t=this.word(/[\w$\.]/);return w.getSymbol(t)}if(e&&this.eat("!")){var y=this.word(/\d/);if(y)return y=Number(y),function(e,t){return t[y]||w.ANull};if(this.eat("this"))return function(e){return e};if(this.eat("custom:")){var d=this.word(/[\w$]/);return P[d]||function(){return w.ANull}}return this.fromWord("!"+this.word(/[\w$<>\.!:]/))}return this.eat("?")?w.ANull:this.fromWord(this.word(/[\w$<>\.!:`]/))},fromWord:function(e){var t=w.cx();switch(e){case"number":return t.num;case"string":return t.str;case"bool":return t.bool;case"<top>":return t.topScope}return t.localDefs&&e in t.localDefs?t.localDefs[e]:b(e)},parsePoly:function(n){var e,a="<i>";(e=this.spec.slice(this.pos).match(/^\s*([\w$:]+)\s*=\s*/))&&(a=e[1],this.pos+=e[0].length);var i=this.parseType(!0);if(this.eat("]")||this.error(),i.call)return function(e,t){var r=new w.Obj(n);return i(e,t).propagate(r.defProp(a)),r};var t=new w.Obj(n);return i.propagate(t.defProp(a)),t}};var p,v=e.parseEffect=function(e,t){var r;if(0==e.indexOf("propagate ")){var n=(o=new h(e,10)).parseType(!0);o.eat(" ")||o.error();var a=o.parseType(!0);g(t,function(e,t){A(n,e,t).propagate(A(a,e,t))})}else if(0==e.indexOf("call ")){var s=5==e.indexOf("and return ",5),p=(o=new h(e,s?16:5)).parseType(!0),l=null,u=[];for(o.eat(" this=")&&(l=o.parseType(!0));o.eat(" ");)u.push(o.parseType(!0));g(t,function(e,t){for(var r=A(p,e,t),n=l?A(l,e,t):w.ANull,a=[],i=0;i<u.length;++i)a.push(A(u[i],e,t));var o=s?new w.AVal:w.ANull;return r.propagate(new w.IsCallee(n,a,null,o)),o},s)}else if(r=e.match(/^custom (\S+)\s*(.*)/)){var i=P[r[1]];i&&g(t,r[2]?i(r[2]):i)}else{if(0!=e.indexOf("copy "))throw new Error("Unknown effect type: "+e);var o,f=(o=new h(e,5)).parseType(!0);o.eat(" ");var c=o.parseType(!0);g(t,function(e,t){var r=A(f,e,t),n=A(c,e,t);r.forAllProps(function(e,t,r){r&&"<i>"!=e&&n.propagate(new w.DefProp(e,t))})})}},b=e.parsePath=function(e,t){var r=w.cx(),n=r.paths[e],a=e;if(null!=n)return n;r.paths[e]=w.ANull;var i=t||p||r.topScope;if(r.localDefs)for(var o in r.localDefs)if(0==e.indexOf(o)){if(e==o)return r.paths[e]=r.localDefs[e];if("."==e.charAt(o.length)){i=r.localDefs[o],e=e.slice(o.length+1);break}}var s=m(i,e.split("."));return r.paths[a]=s==w.ANull?null:s,s};function m(e,t){for(var r=0;r<t.length&&e!=w.ANull;++r){var n=t[r];if("!"==n.charAt(0))if("!proto"==n)e=e instanceof w.Obj&&e.proto||w.ANull;else{var a=e.getFunctionType();if(a)if("!ret"==n)e=a.retval&&a.retval.getType(!1)||w.ANull;else{var i=a.args&&a.args[Number(n.slice(1))];e=i&&i.getType(!1)||w.ANull}else e=w.ANull}else if(e instanceof w.Obj&&("prototype"==n&&e instanceof w.Fn||e.hasProp(n))){var o=e.getProp(n);e=!o||o.isEmpty()?w.ANull:o.types[0]}else e=w.ANull}return e}function s(e){var t=Object.create(e.prototype);return t.props=Object.create(null),t.isShell=!0,t}function y(e){if(!e["!type"]||/^(fn\(|\[|\+)/.test(e["!type"]))return!1;for(var t in e)if("!type"!=t&&"!doc"!=t&&"!url"!=t&&"!span"!=t&&"!data"!=t)return!1;return!0}function l(e,t,r){if(!e){var n=t["!type"];if(n)if(/^fn\(/.test(n))e=s(w.Fn);else if("["==n.charAt(0))e=s(w.Arr);else{if("+"!=n.charAt(0))throw new Error("Invalid !type spec: "+n);e=s(w.Obj)}else e=t["!stdProto"]?w.cx().protos[t["!stdProto"]]:s(w.Obj);e.name=r}for(var a in t)if(f(t,a)&&33!=a.charCodeAt(0)){var i=t[a];if("string"==typeof i||y(i))continue;var o=e.defProp(a);l(o.getObjType(),i,r?r+"."+a:a).propagate(o)}return e}function d(e,t,r){if(e.isShell){delete e.isShell;var n=t["!type"];if(n)c(n,r,e);else{var a=t["!proto"]&&c(t["!proto"]);w.Obj.call(e,!(a instanceof w.Obj)||a,r)}}var i=t["!effects"];if(i&&e instanceof w.Fn)for(var o=0;o<i.length;++o)v(i[o],e);for(var s in!function(e,t){e["!doc"]&&(t.doc=e["!doc"]);e["!url"]&&(t.url=e["!url"]);e["!span"]&&(t.span=e["!span"]);e["!data"]&&(t.metaData=e["!data"])}(t,e),t)if(f(t,s)&&33!=s.charCodeAt(0)){var p=t[s],l=e.defProp(s),u=r?r+"."+s:s;if("string"==typeof p)l.isEmpty()&&c(p,u).propagate(l);else{if(y(p)){if(!l.isEmpty())continue;c(p["!type"],u,null,!0).propagate(l)}else d(l.getObjType(),p,u);p["!doc"]&&(l.doc=p["!doc"]),p["!url"]&&(l.url=p["!url"]),p["!span"]&&(l.span=p["!span"])}}return e}e.load=function(e,t){t=t||w.cx().topScope;var r=p;p=t;try{!function(e,t){var r=w.cx(),n=r.parent;w.addOrigin(r.curOrigin=e["!name"]||"env#"+r.origins.length),r.localDefs=r.definitions[r.curOrigin]=Object.create(null),n&&n.signal("preLoadDef",e),l(t,e);var a=e["!define"];if(a){for(var i in a){var o=a[i];r.localDefs[i]="string"==typeof o?b(o):l(null,o,i)}for(var i in a){"string"!=typeof(o=a[i])&&d(r.localDefs[i],a[i],i)}}d(t,e),n&&n.signal("postLoadDef",e),r.curOrigin=r.localDefs=null}(e,t)}finally{p=r}},e.parse=function(e,t,r){var n=w.cx();t&&(n.origin=t,n.localDefs=n.definitions[t]);try{return"string"==typeof e?c(e,r):d(l(null,e,r),e,r)}finally{t&&(n.origin=n.localDefs=null)}};var P=Object.create(null);w.registerFunction=function(e,t){P[e]=t};var o=w.constraint({construct:function(e,t,r){this.created=e,this.target=t,this.spec=r},addType:function(e){if(e instanceof w.Obj&&this.created++<5){var t=new w.Obj(e),r=this.spec;if(r instanceof w.AVal&&(r=r.getObjType(!1)),r instanceof w.Obj)for(var n in r.props){var a=r.props[n].types[0],i=t.defProp(n);if(a&&a instanceof w.Obj&&a.props.value){var o=a.props.value.getType(!1);o&&i.addType(o)}}this.target.addType(t)}}});w.registerFunction("Object_create",function(e,t,r){if(r&&r.length&&"Literal"==r[0].type&&null==r[0].value)return new w.Obj;var n=new w.AVal;return t[0]&&t[0].propagate(new o(0,n,t[1])),n});var u=w.constraint({construct:function(e){this.target=e},addType:function(e){e instanceof w.Obj&&(e.hasProp("value")?e.getProp("value").propagate(this.target):e.hasProp("get")&&e.getProp("get").propagate(new w.IsCallee(w.ANull,[],null,this.target)))}});w.registerFunction("Object_defineProperty",function(e,t,r){if(r&&3<=r.length&&"Literal"==r[1].type&&"string"==typeof r[1].value){var n=t[0],a=new w.AVal;n.propagate(new w.DefProp(r[1].value,a,r[1])),t[2].propagate(new u(a))}return w.ANull}),w.registerFunction("Object_defineProperties",function(e,t,a){if(2<=t.length){var i=t[0];t[1].forAllProps(function(e,t,r){if(r){var n=new w.AVal;i.propagate(new w.DefProp(e,n,a&&a[1])),t.propagate(new u(n))}})}return w.ANull});var O=w.constraint({construct:function(e,t,r){this.self=e,this.args=t,this.target=r},addType:function(e){if(e instanceof w.Fn){this.target.addType(new w.Fn(e.name,w.ANull,e.args.slice(this.args.length),e.argNames.slice(this.args.length),e.retval,e.generator)),this.self.propagate(e.self);for(var t=0;t<Math.min(e.args.length,this.args.length);++t)this.args[t].propagate(e.args[t])}}});function T(){var e=w.cx().definitions.ecmascript;return e&&new w.Obj(e["Promise.prototype"])}w.registerFunction("Function_bind",function(e,t){if(!t.length)return w.ANull;var r=new w.AVal;return e.propagate(new O(t[0],t.slice(1),r)),r}),w.registerFunction("Array_ctor",function(e,t){var r=new w.Arr;if(1!=t.length||!t[0].hasType(w.cx().num))for(var n=r.getProp("<i>"),a=0;a<t.length;++a)t[a].propagate(n);return r}),w.registerFunction("Promise_ctor",function(e,t,r){var n=T();if(!n||t.length<1)return w.ANull;var a=n.defProp(":t",r&&r[0]),i=new w.AVal;i.propagate(a);var o=new w.Fn("execute",w.ANull,[i],["value"],w.ANull),s=w.cx().definitions.ecmascript.Promise_reject;return t[0].propagate(new w.IsCallee(w.ANull,[o,s],null,w.ANull)),n}),w.registerFunction("Promise_resolve",function(e,t,r){var n=T();if(!n)return w.ANull;if(t.length){var a=n.defProp(":t",r&&r[0]),i=new w.AVal;i.propagate(a),t[0].propagate(new N(i))}return n});var N=w.constraint({construct:function(e){this.output=e},addType:function(e){e.constructor==w.Obj&&"Promise"==e.name&&e.hasProp(":t")?e.getProp(":t").propagate(this.output):e.propagate(this.output)}});return w.registerFunction("Promise_then",function(e,t,r){var n=t.length&&t[0].getFunctionType(),a=w.cx().definitions.ecmascript;if(!n||!a)return e;var i,o=new w.Obj(a["Promise.prototype"]),s=o.defProp(":t",r&&r[0]);return n.retval.isEmpty()&&(i=e.getType())instanceof w.Obj&&i.hasProp(":t")&&i.getProp(":t").propagate(s,50),n.retval.propagate(new N(s)),o}),w.registerFunction("getOwnPropertySymbols",function(e,t){if(!t.length)return w.ANull;var n=new w.AVal;return t[0].forAllProps(function(e,t,r){r&&":"==e.charAt(0)&&n.addType(w.getSymbol(e.slice(1)))}),n}),w.registerFunction("getSymbol",function(e,t,r){return r&&r.length&&"Literal"==r[0].type&&"string"==typeof r[0].value?w.getSymbol(r[0].value):w.ANull}),e});