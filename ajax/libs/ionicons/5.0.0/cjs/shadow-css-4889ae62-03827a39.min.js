"use strict";const safeSelector=e=>{const o=[];let t,s=0;return{content:t=(e=e.replace(/(\[[^\]]*\])/g,(e,t)=>{const l=`__ph-${s}__`;return o.push(t),s++,l})).replace(/(:nth-[-\w]+)(\([^)]+\))/g,(e,t,l)=>{const c=`__ph-${s}__`;return o.push(l),s++,t+c}),placeholders:o}},restoreSafeSelector=(e,o)=>o.replace(/__ph-(\d+)__/g,(o,t)=>e[+t]),_polyfillHost="-shadowcsshost",_polyfillSlotted="-shadowcssslotted",_polyfillHostContext="-shadowcsscontext",_parenSuffix=")(?:\\(((?:\\([^)(]*\\)|[^)(]*)+?)\\))?([^,{]*)",_cssColonHostRe=new RegExp("(-shadowcsshost"+_parenSuffix,"gim"),_cssColonHostContextRe=new RegExp("(-shadowcsscontext"+_parenSuffix,"gim"),_cssColonSlottedRe=new RegExp("(-shadowcssslotted"+_parenSuffix,"gim"),_polyfillHostNoCombinator="-shadowcsshost-no-combinator",_polyfillHostNoCombinatorRe=/-shadowcsshost-no-combinator([^\s]*)/,_shadowDOMSelectorsRe=[/::shadow/g,/::content/g],_selectorReSuffix="([>\\s~+[.,{:][\\s\\S]*)?$",_polyfillHostRe=/-shadowcsshost/gim,_colonHostRe=/:host/gim,_colonSlottedRe=/::slotted/gim,_colonHostContextRe=/:host-context/gim,_commentRe=/\/\*\s*[\s\S]*?\*\//g,stripComments=e=>e.replace(_commentRe,""),_commentWithHashRe=/\/\*\s*#\s*source(Mapping)?URL=[\s\S]+?\*\//g,extractCommentsWithHash=e=>e.match(_commentWithHashRe)||[],_ruleRe=/(\s*)([^;\{\}]+?)(\s*)((?:{%BLOCK%}?\s*;?)|(?:\s*;))/g,_curlyRe=/([{}])/g,OPEN_CURLY="{",CLOSE_CURLY="}",BLOCK_PLACEHOLDER="%BLOCK%",processRules=(e,o)=>{const t=escapeBlocks(e);let s=0;return t.escapedString.replace(_ruleRe,(...e)=>{const l=e[2];let c="",r=e[4],n="";r&&r.startsWith("{%BLOCK%")&&(c=t.blocks[s++],r=r.substring("%BLOCK%".length+1),n="{");const p=o({selector:l,content:c});return`${e[1]}${p.selector}${e[3]}${n}${p.content}${r}`})},escapeBlocks=e=>{const o=e.split(_curlyRe),t=[],s=[];let l=0,c=[];for(let e=0;e<o.length;e++){const r=o[e];"}"===r&&l--,l>0?c.push(r):(c.length>0&&(s.push(c.join("")),t.push("%BLOCK%"),c=[]),t.push(r)),"{"===r&&l++}return c.length>0&&(s.push(c.join("")),t.push("%BLOCK%")),{escapedString:t.join(""),blocks:s}},insertPolyfillHostInCssText=e=>e=e.replace(_colonHostContextRe,"-shadowcsscontext").replace(_colonHostRe,_polyfillHost).replace(_colonSlottedRe,_polyfillSlotted),convertColonRule=(e,o,t)=>e.replace(o,(...e)=>{if(e[2]){const o=e[2].split(","),s=[];for(let l=0;l<o.length;l++){const c=o[l].trim();if(!c)break;s.push(t(_polyfillHostNoCombinator,c,e[3]))}return s.join(",")}return _polyfillHostNoCombinator+e[3]}),colonHostPartReplacer=(e,o,t)=>e+o.replace(_polyfillHost,"")+t,convertColonHost=e=>convertColonRule(e,_cssColonHostRe,colonHostPartReplacer),colonHostContextPartReplacer=(e,o,t)=>o.indexOf(_polyfillHost)>-1?colonHostPartReplacer(e,o,t):e+o+t+", "+o+" "+e+t,convertColonSlotted=(e,o)=>{const t=_cssColonSlottedRe;return e.replace(t,(...e)=>{if(e[2]){const t=e[2].trim(),s=e[3];return"."+o+" > "+t+s}return _polyfillHostNoCombinator+e[3]})},convertColonHostContext=e=>convertColonRule(e,_cssColonHostContextRe,colonHostContextPartReplacer),convertShadowDOMSelectors=e=>_shadowDOMSelectorsRe.reduce((e,o)=>e.replace(o," "),e),makeScopeMatcher=e=>{return e=e.replace(/\[/g,"\\[").replace(/\]/g,"\\]"),new RegExp("^("+e+")"+_selectorReSuffix,"m")},selectorNeedsScoping=(e,o)=>{return!makeScopeMatcher(o).test(e)},applySimpleSelectorScope=(e,o,t)=>{if(_polyfillHostRe.lastIndex=0,_polyfillHostRe.test(e)){const o=`.${t}`;return e.replace(_polyfillHostNoCombinatorRe,(e,t)=>t.replace(/([^:]*)(:*)(.*)/,(e,t,s,l)=>t+o+s+l)).replace(_polyfillHostRe,o+" ")}return o+" "+e},applyStrictSelectorScope=(e,o,t)=>{const s="."+(o=o.replace(/\[is=([^\]]*)\]/g,(e,...o)=>o[0])),l=e=>{let l=e.trim();if(!l)return"";if(e.indexOf(_polyfillHostNoCombinator)>-1)l=applySimpleSelectorScope(e,o,t);else{const o=e.replace(_polyfillHostRe,"");if(o.length>0){const e=o.match(/([^:]*)(:*)(.*)/);e&&(l=e[1]+s+e[2]+e[3])}}return l},c=safeSelector(e);let r,n="",p=0;const i=/( |>|\+|~(?!=))\s*/g;let a=!((e=c.content).indexOf(_polyfillHostNoCombinator)>-1);for(;null!==(r=i.exec(e));){const o=r[1],t=e.slice(p,r.index).trim();n+=`${(a=a||t.indexOf(_polyfillHostNoCombinator)>-1)?l(t):t} ${o} `,p=i.lastIndex}const h=e.substring(p);return n+=(a=a||h.indexOf(_polyfillHostNoCombinator)>-1)?l(h):h,restoreSafeSelector(c.placeholders,n)},scopeSelector=(e,o,t,s)=>e.split(",").map(e=>s&&e.indexOf("."+s)>-1?e.trim():selectorNeedsScoping(e,o)?applyStrictSelectorScope(e,o,t).trim():e.trim()).join(", "),scopeSelectors=(e,o,t,s,l)=>processRules(e,e=>{let l=e.selector,c=e.content;return"@"!==e.selector[0]?l=scopeSelector(e.selector,o,t,s):(e.selector.startsWith("@media")||e.selector.startsWith("@supports")||e.selector.startsWith("@page")||e.selector.startsWith("@document"))&&(c=scopeSelectors(e.content,o,t,s)),{selector:l.replace(/\s{2,}/g," ").trim(),content:c}}),scopeCssText=(e,o,t,s,l)=>(e=insertPolyfillHostInCssText(e),e=convertColonHost(e),e=convertColonHostContext(e),e=convertColonSlotted(e,s),e=convertShadowDOMSelectors(e),o&&(e=scopeSelectors(e,o,t,s)),(e=(e=e.replace(/-shadowcsshost-no-combinator/g,`.${t}`)).replace(/>\s*\*\s+([^{, ]+)/gm," $1 ")).trim()),scopeCss=(e,o,t)=>{const s=o+"-h",l=o+"-s",c=extractCommentsWithHash(e);e=stripComments(e);const r=[];if(t){const o=e=>{const o=`/*!@___${r.length}___*/`,t=`/*!@${e.selector}*/`;return r.push({placeholder:o,comment:t}),e.selector=o+e.selector,e};e=processRules(e,e=>"@"!==e.selector[0]?o(e):e.selector.startsWith("@media")||e.selector.startsWith("@supports")||e.selector.startsWith("@page")||e.selector.startsWith("@document")?(e.content=processRules(e.content,o),e):e)}const n=scopeCssText(e,o,s,l);return e=[n,...c].join("\n"),t&&r.forEach(({placeholder:o,comment:t})=>{e=e.replace(o,t)}),e};exports.scopeCss=scopeCss;